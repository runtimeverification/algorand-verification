
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Algorand.safety</title>
<meta name="description" content="Documentation of Coq module Algorand.safety" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Algorand.safety</h1>
<div class="coq">
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.all_ssreflect.html">all_ssreflect</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html">finmap</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html">multiset</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.zify.zify.html">zify</a></span>.<br/>
<span class="kwd">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Reals.html">Reals</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Relations.Relation_Definitions.html">Relation_Definitions</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Relations.Relation_Operators.html">Relation_Operators</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html">boolp</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.Rstruct.html">Rstruct</a></span>.<br/>
<span class="kwd">From</span> <span class="id">Algorand</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="Algorand.fmap_ext.html">fmap_ext</a></span> <span class="id"><a href="Algorand.algorand_model.html">algorand_model</a></span> <span class="id"><a href="Algorand.safety_helpers.html">safety_helpers</a></span> <span class="id"><a href="Algorand.quorums.html">quorums</a></span>.<br/>
<br/>
<span class="kwd">Set</span> <span class="kwd">Implicit</span> <span class="kwd">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="kwd">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="kwd">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">mset_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">fmap_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">fset_scope</span>.<br/>
<br/>
<h1> Safety proof </h1>
<br/>
<div class="doc">This module proves the asynchronous safety property of the protocol. </div>
<br/>
<h2> Rounds do not contain forks </h2>
<br/>
<div class="doc">To show there is not a fork in a particular round, we will take a history
that extends before any honest node has made a transition in that round. </div>
<span class="kwd">Definition</span> <span class="id"><a name="user_before_round">user_before_round</a></span> <span class="id">r</span> (<span class="id">u</span> : <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) &lt; <span class="id">r</span> \/<br/>
&nbsp;&nbsp;&nbsp;(<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">r</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#step">step</a></span>) = 1 /\ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = 1 /\ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#timer">timer</a></span>) = 0%<span class="id">R</span> /\ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#deadline">deadline</a></span>) = 0%<span class="id">R</span>))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>' <span class="id">p</span>, <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#proposals">proposals</a></span>) (<span class="id">r</span>', <span class="id">p</span>)))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>', <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>'))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>' <span class="id">p</span>, <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>', <span class="id">p</span>)))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>' <span class="id">p</span>, <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#certvotes">certvotes</a></span>) (<span class="id">r</span>', <span class="id">p</span>)))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>' <span class="id">p</span> <span class="id">s</span>, <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r</span>', <span class="id">p</span>, <span class="id">s</span>)))<br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">r</span>' <span class="id">p</span> <span class="id">s</span>, <span class="id">r</span> &lt;= <span class="id">r</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilp">nilp</a></span> (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_val">nextvotes_val</a></span>) (<span class="id">r</span>', <span class="id">p</span>, <span class="id">s</span>))).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="users_before_round">users_before_round</a></span> (<span class="id">r</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">g</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">i</span> (<span class="id">Hi</span> : <span class="id">i</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)), <span class="id"><a href="Algorand.safety.html#user_before_round">user_before_round</a></span> <span class="id">r</span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">Hi</span>]).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="messages_before_round">messages_before_round</a></span> (<span class="id">r</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">g</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">mailbox</span>: {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>}), <span class="id">mailbox</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#codomf">codomf</a></span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">deadline</span> <span class="id">msg</span>, (<span class="id">deadline</span>,<span class="id">msg</span>) \<span class="kwd">in</span> <span class="id">mailbox</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> &lt; <span class="id">r</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="state_before_round">state_before_round</a></span> <span class="id">r</span> (<span class="id">g</span>:<span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#users_before_round">users_before_round</a></span> <span class="id">r</span> <span class="id">g</span><br/>
&nbsp;&nbsp;/\ <span class="id"><a href="Algorand.safety.html#messages_before_round">messages_before_round</a></span> <span class="id">r</span> <span class="id">g</span><br/>
&nbsp;&nbsp;/\ (<span class="kwd">forall</span> <span class="id">msg</span>, <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_history">msg_history</a></span>) -&gt; <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> &lt; <span class="id">r</span>).<br/>
<br/>
<h2> Lemmas connecting pending, sent, and received messages </h2>
<br/>
<div class="doc">The two main lemmas proved in this section are <span class="bracket"><span class="id">pending_sent_or_forged</span></span> and
<span class="bracket"><span class="id">received_was_sent</span></span>. The former connects a message in transit to a previously
sent (or forged) message. The latter, which relies on the proof of
<span class="bracket"><span class="id">pending_sent_or_forged</span></span>, states that if a message was received, and the sender
field of that message was a user who is honest, then that user must have sent
that message at some point earlier in the trace. </div>
<br/>
<div class="doc">Message in history was sent - used in <span class="bracket"><span class="id">pending_sent_or_forged</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="replay_had_original">replay_had_original</a></span><br/>
&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g</span> <span class="id">ix</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">msg</span>:<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>), <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_history">msg_history</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">send_ix</span>, <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">send_ix</span> <span class="id">trace</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span>) <span class="id">msg</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g</span> <span class="id">ix</span> <span class="id">H_g</span> <span class="id">msg</span> <span class="id">H_msg</span> <span class="id">H_r</span>.<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="id">H_path</span> <span class="id">H_g</span> (<span class="id">P</span>:=<span class="kwd">fun</span> <span class="id">g</span> =&gt; <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_history">msg_history</a></span>))).<br/>
&nbsp;&nbsp;<span class="id">cbv</span> <span class="id">beta</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_msg0</span>: <span class="id">msg</span> \<span class="id">notin</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_history">msg_history</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">clear</span> -<span class="id">H_start</span> <span class="id">H_r</span>;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_msg</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_start</span> =&gt; [] <span class="id">_</span> [] <span class="id">_</span> {<span class="id">H_msg</span>}/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_msg</span>);<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span> <span class="id">H_r</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:(<span class="id">H</span> <span class="id">H_msg0</span> <span class="id">H_msg</span>). <span class="id">clear</span> -<span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> [<span class="id">H_pre</span> <span class="id">H_post</span>]]]]].<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>, <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="id">H_path</span>), <span class="id"><a href="Algorand.safety_helpers.html#transitions_labeled">transitions_labeled</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_step</span> =&gt; [<span class="id">lbl</span> <span class="id">H_rel</span>];<span class="id">clear</span> -<span class="id">H_pre</span> <span class="id">H_post</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">lbl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">exfalso</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>;<span class="id">subst</span> <span class="id">g2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>;<span class="id">assumption</span>).<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">s</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span> /\ <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [&lt;- <span class="id">H_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">l</span>;<span class="id">split</span>;[|<span class="id">left</span>;<span class="kwd">exists</span> <span class="id">r</span>, <span class="id">m</span>];<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_post</span> <span class="id">H_pre</span>;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#in_msetD">in_msetD</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>=&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span> []; [<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">Hp</span> <span class="id">Hn</span>;<span class="id">exfalso</span>;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hp</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#in_seq_mset">in_seq_mset</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_l</span>. <span class="id">split</span>;[|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_msg_sender_good">utransition_msg_sender_good</a></span> <span class="id">H_ustep</span> <span class="id">H_l</span>).<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">s</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span> /\ <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [&lt;- <span class="id">H_l</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">l</span>;<span class="id">split</span>;[|<span class="id">right</span>];<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_post</span> <span class="id">H_pre</span>;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#in_msetD">in_msetD</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>=&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span> [];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">Hp</span> <span class="id">Hn</span>;<span class="id">exfalso</span>;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hp</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#in_seq_mset">in_seq_mset</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_l</span>. <span class="id">split</span>;[|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_internal_sender_good">utransition_internal_sender_good</a></span> <span class="id">H_ustep</span> <span class="id">H_l</span>).<br/>
&nbsp;&nbsp;* <span class="id">exfalso</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">ustate_key</span> [<span class="id">msg</span>' [<span class="id">H_corrupt</span> [<span class="id">H_msg</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">simpl</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A pending message was sent or forged earlier in trace. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="pending_sent_or_forged">pending_sent_or_forged</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g_pending</span> <span class="id">pending_ix</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">pending_ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g_pending</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> (<span class="id">key_msg</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g_pending</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)) <span class="id">d</span> <span class="id">pending_msg</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">d</span>,<span class="id">pending_msg</span>) \<span class="kwd">in</span> <span class="id">g_pending</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_msg</span>] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">sender</span> := <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">pending_msg</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">pending_msg</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">send_ix</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">send_ix</span> <span class="id">trace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">sender</span> <span class="id">pending_msg</span> <span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="id">pending_msg</span> <span class="id">g1</span> <span class="id">g2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">g_pending</span> <span class="id">pending_ix</span> <span class="id">H_g</span> <span class="id">uid</span> <span class="id">key_msg</span> <span class="id">d</span> <span class="id">msg</span> <span class="id">H_msg</span> <span class="id">sender</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">sender</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">P</span> := <span class="kwd">fun</span> <span class="id">g</span> =&gt; <span class="kwd">match</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">msg_mset</span> =&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="kwd">fun</span> (<span class="id">p</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>*<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>) =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>) <span class="id">msg_mset</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_P</span>: <span class="id">P</span> <span class="id">g_pending</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id">P</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span>;<span class="kwd">exists</span> (<span class="id">d</span>,<span class="id">msg</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_P0</span>: ~~<span class="id">P</span> <span class="id">g0</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">P</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_start</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hmb</span>: (<span class="id">_</span>.[?<span class="id">uid</span>]) =&gt; [<span class="id">mb</span>|//].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_start</span> =&gt; [<span class="id">_</span> [<span class="id">H_msgs</span> <span class="id">_</span>]].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqNgt">leqNgt</a></span> <span class="kwd">in</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNN">contraNN</a></span>: <span class="id">H_round</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> =&gt;[[<span class="id">d</span> <span class="id">msg</span>'] <span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> /= ?];<span class="id">subst</span> <span class="id">msg</span>'.<br/>
&nbsp;&nbsp;<span class="id">apply</span>: <span class="id">H_msgs</span> <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#codomfP">codomfP</a></span>;<span class="kwd">exists</span> <span class="id">uid</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;msg&nbsp;has&nbsp;round&nbsp;&gt;=&nbsp;r,&nbsp;while&nbsp;g0&nbsp;comes&nbsp;before&nbsp;r,&nbsp;and&nbsp;so&nbsp;msg&nbsp;\notin&nbsp;mmailbox0&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;if&nbsp;the&nbsp;user&nbsp;does&nbsp;not&nbsp;have&nbsp;a&nbsp;mailbox,&nbsp;then&nbsp;it's&nbsp;already&nbsp;true*)</span><br/>
&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">H_P0</span> <span class="id">H_P</span>}(<span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="id">H_path</span> <span class="id">H_g</span> <span class="id">H_P0</span> <span class="id">H_P</span>).<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">P</span>;<span class="id">cbv</span> <span class="id">beta</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> [<span class="id">H_pre</span> <span class="id">H_post</span>]]]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_step</span>) =&gt; /(<span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="id">H_path</span>) /<span class="id"><a href="Algorand.safety_helpers.html#transitions_labeled">transitions_labeled</a></span> [<span class="id">lbl</span> <span class="id">H_rel</span>].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">lbl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>;<span class="id">subst</span> <span class="id">g2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<span class="id">g1</span>,<span class="id">g2</span>;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">s</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span> /\ <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; [&lt;- <span class="id">H_l</span>];<span class="kwd">exists</span> <span class="id">l</span>;<span class="id">split</span>;[|<span class="id">left</span>;<span class="kwd">exists</span> <span class="id">r0</span>, <span class="id">m</span>];<span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span> <span class="kwd">by</span> <span class="id">split</span>;[<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_msg_sender_good">utransition_msg_sender_good</a></span> <span class="id">H_ustep</span>)|];<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_post</span> <span class="id">H_pre</span>;<span class="id">subst</span> <span class="id">g2</span>;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#broadcasts_prop">broadcasts_prop</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>;<span class="id">case</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span> =&gt; [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> -&gt;|<span class="id">_</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>;<span class="id">exact</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubD1set">msubD1set</a></span>|<span class="id">exact</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_refl">msubset_refl</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<span class="id">g1</span>,<span class="id">g2</span>;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">s</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span> /\ <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; [&lt;- <span class="id">H_l</span>];<span class="kwd">exists</span> <span class="id">l</span>;<span class="id">split</span>;[|<span class="id">right</span>];<span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span> <span class="kwd">by</span> <span class="id">split</span>;[<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_internal_sender_good">utransition_internal_sender_good</a></span> <span class="id">H_ustep</span>)|];<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_post</span> <span class="id">H_pre</span>;<span class="id">subst</span> <span class="id">g2</span>;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#broadcasts_prop">broadcasts_prop</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_refl">msubset_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;exit&nbsp;partition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>. <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>. <span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#recover_from_partitioned">recover_from_partitioned</a></span>, <span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reset_msg_delays&nbsp;preserves&nbsp;the&nbsp;set&nbsp;of&nbsp;messages,&nbsp;but&nbsp;not&nbsp;their&nbsp;deadlines&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNN">contraNN</a></span>:<span class="id">H_pre</span>;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">eq_op</span>] =&gt; <span class="id">H_post</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> =&gt; <span class="id">H_in</span>;<span class="id">move</span>:<span class="id">H_post</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> //<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> //;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id">uid</span> \<span class="id">notin</span> ?<span class="id">f</span>) <span class="kwd">with</span> (<span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rtopology.html#f">f</a></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> <span class="id"><a href="Algorand.safety_helpers.html#map_mset_has">map_mset_has</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#eq_has">eq_has</a></span> (<span class="id">a2</span>:=(<span class="kwd">fun</span> <span class="id">p</span> =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;enter&nbsp;partition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>;<span class="id">subst</span> <span class="id">g2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;corrupt&nbsp;user&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H_post</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#corrupt_user_result">corrupt_user_result</a></span>, <span class="id"><a href="Algorand.algorand_model.html#drop_mailbox_of_user">drop_mailbox_of_user</a></span>; <span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;the&nbsp;empty&nbsp;msg&nbsp;mset&nbsp;cannot&nbsp;have&nbsp;a&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">m1</span> := (<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span> <span class="id">g1</span>).[? <span class="id">s</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">m1</span>;[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>;<span class="id">case</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>;[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#enum_mset0">enum_mset0</a></span>|]|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;replay&nbsp;a&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;replayed&nbsp;message&nbsp;must&nbsp;have&nbsp;originally&nbsp;been&nbsp;sent&nbsp;honestly&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rename</span> <span class="id">s</span> <span class="id">into</span> <span class="id">target</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_rel</span> =&gt; /= [<span class="id">ustate_key</span> [<span class="id">hist_msg</span> [<span class="id">H_tgt_honest</span> [<span class="id">H_msg_history</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety.html#replay_had_original">replay_had_original</a></span> <span class="id">H_path</span> <span class="id">H_start</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>) <span class="id">H_msg_history</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span> -&gt;: <span class="id">hist_msg</span> = <span class="id">msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/(<span class="id">_</span> <span class="id">H_round</span>) =&gt; [<span class="id">send_ix</span> [<span class="id">g3</span> [<span class="id">g4</span>]]];<span class="id">clear</span> =&gt; <span class="id">H</span>. <span class="kwd">exists</span> <span class="id">send_ix</span>, <span class="id">g3</span>, <span class="id">g4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">tauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span>; <span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_seq1">mem_seq1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#broadcasts_prop">broadcasts_prop</a></span>: <span class="id">H_post</span> <span class="id">H_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_refl">msubset_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;forge&nbsp;a&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<span class="id">g1</span>,<span class="id">g2</span>;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span> -&gt;: <span class="id">msg</span> = <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id">m</span> <span class="id">e</span> <span class="id">n0</span> <span class="id">n1</span> <span class="id">s</span> <span class="kwd">by</span> <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_rel</span>;<span class="id">clear</span> <span class="id">H_rel</span>;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_seq1">mem_seq1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#broadcasts_prop">broadcasts_prop</a></span>: <span class="id">H_post</span> <span class="id">H_pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_refl">msubset_refl</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">A message from an honest user was actually sent in the trace. Used to relate
   an honest user having received a quorum of messages to some honest user
   having sent those messages - used in <span class="bracket"><span class="id">received_was_sent</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="pending_honest_sent">pending_honest_sent</a></span>: <span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g_pending</span> <span class="id">pending_ix</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">pending_ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g_pending</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> (<span class="id">key_msg</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g_pending</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)) <span class="id">d</span> <span class="id">pending_msg</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">d</span>,<span class="id">pending_msg</span>) \<span class="kwd">in</span> <span class="id">g_pending</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_msg</span>] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">sender</span> := <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">pending_msg</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">pending_msg</span>) <span class="id">sender</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">pending_msg</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">send_ix</span>, <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">send_ix</span> <span class="id">trace</span> <span class="id">sender</span> <span class="id">pending_msg</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g0</span> <span class="id">trace</span> <span class="id">H_path</span> <span class="id">r</span> <span class="id">H_start</span> <span class="id">g</span> <span class="id">ix</span> <span class="id">H_g</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> <span class="id">key_msg</span> <span class="id">d</span> <span class="id">msg</span> <span class="id">H_msg</span> <span class="id">sender</span> <span class="id">H_honest</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">send_ix</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_send</span>]]]]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id"><a href="Algorand.safety.html#pending_sent_or_forged">pending_sent_or_forged</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g</span> <span class="id">H_msg</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">send_ix</span>, <span class="id">g1</span>, <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_send</span> =&gt; [//|<span class="id">H_forged</span>];<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">msg</span> <span class="kwd">as</span> [<span class="id">mty</span> <span class="id">v</span> <span class="id">r1</span> <span class="id">p</span> <span class="id">forger</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> /= <span class="kwd">in</span> <span class="id">H_forged</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_forged</span>;<span class="id">clear</span> <span class="id">H_forged</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H</span> =&gt; [<span class="id">H_corrupt</span> <span class="id">H_le</span>].<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_honest</span>} := <span class="id"><a href="Algorand.safety_helpers.html#all_onth">all_onth</a></span> <span class="id">H_honest</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id">upred</span>' (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">x</span>) <span class="id">H_corrupt</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implybF">implybF</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>;<span class="id">apply</span>;<span class="id">apply</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">refine</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_trans">step_le_trans</a></span> <span class="id">H_le</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> /<span class="id"><a href="Algorand.algorand_model.html#step_leb">step_leb</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> /=.<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id"><a href="Algorand.algorand_model.html#mtype_matches_step">mtype_matches_step</a></span> <span class="id">mty</span> <span class="id">v</span> <span class="id">x0</span> <span class="kwd">by</span> <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">clear</span>;<span class="id">destruct</span> <span class="id">mty</span>,<span class="id">v</span>;<span class="id">simpl</span>;<span class="id">destruct</span> 1.<br/>
Qed.</div>
<br/>
<div class="doc">This lemma connects message receipt to the sending of a message, used to
reach back to an earlier honest transition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="received_was_sent">received_was_sent</a></span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">u</span> <span class="id">d</span> <span class="id">msg</span> (<span class="id">H_recv</span>: <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">u</span> <span class="id">d</span> <span class="id">msg</span> <span class="id">trace</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span>) <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">ix</span>, <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix</span> <span class="id">trace</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span>) <span class="id">msg</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_recv</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_recv</span> =&gt; [<span class="id">ix_r</span> [<span class="id">ms</span> <span class="id">H_deliver</span>]].<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_round</span> <span class="id">H_honest_sender</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_deliver</span> =&gt; [<span class="id">g1_d</span> [<span class="id">g2_d</span> [<span class="id">H_step_d</span> <span class="id">H_rel_d</span>]]].<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_step_d</span>}<span class="id">H_g1_d</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step_d</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_rel_d</span> =&gt; [<span class="id">ukey1</span> [<span class="id">upost</span> <span class="id">H_step</span>]].<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_step</span> =&gt; [<span class="id">H_ustep</span>] [<span class="id">H_honest_recv</span>] [<span class="id">key_mailbox</span>] [<span class="id">H_msg_in</span> <span class="id">H_g2_d</span>].<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">g2_d</span> <span class="id">H_g2_d</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety.html#pending_honest_sent">pending_honest_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g1_d</span> <span class="id">H_msg_in</span>) <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">H_honest_sender</span> <span class="id">H_round</span>).<br/>
&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
Qed.</div>
<br/>
<h2> Uniqueness of votes </h2>
<br/>
<div class="doc">Now we have lemmas showing that transitions preserve various invariants. </div>
<br/>
<div class="doc">A user can only certvote one value during given round/period. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="vote_value_unique">vote_value_unique</a></span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">v</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Certvote">Certvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v2</span>, <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Certvote">Certvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v2</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt; <span class="id">v2</span> = <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">H_honest</span> <span class="id">v2</span> <span class="id">H_sent2</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="kwd">in</span> <span class="id">H_sent</span>, <span class="id">H_sent2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]];<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent2</span> <span class="kwd">as</span> [<span class="id">ms2</span> [<span class="id">H_msg2</span> [[<span class="id">d2</span> [<span class="id">in2</span> <span class="id">H_step2</span>]]|<span class="id">H_step2</span>]]];<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#transition_label_unique">transition_label_unique</a></span> <span class="id">H_step</span> <span class="id">H_step2</span>) <span class="kwd">as</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;<span class="id">try</span> (<span class="id">discriminate</span> <span class="id">H</span>);[<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> -&gt; -&gt; -&gt;|<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> -&gt;];<span class="id">clear</span> <span class="id">H_step2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_msg</span> <span class="id">H_msg2</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;[<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]] |<br/>
&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]] ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H</span>:=  <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span> : <span class="id">_</span> # <span class="id">_</span> ; <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span> : <span class="id">_</span> # <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">clear</span> -<span class="id">H</span>; <span class="id">set</span> <span class="id">result</span> := (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">in</span> <span class="id">H</span>;<span class="id">change</span> <span class="id">ms</span> <span class="kwd">with</span> <span class="id">result</span>.2;<span class="id">clearbody</span> <span class="id">result</span>;<span class="id">revert</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">simpl</span>;<span class="id">clear</span>;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>;<span class="id">try</span> (<span class="id">exfalso</span>;<span class="id">exact</span> <span class="id">H_msg</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg2</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>, <span class="id">H_msg2</span>;<span class="id">intuition</span> <span class="id">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A user can only softvote for one value during a given round/period. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvote_value_unique">softvote_value_unique</a></span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">v</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v2</span>, <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v2</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">v2</span> = <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">H_honest</span> <span class="id">v2</span> <span class="id">H_sent2</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="kwd">in</span> <span class="id">H_sent</span>, <span class="id">H_sent2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]];<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent2</span> <span class="kwd">as</span> [<span class="id">ms2</span> [<span class="id">H_msg2</span> [[<span class="id">d2</span> [<span class="id">in2</span> <span class="id">H_step2</span>]]|<span class="id">H_step2</span>]]];<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#transition_label_unique">transition_label_unique</a></span> <span class="id">H_step</span> <span class="id">H_step2</span>) <span class="kwd">as</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;<span class="id">try</span> (<span class="id">discriminate</span> <span class="id">H</span>);[<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> -&gt; -&gt; -&gt;|<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> -&gt;];<span class="id">clear</span> <span class="id">H_step2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_msg</span> <span class="id">H_msg2</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;[<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]] |<br/>
&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]] ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H</span>:=  <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span> : <span class="id">_</span> # <span class="id">_</span> ; <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span> : <span class="id">_</span> # <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">clear</span> -<span class="id">H</span>;<span class="id">set</span> <span class="id">result</span> := (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">in</span> <span class="id">H</span>;<span class="id">change</span> <span class="id">ms</span> <span class="kwd">with</span> <span class="id">result</span>.2;<span class="id">clearbody</span> <span class="id">result</span>;<span class="id">revert</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">simpl</span>;<span class="id">clear</span>;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>;<span class="id">try</span> (<span class="id">exfalso</span>;<span class="id">exact</span> <span class="id">H_msg</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg2</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>, <span class="id">H_msg2</span>;<span class="id">intuition</span> <span class="id">congruence</span>.<br/>
Qed.</div>
<br/>
<h2> Pre- and post-conditions for users sending votes </h2>
<br/>
<div class="doc">User sends softvote implies that <span class="bracket"><span class="id">softvote_new_ok</span></span> or <span class="bracket"><span class="id">softvote_repr_ok</span></span> must have held. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvote_precondition">softvote_precondition</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span><br/>
&nbsp;&nbsp;(<span class="id">H_sent</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span>)<br/>
&nbsp;&nbsp;<span class="id">u</span> (<span class="id">H_u</span>: <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#softvote_new_ok">softvote_new_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;\/ <span class="id"><a href="Algorand.algorand_model.html#softvote_repr_ok">softvote_repr_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_sent</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]] |<br/>
&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]] ];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_msg</span>;<span class="id">change</span> <span class="id">ms</span> <span class="kwd">with</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>).2;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>: <span class="id">_</span> # <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">move</span>: (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="id">H</span> =&gt; <span class="id">result</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>: <span class="id">_</span> # <span class="id">_</span> ; <span class="id">_</span> ~&gt; <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">move</span>: (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="id">H</span> =&gt; <span class="id">result</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<span class="id">subst</span>;<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>;<span class="id">case</span>:<span class="id">H_u</span> =&gt; -&gt;;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;no&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> 1.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> 1;<span class="id">try</span> <span class="id">exact</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_seq1">mem_seq1</a></span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> [-&gt; -&gt; -&gt;];[<span class="id">left</span>|<span class="id">right</span>].<br/>
Qed.</div>
<br/>
<div class="doc">If a user sends certvote, <span class="bracket"><span class="id">certvote_ok</span></span> must have held. In case the certvote
came via a message delivery transition, we need additional information about how
the user state changes for the user who sent the certvote. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="certvote_precondition">certvote_precondition</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Certvote">Certvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">i</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> (<span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> (<span class="id">i</span>, <span class="id">v</span>)) <span class="id">uid</span> <span class="id">v</span> <span class="id">b</span> <span class="id">r</span> <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id"><a href="Algorand.algorand_model.html#certvote_result">certvote_result</a></span> (<span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> (<span class="id">i</span>, <span class="id">v</span>)))) \/<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">b</span>, <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">b</span> <span class="id">r</span> <span class="id">p</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g1</span>) [` <span class="id">key_ustate</span>] = <span class="id">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>; <span class="id">inversion</span> <span class="id">H_u</span>; <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H_step</span>; <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>; <span class="id">inversion</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>. <span class="kwd">exists</span> <span class="id">i</span>, <span class="id">b</span>; <span class="id">split</span>; <span class="id">subst</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g1</span>) [` <span class="id">key_user</span>] = <span class="id">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>; <span class="id">inversion</span> <span class="id">H_u</span>; <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H_step</span>. <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">inversion</span> <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">right</span>; <span class="kwd">exists</span> <span class="id">b</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">If a user sent a certvote this means that in the resulting state, 
the value is in the user's certvals, value corresponds to a block in
user's blocks, and user is in step 4. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="certvote_postcondition">certvote_postcondition</a></span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Certvote">Certvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">v</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">b</span>, <span class="id">b</span> \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span> /\ <span class="id"><a href="Algorand.algorand_model.html#valid_block_and_hash">valid_block_and_hash</a></span> <span class="id">b</span> <span class="id">v</span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> 4.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]].<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;need&nbsp;to&nbsp;grab&nbsp;u&nbsp;*)</span><br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H0</span>;<span class="id">subst</span>;<span class="id">clear</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="kwd">in</span> <span class="id">H_u</span>. <span class="id">case</span>: <span class="id">H_u</span> =&gt; {<span class="id">u</span>}&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_result">certvote_result</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">split</span>;[|<span class="id">split</span>]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="kwd">exists</span> <span class="id">b</span>;<span class="id">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">move</span>:<span class="id">H0</span> =&gt;-[? [? ?]];<span class="id">split</span>;[|<span class="id">split</span>;[|<span class="id">reflexivity</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">inversion</span> <span class="id">H_msg</span>;<span class="id">subst</span>;<span class="id">clear</span> <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="kwd">in</span> <span class="id">H_u</span>. <span class="id">case</span>:<span class="id">H_u</span> =&gt; <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">split</span>;[|<span class="id">split</span>]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|<span class="kwd">exists</span> <span class="id">b</span>;<span class="id">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">move</span>:<span class="id">H0</span> =&gt;-[? [? ?]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">If a user sent nextvote open, then <span class="bracket"><span class="id">nextvote_open_ok</span></span> must have held. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="nextvote_open_precondition">nextvote_open_precondition</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#nextvote_open_ok">nextvote_open_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>; <span class="id">inversion</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g1</span>) [` <span class="id">key_user</span>] = <span class="id">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>; <span class="id">inversion</span> <span class="id">H_u</span>; <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H_step</span>. <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">inversion</span> <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>; <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">If user sent nextvote val, then <span class="bracket"><span class="id">nextvote_val_ok</span></span> must have held. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="nextvote_val_precondition">nextvote_val_precondition</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">b</span>, <span class="id"><a href="Algorand.algorand_model.html#nextvote_val_ok">nextvote_val_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">v</span> <span class="id">b</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>) \/<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#nextvote_stv_ok">nextvote_stv_ok</a></span> <span class="id">u</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> /\ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sent</span> <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_sent</span> <span class="kwd">as</span> [<span class="id">ms</span> [<span class="id">H_msg</span> [[<span class="id">d1</span> [<span class="id">in1</span> <span class="id">H_step</span>]]|<span class="id">H_step</span>]]].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>; <span class="id">inversion</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g1</span>) [` <span class="id">key_user</span>] = <span class="id">u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>; <span class="id">inversion</span> <span class="id">H_u</span>; <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H_step</span>. <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">revert</span> <span class="id">H_msg</span>; <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; <span class="id">H_msg</span>; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_msg</span>; <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">try</span> <span class="id">contradiction</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">destruct</span> <span class="id">H_msg</span> <span class="kwd">as</span> [<span class="id">H_msg</span> | <span class="id">H_msg</span>]; <span class="id">inversion</span> <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">left</span>; <span class="kwd">exists</span> <span class="id">b</span>; <span class="id">subst</span>; <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>; <span class="id">subst</span>; <span class="id">split</span>; <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<h2> Voting for one value in a period </h2>
<br/>
<div class="doc">An honest user cert-votes for at most one value in a period.
In any global state, an honest user either never certvotes in a period or
certvotes once in step 3 and never certvotes after that during that period. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="no_two_certvotes_in_p">no_two_certvotes_in_p</a></span> : <span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>) <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix1</span> <span class="id">v1</span>, <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span> <span class="id">ix1</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest_at">user_honest_at</a></span> <span class="id">ix1</span> <span class="id">trace</span> <span class="id">uid</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix2</span> <span class="id">v2</span>, <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span> <span class="id">ix2</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest_at">user_honest_at</a></span> <span class="id">ix2</span> <span class="id">trace</span> <span class="id">uid</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix1</span> = <span class="id">ix2</span> /\ <span class="id">v1</span> = <span class="id">v2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g0</span> <span class="id">trace</span> <span class="id">H_path</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix1</span> <span class="id">v1</span> <span class="id">H_send1</span> <span class="id">H_honest1</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix2</span> <span class="id">v2</span> <span class="id">H_send2</span> <span class="id">H_honest2</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix1</span> &lt;= <span class="id">ix2</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_sends">order_sends</a></span> <span class="id">H_path</span> <span class="id">H_send1</span> <span class="id">H_send2</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix2</span> &lt;= <span class="id">ix1</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_sends">order_sends</a></span> <span class="id">H_path</span> <span class="id">H_send2</span> <span class="id">H_send1</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span> <span class="id">_</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_le1</span> <span class="id">H_le2</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix1</span> = <span class="id">ix2</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#eqn_leq">eqn_leq</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>. <span class="id">split</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">intro</span>;<span class="id">subst</span> <span class="id">ix2</span>;<span class="id">clear</span> <span class="id">H_le1</span> <span class="id">H_le2</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">reflexivity</span>|].<br/>
<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_send1</span>, <span class="id">H_send2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_send1</span> <span class="kwd">as</span> [<span class="id">pre1</span> [<span class="id">post1</span> [<span class="id">H_step1</span> <span class="id">H_send1</span>]]].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_send2</span> <span class="kwd">as</span> [<span class="id">pre2</span> [<span class="id">post2</span> [<span class="id">H_step2</span> <span class="id">H_send2</span>]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_ix_same">step_ix_same</a></span> <span class="id">H_step1</span> <span class="id">H_step2</span>) <span class="kwd">as</span> [-&gt; -&gt;].<br/>
&nbsp;&nbsp;<span class="id">symmetry</span>.<br/>
&nbsp;&nbsp;<span class="id">refine</span> (<span class="id"><a href="Algorand.safety.html#vote_value_unique">vote_value_unique</a></span> <span class="id">H_send1</span> <span class="id">_</span> <span class="id">H_send2</span>).<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety_helpers.html#at_step_onth">at_step_onth</a></span> <span class="id">H_honest1</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step1</span>)).<br/>
Qed.</div>
<br/>
<div class="doc">An honest user soft-votes for at most one value in a period. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="no_two_softvotes_in_p">no_two_softvotes_in_p</a></span> : <span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>) <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix1</span> <span class="id">v1</span>, <span class="id"><a href="Algorand.quorums.html#softvoted_in_path_at">softvoted_in_path_at</a></span> <span class="id">ix1</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix2</span> <span class="id">v2</span>, <span class="id"><a href="Algorand.quorums.html#softvoted_in_path_at">softvoted_in_path_at</a></span> <span class="id">ix2</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix1</span> = <span class="id">ix2</span> /\ <span class="id">v1</span> = <span class="id">v2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g0</span> <span class="id">trace</span> <span class="id">H_path</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix1</span> <span class="id">v1</span> <span class="id">H_send1</span> <span class="id">ix2</span> <span class="id">v2</span> <span class="id">H_send2</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix1</span> &lt;= <span class="id">ix2</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_sends">order_sends</a></span> <span class="id">H_path</span> <span class="id">H_send1</span> <span class="id">H_send2</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span> <span class="id">_</span>)).<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix2</span> &lt;= <span class="id">ix1</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_sends">order_sends</a></span> <span class="id">H_path</span> <span class="id">H_send2</span> <span class="id">H_send1</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span> <span class="id">_</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_le1</span> <span class="id">H_le2</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">ix1</span> = <span class="id">ix2</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#eqn_leq">eqn_leq</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>. <span class="id">split</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">intro</span>;<span class="id">subst</span> <span class="id">ix2</span>;<span class="id">clear</span> <span class="id">H_le1</span> <span class="id">H_le2</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">reflexivity</span>|].<br/>
<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#softvoted_in_path_at">softvoted_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_send1</span>, <span class="id">H_send2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_send1</span> <span class="kwd">as</span> [<span class="id">pre1</span> [<span class="id">post1</span> [<span class="id">H_step1</span> <span class="id">H_send1</span>]]].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_send2</span> <span class="kwd">as</span> [<span class="id">pre2</span> [<span class="id">post2</span> [<span class="id">H_step2</span> <span class="id">H_send2</span>]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_ix_same">step_ix_same</a></span> <span class="id">H_step1</span> <span class="id">H_step2</span>) <span class="kwd">as</span> [-&gt; -&gt;].<br/>
&nbsp;&nbsp;<span class="id">symmetry</span>.<br/>
&nbsp;&nbsp;<span class="id">refine</span> (<span class="id"><a href="Algorand.safety.html#softvote_value_unique">softvote_value_unique</a></span> <span class="id">H_send1</span> <span class="id">_</span> <span class="id">H_send2</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;honesty&nbsp;follows&nbsp;from&nbsp;user_sent&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_send1</span> <span class="kwd">as</span> [<span class="id">ms</span>' [<span class="id">H_msg</span>' [[<span class="id">d1</span>' [<span class="id">in1</span>' <span class="id">H_step</span>']]|<span class="id">H_step</span>']]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>' <span class="kwd">as</span> (<span class="id">key_ustate</span>' &amp; <span class="id">ustate_post</span>' &amp; <span class="id">H_step</span>' &amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_honest</span>' &amp; <span class="id">key_mailbox</span>' &amp; <span class="id">H_msg_in_mailbox</span>' &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>; <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>' <span class="kwd">as</span> (<span class="id">key_user</span>' &amp; <span class="id">ustate_post</span>' &amp; <span class="id">H_honest</span>' &amp; <span class="id">H_step</span>' &amp; -&gt;).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>; <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
Qed.</div>
<br/>
<h2> Votes present in user state were received </h2>
<br/>
<div class="doc">A vote in a user's softvote set means a softvote was received. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="received_softvote">received_softvote</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">ix</span> <span class="id">g</span> (<span class="id">H_last</span>: <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span>) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>, (<span class="id">voter</span>, <span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">r0</span> &lt;= <span class="id">r</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d</span>, <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_last</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">H_softvotes</span> <span class="id">H_r</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (~~<span class="kwd">match</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u0</span> =&gt; (<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u0</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>]) <span class="kwd">as</span> [<span class="id">u0</span>|] <span class="id">eqn</span>:<span class="id">H_u0</span>;[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_start</span> <span class="kwd">as</span> [<span class="id">H_users</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_key0</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_users</span> <span class="id">_</span> <span class="id">H_key0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_key0</span>) <span class="kwd">in</span> <span class="id">H_u0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_u0</span> <span class="id">H_r</span> <span class="id">H_users</span> =&gt; -&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_r</span> [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">H_softvotes</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: {<span class="id">H_softvotes</span>}(<span class="id">H_softvotes</span> <span class="id">_</span> <span class="id">p</span> <span class="id">H_r</span>) =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilP">nilP</a></span> -&gt;.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> <span class="id">H_path</span> <span class="kwd">as</span> <span class="id">H_path_copy</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">P</span> := <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id">uid</span> (<span class="kwd">fun</span> <span class="id">u</span> =&gt; (<span class="id">voter</span>, <span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ix_p</span>:=<span class="id">ix</span>) (<span class="id">g_p</span>:=<span class="id">g</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">H_path_copy</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">eassumption</span>; <span class="id">try</span> (<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>; <span class="id">rewrite</span> <span class="id">H_u</span>; <span class="id">assumption</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path_copy</span> <span class="kwd">as</span> [<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> [<span class="id">H_pg1</span> <span class="id">H_pg2</span>]]]]].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_step_copy</span> := <span class="id">H_step</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="kwd">with</span> (<span class="id">g0</span>:=<span class="id">g0</span>) <span class="kwd">in</span> <span class="id">H_step_copy</span>; <span class="id">try</span> <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>]) <span class="id">eqn</span>:<span class="id">H_u2</span>; <span class="id">try</span> (<span class="kwd">by</span> <span class="id">inversion</span> <span class="id">H_u2</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>]) <span class="id">eqn</span>:<span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;2: {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#gtrans_preserves_users">gtrans_preserves_users</a></span> <span class="kwd">in</span> <span class="id">H_step_copy</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_step_copy</span>; <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>. <span class="id">inversion</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="kwd">exists</span> <span class="id">d</span> <span class="id">ms</span>, <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">ms</span>) <span class="id">g1</span> <span class="id">g2</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in2</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>': <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>] = <span class="id">u1</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>;<span class="id">case</span>:<span class="id">H_u1</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step_copy</span>; <span class="id">simpl</span> <span class="id">users</span>; <span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">gtransition_unfold</span> <span class="kwd">in</span> * |-; <span class="id">unfold</span> <span class="id">RecordSet.set</span> <span class="kwd">in</span> *; <span class="id">simpl</span> <span class="kwd">in</span> *;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">exfalso</span>; <span class="id">rewrite</span> <span class="id">H_u1</span> <span class="kwd">in</span> <span class="id">H_u2</span>; <span class="id">inversion</span> <span class="id">H_u2</span>; <span class="id">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;+ {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span> <span class="kwd">as</span> [<span class="id">H_adv</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_in1</span>' /<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span> <span class="kwd">in</span> <span class="id">H_adv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_adv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">subst</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;+ {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>). <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>; <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2: {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_eq</span> <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u1</span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H2</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_deliv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pending</span>.1,<span class="id">pending</span>.2) <span class="kwd">as</span> <span class="id">pending_res</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_pending</span> : <span class="id">pending</span> = <span class="id">pending_res</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pending</span>. <span class="id">subst</span> <span class="id">pending_res</span>. <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Heqpending_res</span> <span class="kwd">in</span> <span class="id">H_pending</span>; <span class="id">clear</span> <span class="id">Heqpending_res</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_deliv</span> <span class="id">eqn</span>:<span class="id">H_dtrans</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="kwd">by</span> <span class="id">case</span>: <span class="id">H_result</span> =&gt; [? ?]; <span class="id">destruct</span> <span class="id">pre</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>; <span class="id">simpl</span> <span class="kwd">in</span> * |-; <span class="id">exfalso</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;deliver&nbsp;softvote&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;* {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_result</span> =&gt; [<span class="id">pre</span>'<span class="id">_eq</span> <span class="id">sent_eq</span>]; <span class="id">destruct</span> <span class="id">pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">pending</span>.1, [::], <span class="id">H_in1</span>, <span class="id">ustate_post</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span>; <span class="id">unfold</span> <span class="id">RecordSet.set</span>. <span class="id">simpl</span> <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">ustate_post</span>. <span class="id">subst</span> <span class="id">u0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pre</span>', <span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="id">eqn</span>:<span class="id">Hb1</span> <span class="kwd">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="kwd">by</span> <span class="id">intro</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">eq_rp</span>: (<span class="id">_</span> == <span class="id">_</span>); <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">H_pg2</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">eq_rp</span> =&gt; <span class="id">eq_r</span> <span class="id">eq_p</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> =&gt; <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">eq_rp</span>: (<span class="id">_</span> == <span class="id">_</span>); <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">H_pg2</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">eq_rp</span> =&gt; <span class="id">eq_r</span> <span class="id">eq_p</span>. <span class="id">subst</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> =&gt; <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_pg2</span> <span class="kwd">as</span> [<span class="id">H_eqv</span> | <span class="id">H_neqv</span>]; <span class="id">last</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_neqv</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eqv</span>. <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">Hb1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_eqv</span> =&gt; <span class="id">eq_i</span> <span class="id">eq_v</span>. <span class="id">subst</span> <span class="id">voter</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>. <span class="id">case</span>: <span class="id">H_u1</span> =&gt; <span class="id">eq_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">eq_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">msg_key</span>. <span class="id">rewrite</span> -<span class="id">H_pending</span>. <span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sent_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;set&nbsp;softvote&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;* {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_result</span> =&gt; [<span class="id">pre</span>'<span class="id">_eq</span> <span class="id">sent_eq</span>]; <span class="id">destruct</span> <span class="id">pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">pending</span>.1, [:: <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Certvote">Certvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v0</span>) <span class="id">r1</span> <span class="id">p0</span> <span class="id">uid</span>], <span class="id">H_in1</span>, <span class="id">ustate_post</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span>. <span class="id">unfold</span> <span class="id">RecordSet.set</span>. <span class="id">simpl</span> <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">ustate_post</span>. <span class="id">subst</span> <span class="id">u0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="id">eqn</span>:<span class="id">Hb1</span> <span class="kwd">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="kwd">by</span> <span class="id">intro</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">eq_rp</span>: (<span class="id">_</span> == <span class="id">_</span>); <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">H_pg2</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">eq_rp</span> =&gt; <span class="id">eq_r</span> <span class="id">eq_p</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> =&gt; <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">eq_rp</span>: (<span class="id">_</span> == <span class="id">_</span>); <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">H_pg2</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">eq_rp</span> =&gt; <span class="id">eq_r</span> <span class="id">eq_p</span>. <span class="id">subst</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> =&gt; <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_pg2</span> <span class="kwd">as</span> [<span class="id">H_eqv</span> | <span class="id">H_neqv</span>]; <span class="id">last</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_neqv</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eqv</span>. <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">Hb1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_eqv</span> =&gt; <span class="id">eq_i</span> <span class="id">eq_v</span>. <span class="id">subst</span> <span class="id">voter</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>. <span class="id">case</span>: <span class="id">H_u1</span> =&gt; <span class="id">eq_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">eq_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">msg_key</span>. <span class="id">rewrite</span> -<span class="id">H_pending</span>. <span class="id">split</span> =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sent_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;deliver&nbsp;nonvote&nbsp;msg&nbsp;result&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;* {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_result</span> =&gt; [? ?]; <span class="id">destruct</span> <span class="id">pre</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span> <span class="kwd">in</span> <span class="id">H_pg2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_ev">msg_ev</a></span> <span class="id">msg</span>) <span class="kwd">in</span> <span class="id">H_pg2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_type">msg_type</a></span> <span class="id">msg</span>) <span class="kwd">in</span> <span class="id">H_pg2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;+ {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>). <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>; <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;2: {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_eq</span> <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u1</span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H1</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_trans</span>. <span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_trans</span>; <span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?]; <span class="id">subst</span>; <span class="id">destruct</span> <span class="id">pre</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> * |-; <span class="id">exfalso</span>; <span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;+ {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>; <span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>. <span class="id">subst</span> <span class="id">uid0</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>' <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_u2</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_eq</span> <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u1</span> <span class="kwd">in</span> <span class="id">H_u2</span>. <span class="id">inversion</span> <span class="id">H_u2</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_pg2</span> <span class="kwd">in</span> <span class="id">H_pg1</span>; <span class="id">inversion</span> <span class="id">H_pg1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> [<span class="id">d</span> [<span class="id">ms</span> <span class="id">H_rel</span>]].<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>, <span class="id">ms</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span>. <span class="kwd">exists</span> <span class="id">g1</span>, <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">assumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A vote in a user's nextvote open set means a nextvote was received. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="received_nextvote_open">received_nextvote_open</a></span><br/>
&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">voter</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>, <span class="id">voter</span> \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> &lt;= <span class="id">r</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d</span>, <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix</span> <span class="id">g</span> <span class="id">H_g</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">voter</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">H_voter</span> <span class="id">H_r</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">P</span> := <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id">uid</span> (<span class="kwd">fun</span> <span class="id">u</span> =&gt; <span class="id">voter</span> \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>)).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (~~<span class="id">P</span> <span class="id">g0</span>). {<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_start</span> =&gt; [<span class="id">H_users</span> <span class="id">_</span>]. <span class="id">clear</span> -<span class="id">H_users</span> <span class="id">H_r</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">P</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="id">eqn</span>: <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;* <span class="id">move</span>/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_in</span>) <span class="kwd">in</span> <span class="id">H_users</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">g0</span> <span class="id">H_in</span>}(<span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_in</span>]) <span class="id">H_users</span> =&gt; <span class="id">u</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety.html#user_before_round">user_before_round</a></span> <span class="kwd">in</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: {<span class="id">H4</span> <span class="id">H_r</span>}(<span class="id">H4</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">H_r</span>) =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilP">nilP</a></span> -&gt;.<br/>
&nbsp;&nbsp;* <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> // <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">P</span> <span class="id">g</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">have</span> := <span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="id">H_path</span> <span class="id">H_g</span> <span class="id">H</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> [<span class="id">H_pre</span> <span class="id">H_post</span>]]]]].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_gtrans</span> := <span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="id">H_path</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span>: <span class="kwd">exists</span> <span class="id">d</span> <span class="id">ms</span>, <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">ms</span>) <span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; [<span class="id">d</span> [<span class="id">ms</span> <span class="id">H_rel</span>]];<span class="kwd">exists</span> <span class="id">d</span>, <span class="id">n</span>, <span class="id">ms</span>, <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;<span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_gtrans</span> <span class="id">H_pre</span> <span class="id">H_post</span>;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>;<span class="id">clear</span>;<span class="id">destruct</span> 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">solve</span> [<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> /<span class="id">H_n</span> []].<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#tick_update">tick_update</a></span>, <span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span>. <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="id">eqn</span>:<span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_uid</span>]) =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span>;<span class="id">destruct</span> <span class="id">u</span>, <span class="id">corrupt</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbT">negbT</a></span> <span class="kwd">in</span> <span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> [(<span class="id"><a href="Algorand.fmap_ext.html#updf">updf</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>).[? <span class="id">uid</span>]] <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (?<span class="id">k</span> \<span class="kwd">in</span> ?<span class="id">f</span>) <span class="kwd">with</span> (<span class="id">k</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rtopology.html#f">f</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_n</span> /<span class="id">H_n</span> []].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pending</span> <span class="kwd">as</span> [<span class="id">d</span> <span class="id">pmsg</span>]. <span class="id">unfold</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#snd">snd</a></span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_ustate</span>]) <span class="kwd">as</span> <span class="id">ustate</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>, <span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="id">eqn</span>:<span class="id">H_step</span>;<span class="id">case</span>: <span class="id">Heqresult</span> =&gt; {<span class="id">ustate_post</span>}&lt;- {<span class="id">sent</span>}&lt;-;<span class="id">subst</span> <span class="id">pre0</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pre</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_n</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) = (<span class="id">r0</span>,<span class="id">p0</span>,<span class="id">s0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_p</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_open">set_nextvotes_open</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H2</span> =&gt; ? ? ?;<span class="id">subst</span> <span class="id">r0</span> <span class="id">p0</span> <span class="id">s0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">i</span> = <span class="id">voter</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span>. <span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_open">set_nextvotes_open</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H_p</span> <span class="kwd">with</span> <span class="id">context</span> <span class="id">C</span> [<span class="kwd">if</span> ?<span class="id">b</span> <span class="kwd">then</span> <span class="id">_</span> <span class="kwd">else</span> <span class="id">_</span>] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id">H_neq</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">subst</span> <span class="id">i</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pre</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_n</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) = (<span class="id">r0</span>,<span class="id">p0</span>,<span class="id">s0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_p</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_open">set_nextvotes_open</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">case</span>: <span class="id">H2</span> =&gt; ? ? ?;<span class="id">subst</span> <span class="id">r0</span> <span class="id">p0</span> <span class="id">s0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">i</span> = <span class="id">voter</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span>. <span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_open">set_nextvotes_open</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H_p</span> <span class="kwd">with</span> <span class="id">context</span> <span class="id">C</span> [<span class="kwd">if</span> ?<span class="id">b</span> <span class="kwd">then</span> <span class="id">_</span> <span class="kwd">else</span> <span class="id">_</span>] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id">H_neq</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="kwd">in</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">subst</span> <span class="id">i</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>; <span class="id">exfalso</span>;<span class="id">contradict</span> <span class="id">H_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_ustate</span>]) <span class="id">H_p</span> =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">msg</span> <span class="kwd">as</span> [<span class="id">m</span> <span class="id">v</span> <span class="id">mr</span> <span class="id">mp</span> <span class="id">mu</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">v</span>;<span class="id">first</span> <span class="id">destruct</span> <span class="id">m</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">ustate_key</span>]) <span class="id">H0</span> =&gt; <span class="id">u</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<span class="id">destruct</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">Heqresult</span> =&gt; &lt;- <span class="id">_</span>;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">pre</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">A vote in a user's nextvote_val set means a nextvote_val message was received. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="received_nextvote_val">received_nextvote_val</a></span><br/>
&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>, (<span class="id">voter</span>, <span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_val">nextvotes_val</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> &lt;= <span class="id">r</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d</span>, <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix</span> <span class="id">g</span> <span class="id">H_g</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">H_voter</span> <span class="id">H_r</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">P</span> := <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id">uid</span> (<span class="kwd">fun</span> <span class="id">u</span> =&gt; (<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_val">nextvotes_val</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>)).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (~~<span class="id">P</span> <span class="id">g0</span>). {<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_start</span> =&gt; [<span class="id">H_users</span> <span class="id">_</span>]. <span class="id">clear</span> -<span class="id">H_users</span> <span class="id">H_r</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">P</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="id">eqn</span>: <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;* <span class="id">move</span>/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_in</span>) <span class="kwd">in</span> <span class="id">H_users</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">g0</span> <span class="id">H_in</span>}(<span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_in</span>]) <span class="id">H_users</span> =&gt; <span class="id">u</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety.html#user_before_round">user_before_round</a></span> <span class="kwd">in</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_users</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: {<span class="id">H6</span> <span class="id">H_r</span>}(<span class="id">H6</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">H_r</span>) =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nilP">nilP</a></span> -&gt;.<br/>
&nbsp;&nbsp;* <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> // <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">P</span> <span class="id">g</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">have</span> := <span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="id">H_path</span> <span class="id">H_g</span> <span class="id">H</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> [<span class="id">H_pre</span> <span class="id">H_post</span>]]]]].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_gtrans</span> := <span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="id">H_path</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span>: <span class="kwd">exists</span> <span class="id">d</span> <span class="id">ms</span>, <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>) <span class="id">ms</span>) <span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; [<span class="id">d</span> [<span class="id">ms</span> <span class="id">H_rel</span>]];<span class="kwd">exists</span> <span class="id">d</span>, <span class="id">n</span>, <span class="id">ms</span>, <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;<span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_gtrans</span> <span class="id">H_pre</span> <span class="id">H_post</span>;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>;<span class="id">clear</span>;<span class="id">destruct</span> 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">solve</span> [<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> /<span class="id">H_n</span> []].<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#tick_update">tick_update</a></span>, <span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span>. <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="id">eqn</span>:<span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_uid</span>]) =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span>;<span class="id">destruct</span> <span class="id">u</span>, <span class="id">corrupt</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbT">negbT</a></span> <span class="kwd">in</span> <span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> [(<span class="id"><a href="Algorand.fmap_ext.html#updf">updf</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>).[? <span class="id">uid</span>]] <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (?<span class="id">k</span> \<span class="kwd">in</span> ?<span class="id">f</span>) <span class="kwd">with</span> (<span class="id">k</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rtopology.html#f">f</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_n</span> /<span class="id">H_n</span> []].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pending</span> <span class="kwd">as</span> [<span class="id">d</span> <span class="id">pmsg</span>]. <span class="id">unfold</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#snd">snd</a></span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_ustate</span>]) <span class="kwd">as</span> <span class="id">ustate</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>, <span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="id">eqn</span>:<span class="id">H_step</span>;<span class="id">case</span>: <span class="id">Heqresult</span> =&gt; {<span class="id">ustate_post</span>}&lt;- {<span class="id">sent</span>}&lt;-;<span class="id">subst</span> <span class="id">pre0</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pre</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_n</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) = (<span class="id">r0</span>,<span class="id">p0</span>,<span class="id">s0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_p</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_val">set_nextvotes_val</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">case</span>: <span class="id">H2</span> =&gt; ? ? ?;<span class="id">subst</span> <span class="id">r0</span> <span class="id">p0</span> <span class="id">s0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">voter</span>,<span class="id">v</span>) = (<span class="id">i</span>,<span class="id">v0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_p</span>; <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_val">set_nextvotes_val</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|- <span class="id">context</span> <span class="id">C</span>[(<span class="id">i</span>, <span class="id">v0</span>) \<span class="kwd">in</span> ?<span class="id">nvs</span>]] =&gt; <span class="id">destruct</span> ((<span class="id">i</span>,<span class="id">v0</span>) \<span class="kwd">in</span> <span class="id">nvs</span>) <span class="id">eqn</span>:<span class="id">H_in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>; <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">destruct</span> 1 <span class="kwd">as</span> [<span class="id">H_eq</span>|<span class="id">H_in</span>'];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H_eq</span>; <span class="id">discriminate</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">case</span>: <span class="id">H2</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">i</span> <span class="id">v0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pre</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_n</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) = (<span class="id">r0</span>,<span class="id">p0</span>,<span class="id">s0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_p</span>; <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_val">set_nextvotes_val</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">case</span>: <span class="id">H2</span> =&gt; ? ? ?;<span class="id">subst</span> <span class="id">r0</span> <span class="id">p0</span> <span class="id">s0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id">voter</span>,<span class="id">v</span>) = (<span class="id">i</span>,<span class="id">v0</span>)). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>. <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNT">contraNT</a></span>: <span class="id">H_n</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span> <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_p</span>; <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_val">set_nextvotes_val</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|- <span class="id">context</span> <span class="id">C</span>[(<span class="id">i</span>, <span class="id">v0</span>) \<span class="kwd">in</span> ?<span class="id">nvs</span>]] =&gt; <span class="id">destruct</span> ((<span class="id">i</span>,<span class="id">v0</span>) \<span class="kwd">in</span> <span class="id">nvs</span>) <span class="id">eqn</span>:<span class="id">H_in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>; <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">destruct</span> 1 <span class="kwd">as</span> [<span class="id">H_eq</span>|<span class="id">H_in</span>'];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H_eq</span>; <span class="id">discriminate</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;} <span class="id">case</span>: <span class="id">H2</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">i</span> <span class="id">v0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>; <span class="id">exfalso</span>;<span class="id">contradict</span> <span class="id">H_n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_ustate</span>]) <span class="id">H_p</span> =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">msg</span> <span class="kwd">as</span> [<span class="id">m</span> <span class="id">v0</span> <span class="id">mr</span> <span class="id">mp</span> <span class="id">mu</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">v0</span>;<span class="id">first</span> <span class="id">destruct</span> <span class="id">m</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">ustate_key</span>]) <span class="id">H0</span> =&gt; <span class="id">u</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<span class="id">destruct</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">Heqresult</span> =&gt; &lt;- <span class="id">_</span>;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">pre</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_n</span> <span class="id">H_p</span>. <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_n</span>; <span class="id">move</span>: <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uids</span>;[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uids</span>. <span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<h2> Softvotes in user state means a voter softvoted earlier in the path </h2>
<br/>
<div class="doc">Suppose <span class="bracket">(<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id">softvotes</span>) <span class="id">r</span> <span class="id">p</span></span>. Then,
<ul>
<li>
 message <span class="bracket">(<span class="id">Softvote</span>, <span class="id">val</span> <span class="id">v</span>, <span class="id">r</span>, <span class="id">p</span>, <span class="id">i</span>)</span> was received, and
</li>
<li>
 message <span class="bracket">(<span class="id">Softvote</span>, <span class="id">val</span> <span class="id">v</span>, <span class="id">r</span>, <span class="id">p</span>, <span class="id">i</span>)</span> was sent.
</li>
</ul>
In the latter case, either
<ul>
<li>
 user <span class="bracket"><span class="id">i</span></span> sent <span class="bracket">(<span class="id">Softvote</span>, <span class="id">val</span> <span class="id">v</span>, <span class="id">r</span>, <span class="id">p</span>, <span class="id">i</span>)</span> (through an internal transition only), meaning
  softvoting preconditions imply <span class="bracket"><span class="id">i</span></span> was a committee member, or
</li>
<li>
 the adversary (using <span class="bracket"><span class="id">i</span></span>) forged and sent the message, meaning forging does the credentials check, or
</li>
<li>
 the adversary replayed the message, meaning
<ul>
<li>
 the message is in <span class="bracket"><span class="id">msg_history</span></span>, and
</li>
<li>
 user <span class="bracket"><span class="id">i</span></span> sent it (through an internal transition only), and
</li>
<li>
 softvoting preconditions imply <span class="bracket"><span class="id">i</span></span> was a committee member. </li>
</ul>
</div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvotes_sent">softvotes_sent</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">r0</span> &lt;= <span class="id">r</span> -&gt; <span class="kwd">forall</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,2) <span class="id">voter</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span> <span class="id">trace</span> <span class="id">voter</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">r</span> <span class="id">H_r</span> <span class="id">voter</span> <span class="id">v</span> <span class="id">p</span> <span class="id">H_voter</span> <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">generalize</span> <span class="id">dependent</span> <span class="id">g</span>. <span class="id">generalize</span> <span class="id">dependent</span> <span class="id">ix</span>. <span class="id">generalize</span> <span class="id">dependent</span> <span class="id">voter</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">trace</span> <span class="kwd">using</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_ind">last_ind</a></span>;[<span class="id">discriminate</span>|].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_path</span>).<br/>
&nbsp;&nbsp;<span class="id">rename</span> <span class="id">H_path</span> <span class="id">into</span> <span class="id">H_path_trans</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#rcons">rcons</a></span> <span class="id">trace</span> <span class="id">x</span>) <span class="id">eqn</span>:<span class="id">H_rcons</span>.<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_path_trans</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path_trans</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path_add</span>]; <span class="id">subst</span> <span class="id">g</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rcons</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_path</span> <span class="id">voter</span> <span class="id">H_voter</span> <span class="id">H_honest</span> <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">ix</span> == (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">trace</span>)) <span class="id">eqn</span>:<span class="id">H_add</span>.<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;ix&nbsp;=&nbsp;size&nbsp;trace&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_add</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_onth_copy</span> := <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="kwd">in</span> <span class="id">H_onth_copy</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_rcons">drop_rcons</a></span> // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_size">drop_size</a></span> <span class="kwd">in</span> <span class="id">H_onth_copy</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_onth_copy</span> =&gt; <span class="id">H_x</span>. <span class="id">subst</span> <span class="id">x</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_path_copy</span> := <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#received_softvote">received_softvote</a></span> <span class="kwd">in</span> <span class="id">H_path</span>;[|<span class="id">eassumption</span>..].<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">d</span> <span class="id">H_msg_rec</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="kwd">with</span> (<span class="id">r0</span>:=<span class="id">r0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">u</span>:=<span class="id">uid</span>) (<span class="id">d</span>:=<span class="id">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">msg</span>:=(<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">H_path_copy</span>;[|<span class="id">assumption</span>..].<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_path_copy</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path_copy</span> <span class="kwd">as</span> [<span class="id">ix0</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_s_at</span> <span class="id">H_sent</span>]]]].<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">ix0</span>, <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;<span class="id">move</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_add</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_onth</span>' := <span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_rcons">size_rcons</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>'.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_ix</span> : <span class="id">ix</span> &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">trace</span>) <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_onth</span>' <span class="id">H_add</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_onth_trace</span> : (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span>) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span>). {<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_rcons">drop_rcons</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_nth">drop_nth</a></span> <span class="kwd">with</span> (<span class="id">x0</span>:=<span class="id">g0</span>) <span class="kwd">in</span> <span class="id">H_ix</span>; <span class="id">rewrite</span> <span class="id">H_ix</span> <span class="kwd">in</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_ix</span>. <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_trace</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>;[<span class="kwd">by</span> <span class="id">inversion</span> <span class="id">H_onth_trace</span>|].<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_rcons</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">done</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#rcons_path">rcons_path</a></span> <span class="kwd">in</span> <span class="id">H_path_add</span>; <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>: <span class="id">H_path_add</span>; <span class="id">intuition</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">IHtrace</span> <span class="kwd">in</span> <span class="id">H_trace</span>; <span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_trace</span> <span class="kwd">as</span> [<span class="id">ix0</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_s_at</span> <span class="id">H_sent</span>]]]].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span>, <span class="id"><a href="Algorand.quorums.html#softvoted_in_path_at">softvoted_in_path_at</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">ix0</span>, <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;[|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_prefix">step_in_path_prefix</a></span> <span class="kwd">with</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">trace</span>);<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#take_rcons">take_rcons</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_honest</span>;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all_rcons">all_rcons</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [] <span class="id">_</span>.<br/>
Qed.</div>
<br/>
<h2> Sender or forger of a message has sufficiently small credential </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="user_sent_credential">user_sent_credential</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">let</span>:(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) := <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">ms</span> [<span class="id">H_in</span> [[<span class="id">d</span> [<span class="id">pending</span> <span class="id">H_rel</span>]]|<span class="id">H_rel</span>]]];<span class="id">move</span>: <span class="id">H_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rel</span>;<br/>
&nbsp;&nbsp;[<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]] |<br/>
&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_rel</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]] ].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;utransition&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_ustep</span>. <span class="id">clear</span>. <span class="id">move</span>: {<span class="id">g1</span> <span class="id">H_uid</span>}(<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_uid</span>]) =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">result</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">case</span>:<span class="id">Heqresult</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">ustate_post</span> <span class="id">ms</span>;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; /= <span class="id">H_in</span>;<span class="id">intuition</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">msg</span>;<span class="id">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span>;<span class="kwd">exists</span> <span class="id">uid</span>;[|<span class="id">reflexivity</span>];<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;utransition&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_ustep</span>. <span class="id">clear</span>. <span class="id">move</span>: {<span class="id">g1</span> <span class="id">H_uid</span>}(<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_uid</span>]) =&gt; <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">ms</span>) <span class="kwd">as</span> <span class="id">result</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">case</span>:<span class="id">Heqresult</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">ustate_post</span> <span class="id">ms</span>;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> =&gt; /= <span class="id">H_in</span>;<span class="id">intuition</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">subst</span> <span class="id">msg</span>;<span class="id">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span>;<span class="kwd">exists</span> <span class="id">uid</span>;[|<span class="id">reflexivity</span>];<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> * |-;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [<span class="id">H</span>:<span class="id">context</span> <span class="id">C</span> [<span class="id"><a href="Algorand.algorand_model.html#comm_cred_step">comm_cred_step</a></span>] |- <span class="id">_</span>] =&gt; <span class="id">decompose</span> <span class="id">record</span>  <span class="id">H</span>;<span class="id">assumption</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="user_forged_credential">user_forged_credential</a></span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">let</span>:(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) := <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">msg</span> =&gt; [<span class="id">mty</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">sender</span>] <span class="id">H_forged</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="kwd">in</span> <span class="id">H_forged</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_forged</span>.<br/>
&nbsp;&nbsp;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H_forged</span>;<span class="id">clear</span> <span class="id">H_forged</span>;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">x</span>]) <span class="id">H1</span> <span class="id">H0</span> =&gt; <span class="id">u</span>. <span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">mty</span>, <span class="id">v</span>;<span class="id">simpl</span>;(<span class="id">try</span> <span class="id">solve</span>[<span class="id">destruct</span> 1]) =&gt; {<span class="id">x0</span>}-&gt; <span class="id">H_cred</span>;<br/>
&nbsp;&nbsp;(<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span>;<span class="kwd">exists</span> <span class="id">sender</span>;[|<span class="id">reflexivity</span>];<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>;<span class="id">assumption</span>).<br/>
Qed.</div>
<br/>
<h2> Checking credentials </h2>
<br/>
<div class="doc">All softvoters in a round/period are in the committee for step 2. </li>
</ul>
</div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvote_credentials_checked">softvote_credentials_checked</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">r0</span> &lt;= <span class="id">r</span> -&gt; <span class="kwd">forall</span> <span class="id">v</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#softvoters_for">softvoters_for</a></span> <span class="id">v</span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> 2.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
&nbsp;&nbsp;<span class="comment">(*&nbsp;cleanup&nbsp;needed&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_lookup</span> <span class="id">r</span> <span class="id">H_r</span> <span class="id">v</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubsetP">fsubsetP</a></span> =&gt; <span class="id">voter</span> <span class="id">H_softvoters</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_softvote</span> : (<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_softvoters</span>;<span class="id">clear</span>;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [] [<span class="id">xu</span> <span class="id">xv</span>] /= /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>] -&gt; -&gt;.<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_take_some">onth_take_some</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_ix</span> : <span class="id">ix</span>.+1 &gt; 0) <span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">d</span> [<span class="id">n</span> [<span class="id">ms</span> <span class="id">H_deliver</span>]]] :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#received_softvote">received_softvote</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#is_trace_prefix">is_trace_prefix</a></span> <span class="id">H_path</span> <span class="id">H_ix</span>) <span class="id">H_start</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_onth</span> <span class="id">H_lookup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_softvote</span> <span class="id">H_r</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">msg</span> := <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">send_ix</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">send_ix</span> <span class="id">trace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">voter</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> \/ <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">as</span> <span class="id">H_source</span>. {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span> /= <span class="kwd">in</span> <span class="id">H_deliver</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step_at</span> [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_step</span> [<span class="id">H_corrupt</span> <span class="id">H_deliver</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">key_mailbox</span> [<span class="id">H_in</span> <span class="id">H_g2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">refine</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_from_prefix">onth_from_prefix</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">_</span>));<span class="id">eassumption</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#pending_sent_or_forged">pending_sent_or_forged</a></span>;<span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_source</span> <span class="kwd">as</span> (<span class="id">send_ix</span> &amp; <span class="id">g1</span> &amp; <span class="id">g2</span> &amp; <span class="id">H_step</span> &amp; [<span class="id">H_send</span> | <span class="id">H_forge</span>]).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_sent_credential">user_sent_credential</a></span> <span class="kwd">in</span> <span class="id">H_send</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_forged_credential">user_forged_credential</a></span> <span class="kwd">in</span> <span class="id">H_forge</span>. <span class="id">assumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc">All nextvoters for bot in a round/period/step are in the committee. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="nextvote_open_credentials_checked">nextvote_open_credentials_checked</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">r0</span> &lt;= <span class="id">r</span> -&gt; <span class="kwd">forall</span> <span class="id">p</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_lookup</span> <span class="id">r</span> <span class="id">H_r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubsetP">fsubsetP</a></span> =&gt; <span class="id">voter</span> <span class="id">H_nextvoters</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_nextvote</span> : <span class="id">voter</span> \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">revert</span> <span class="id">H_nextvoters</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fset">in_fset</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#in_mem">in_mem</a></span> <span class="id">voter</span> <span class="id">_</span>) <span class="kwd">with</span> (<span class="id">voter</span> \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_take_some">onth_take_some</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_ix</span> : <span class="id">ix</span>.+1 &gt; 0) <span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">d</span> [<span class="id">n</span> [<span class="id">ms</span> <span class="id">H_deliver</span>]]] :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#received_nextvote_open">received_nextvote_open</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#is_trace_prefix">is_trace_prefix</a></span> <span class="id">H_path</span> <span class="id">H_ix</span>) <span class="id">H_start</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_onth</span> <span class="id">H_lookup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_nextvote</span> <span class="id">H_r</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">msg</span> := <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">send_ix</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">send_ix</span> <span class="id">trace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">voter</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> \/ <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">as</span> <span class="id">H_source</span>. {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span> /= <span class="kwd">in</span> <span class="id">H_deliver</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step_at</span> [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_step</span> [<span class="id">H_corrupt</span> <span class="id">H_deliver</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">key_mailbox</span> [<span class="id">H_in</span> <span class="id">H_g2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">refine</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_from_prefix">onth_from_prefix</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">_</span>));<span class="id">eassumption</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#pending_sent_or_forged">pending_sent_or_forged</a></span>;<span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_source</span> <span class="kwd">as</span> (<span class="id">send_ix</span> &amp; <span class="id">g1</span> &amp; <span class="id">g2</span> &amp; <span class="id">H_step</span> &amp; [<span class="id">H_send</span> | <span class="id">H_forge</span>]).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_sent_credential">user_sent_credential</a></span> <span class="kwd">in</span> <span class="id">H_send</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_forged_credential">user_forged_credential</a></span> <span class="kwd">in</span> <span class="id">H_forge</span>. <span class="id">assumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc">All nextvoters for bot val in a round/period/step are in the committee. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="nextvote_val_credentials_checked">nextvote_val_credentials_checked</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>, <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, <span class="id">r0</span> &lt;= <span class="id">r</span> -&gt; <span class="kwd">forall</span> <span class="id">v</span> <span class="id">p</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#nextvoters_val_for">nextvoters_val_for</a></span> <span class="id">v</span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_lookup</span> <span class="id">r</span> <span class="id">H_r</span> <span class="id">v</span> <span class="id">p</span> <span class="id">s</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubsetP">fsubsetP</a></span> =&gt; <span class="id">voter</span> <span class="id">H_nextvoters</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_nextvote</span> : (<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_val">nextvotes_val</a></span>) (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_nextvoters</span>;<span class="id">clear</span>;<span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [] [<span class="id">xu</span> <span class="id">xv</span>] /= /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>] -&gt; -&gt;.<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_take_some">onth_take_some</a></span> <span class="kwd">in</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_ix</span> : <span class="id">ix</span>.+1 &gt; 0) <span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">d</span> [<span class="id">n</span> [<span class="id">ms</span> <span class="id">H_deliver</span>]]] :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#received_nextvote_val">received_nextvote_val</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#is_trace_prefix">is_trace_prefix</a></span> <span class="id">H_path</span> <span class="id">H_ix</span>) <span class="id">H_start</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_onth</span> <span class="id">H_lookup</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_nextvote</span> <span class="id">H_r</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">msg</span> := <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">voter</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">send_ix</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">send_ix</span> <span class="id">trace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">voter</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> \/ <span class="id"><a href="Algorand.safety_helpers.html#user_forged">user_forged</a></span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">as</span> <span class="id">H_source</span>. {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span> /= <span class="kwd">in</span> <span class="id">H_deliver</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step_at</span> [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_step</span> [<span class="id">H_corrupt</span> <span class="id">H_deliver</span>]]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_deliver</span> =&gt; [<span class="id">key_mailbox</span> [<span class="id">H_in</span> <span class="id">H_g2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">refine</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_from_prefix">onth_from_prefix</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">_</span>));<span class="id">eassumption</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#pending_sent_or_forged">pending_sent_or_forged</a></span>;<span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_source</span> <span class="kwd">as</span> (<span class="id">send_ix</span> &amp; <span class="id">g1</span> &amp; <span class="id">g2</span> &amp; <span class="id">H_step</span> &amp; [<span class="id">H_send</span> | <span class="id">H_forge</span>]).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_sent_credential">user_sent_credential</a></span> <span class="kwd">in</span> <span class="id">H_send</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety.html#user_forged_credential">user_forged_credential</a></span> <span class="kwd">in</span> <span class="id">H_forge</span>. <span class="id">assumption</span>.<br/>
Qed.</div>
<br/>
<h2> Advancing the period </h2>
<br/>
<div class="doc">When the period advances to <span class="bracket"><span class="id">p</span></span>, and step of ustate changes to <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,1)</span> with round the same,
then original ustate must have had a smaller period. </div>
<span class="kwd">Definition</span> <span class="id"><a name="period_advances">period_advances</a></span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> (<span class="id">users1</span> <span class="id">users2</span>: {<span class="id">fmap</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>}) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;{<span class="id">ukey_1</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">users1</span> &amp;<br/>
&nbsp;&nbsp;{<span class="id">ukey_2</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">users2</span> &amp;<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">ustate1</span> := <span class="id">users1</span>.[<span class="id">ukey_1</span>] <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">ustate2</span> := <span class="id">users2</span>.[<span class="id">ukey_2</span>] <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">ustate1</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">ustate2</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate1</span>) (<span class="id">r</span>,<span class="id">p</span>,0)<br/>
&nbsp;&nbsp;/\ <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate2</span> = (<span class="id">r</span>,<span class="id">p</span>,1)}}.<br/>
<br/>
<div class="doc">Period advances from <span class="bracket"><span class="id">g1</span></span> to <span class="bracket"><span class="id">g2</span></span> at given index in path. </div>
<span class="kwd">Definition</span> <span class="id"><a name="period_advance_at">period_advance_at</a></span> <span class="id">n</span> <span class="id">path</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span> : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span> /\ <span class="id"><a href="Algorand.safety.html#period_advances">period_advances</a></span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)).<br/>
<br/>
<div class="doc">Period advances to <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> from <span class="bracket"><span class="id">ge1</span></span> to <span class="bracket"><span class="id">ge2</span></span>, and there is a message sent from <span class="bracket"><span class="id">gs1</span></span>
to <span class="bracket"><span class="id">gs2</span></span> in the path at <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> along with a step in the path from <span class="bracket"><span class="id">gs1</span></span> to <span class="bracket"><span class="id">gs2</span></span>, then
<span class="bracket"><span class="id">gs1</span></span> is reachable from <span class="bracket"><span class="id">ge2</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="post_enter_reaches_sent">post_enter_reaches_sent</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>:<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix_e</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">ge1</span> <span class="id">ge2</span> (<span class="id">H_enter</span>: <span class="id"><a href="Algorand.safety.html#period_advance_at">period_advance_at</a></span> <span class="id">ix_e</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">ge1</span> <span class="id">ge2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix_s</span> <span class="id">gs1</span> <span class="id">gs2</span> (<span class="id">H_step</span>: <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">gs1</span> <span class="id">gs2</span> <span class="id">ix_s</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">msg</span> (<span class="id">H_send</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">gs1</span> <span class="id">gs2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H_r_msg</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> = <span class="id">r</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H_p_msg</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> <span class="id">msg</span> = <span class="id">p</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">ge2</span> <span class="id">gs1</span>.<br/>
<div>&nbsp;<span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_enter</span> =&gt; [<span class="id">H_step_enter</span> [<span class="id">ukey_ge1</span> [<span class="id">ukey_ge2</span> [<span class="id">H_adv</span> [<span class="id">H_ge1_step_lt</span> <span class="id">H_ge2_step_eq</span>]]]]].<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">ukey_gs1</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">ix_e</span> &lt; <span class="id">ix_s</span>) <span class="kwd">as</span> <span class="id">H_order</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>: <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> (<span class="id">ge1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">ukey_ge1</span>]))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> (<span class="id">gs1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">ukey_gs1</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/(<span class="id"><a href="Algorand.safety_helpers.html#step_lt_le_trans">step_lt_le_trans</a></span> <span class="id">H_ge1_step_lt</span>)/<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_send</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ukey_gs1</span>)) /= <span class="id">H_r_msg</span> <span class="id">H_p_msg</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq0n">leq0n</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_ix_from_steps">order_ix_from_steps</a></span> <span class="id">H_path</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step_enter</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>)).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">exact</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span> <span class="id">H_path</span> (<span class="id">ix1</span>:=<span class="id">ix_e</span>.+1) (<span class="id">ix2</span>:=<span class="id">ix_s</span>) <span class="id">H_order</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step_enter</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>)).<br/>
Qed.</div>
<br/>
<div class="doc">A node enters period <span class="bracket"><span class="id">p</span> &gt; 0</span> only if it received <span class="bracket"><span class="id">t_H</span></span> next-votes for the same
value from some step <span class="bracket"><span class="id">s</span></span> of period <span class="bracket"><span class="id">p</span>-1</span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="period_advance_only_by_next_votes">period_advance_only_by_next_votes</a></span><br/>
&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>) :<br/>
&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>, <span class="id">r0</span> &lt;= <span class="id">r</span> -&gt;<br/>
&nbsp;<span class="kwd">forall</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.safety.html#period_advance_at">period_advance_at</a></span> <span class="id">n</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id">s</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>) (<span class="id">next_voters</span>:{<span class="id">fset</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>}),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">next_voters</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="kwd">if</span> <span class="id">v</span> <span class="kwd">then</span> <span class="id"><a href="Algorand.algorand_model.html#tau_v">tau_v</a></span> <span class="kwd">else</span> <span class="id"><a href="Algorand.algorand_model.html#tau_b">tau_b</a></span>) &lt;= #|` <span class="id">next_voters</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="kwd">exists</span> <span class="id">u</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> /\ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id">v</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="kwd">forall</span> <span class="id">voter</span>, <span class="id">voter</span> \<span class="kwd">in</span> <span class="id">next_voters</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#received_next_vote">received_next_vote</a></span> <span class="id">uid</span> <span class="id">voter</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">s</span> <span class="id">v</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">H_r</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">H_adv</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_adv</span> <span class="kwd">as</span> [<span class="id">H_step</span> [<span class="id">H_g1</span> [<span class="id">H_g2</span> [<span class="id">H_round</span> [<span class="id">H_lt</span> <span class="id">H_rps</span>]]]]].<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_gtrans</span> : <span class="id">g1</span> ~~&gt; <span class="id">g2</span>) <span class="kwd">by</span> (<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span>; <span class="id">eassumption</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_lt_0</span> := <span class="id">H_lt</span>).<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_le_trans">step_lt_le_trans</a></span> <span class="kwd">with</span> (<span class="id">c</span>:=(<span class="id">r</span>,<span class="id">p</span>,1)) <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;2: { <span class="id">simpl</span>; <span class="id">intuition</span>. }<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_gtrans</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#tick_users_upd">tick_users_upd</a></span> <span class="id">increment</span> <span class="id">H_g1</span>) <span class="kwd">as</span> <span class="id">H_tick</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_tick</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_tick_adv</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span> <span class="id">increment</span> <span class="id">pre</span>) [` <span class="id">H_g2</span>] =<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">increment</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">pre</span>) [` <span class="id">H_g1</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">injection</span> <span class="id">H_tick</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_tick</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#tick_update">tick_update</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">in_mem</span> <span class="id">mem</span>] <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_tick_adv</span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span> ((<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">pre</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[` <span class="id">H_g1</span>]));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_uid</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_key_ustate_opt</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_ustate</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_key_ustate_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_key_ustate</span>]. <span class="id">clear</span> <span class="id">H_g1_key_ustate_opt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> <span class="kwd">in</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">key_ustate</span>]) <span class="kwd">as</span> <span class="id">u</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>; <span class="id">intros</span> &lt;- &lt;-;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">inversion</span> <span class="id">H_rps</span>; <span class="id">exfalso</span>; <span class="id">subst</span>; <span class="id">subst</span> <span class="id">pre</span>';<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">contradiction</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;positive&nbsp;case:&nbsp;nextvote&nbsp;open&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">H_valid_rps</span> <span class="id">H_quorum_size</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> <span class="kwd">in</span> <span class="id">H_lt_0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_g1_key_ustate</span> <span class="id">H_g1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rename</span> <span class="id">pre0</span> <span class="id">into</span> <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">Hequ</span> <span class="kwd">in</span> <span class="id">H0</span> <span class="id">H_lt_0</span> <span class="id">H_lt</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">step_le</span> <span class="id">step_lt</span>] <span class="kwd">in</span> * |-.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_valid_rps</span> <span class="kwd">as</span> [<span class="id">H_r1</span> [<span class="id">H_p0</span> <span class="id">H_s</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_rps</span> =&gt; <span class="id">H_r</span>' <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">H_p</span> <span class="id">H_p0</span> -<span class="id">H_r</span>' <span class="id">H_r1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_n</span> : <span class="id">n</span>.+2 &gt; 0) <span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [<span class="id">H</span> : <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span>.+1 = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> ?<span class="id">x</span> |- <span class="id">_</span>] =&gt; <span class="id">rename</span> <span class="id">H</span> <span class="id">into</span> <span class="id">H_onth</span>;<span class="id">remember</span> <span class="id">x</span> <span class="kwd">as</span> <span class="id">dr</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(H_onth&nbsp;:&nbsp;onth&nbsp;(take&nbsp;n.+2&nbsp;trace)&nbsp;n.+1&nbsp;=&nbsp;Some&nbsp;dr).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;subst&nbsp;pref.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;destruct&nbsp;(n.+2&nbsp;&lt;&nbsp;size&nbsp;trace)&nbsp;eqn:H_n2.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply&nbsp;onth_take_some&nbsp;in&nbsp;H_step.&nbsp;rewrite&nbsp;size_take&nbsp;in&nbsp;H_step.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;H_n2&nbsp;in&nbsp;H_step.&nbsp;by&nbsp;intuition;&nbsp;eassumption.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(size&nbsp;trace&nbsp;&lt;=&nbsp;n.+2).&nbsp;by&nbsp;clear&nbsp;-H_n2;&nbsp;ppsimpl;&nbsp;lia.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;take_oversize;&nbsp;assumption.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_addsub</span> : (<span class="id">p0</span> + 1)%<span class="id">Nrec</span>.-1 = <span class="id">p0</span>). <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_addsub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_r0r1</span> : <span class="id">r0</span> &lt;= <span class="id">r1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_r1</span>; <span class="id">rewrite</span> <span class="id">H_r1</span> <span class="kwd">in</span> <span class="id">H_r</span>'; <span class="id">subst</span> <span class="id">r</span>; <span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">s</span>, <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>, (<span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span> <span class="id">pre</span>' <span class="id">r1</span> <span class="id">p0</span> <span class="id">s</span>); <span class="id">repeat</span> <span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#nextvote_open_credentials_checked">nextvote_open_credentials_checked</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">uid</span>:=<span class="id">uid</span>) (<span class="id">u</span>:=(<span class="id"><a href="Algorand.algorand_model.html#adv_period_open_result">adv_period_open_result</a></span> <span class="id">pre</span>'));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">eassumption</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">subst</span> <span class="id">dr</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>; <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_quorum_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#card_fseq">card_fseq</a></span> -<span class="id"><a href="Algorand.safety_helpers.html#finseq_size">finseq_size</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#adv_period_open_result">adv_period_open_result</a></span> <span class="id">pre</span>').<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">first</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Heqdr</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> //=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> <span class="id">H_p0</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#mem_remfF">mem_remfF</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intro</span> <span class="id">voter</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fset">in_fset</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#in_mem">in_mem</a></span> <span class="id">voter</span> <span class="id">_</span>) <span class="kwd">with</span> (<span class="id">voter</span> \<span class="kwd">in</span> <span class="id">pre</span>'.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_open">nextvotes_open</a></span>) (<span class="id">r1</span>, <span class="id">p0</span>, <span class="id">s</span>)).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_voter</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#received_nextvote_open">received_nextvote_open</a></span> <span class="kwd">with</span> (<span class="id">u</span>:=(<span class="id"><a href="Algorand.algorand_model.html#adv_period_open_result">adv_period_open_result</a></span> <span class="id">pre</span>'));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">eassumption</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">subst</span> <span class="id">dr</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>; <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;positive&nbsp;case:&nbsp;nextvote&nbsp;val&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">H_valid_rps</span> <span class="id">H_quorum_size</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> <span class="kwd">in</span> <span class="id">H_lt_0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_g1_key_ustate</span> <span class="id">H_g1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rename</span> <span class="id">pre0</span> <span class="id">into</span> <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">Hequ</span> <span class="kwd">in</span> <span class="id">H0</span> <span class="id">H_lt_0</span> <span class="id">H_lt</span> <span class="id">H_round</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_valid_rps</span> <span class="kwd">as</span> [<span class="id">H_r1</span> [<span class="id">H_p0</span> <span class="id">H_s</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_rps</span> =&gt; <span class="id">H_r</span>' <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">H_p</span> <span class="id">H_p0</span> -<span class="id">H_r</span>' <span class="id">H_r1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [<span class="id">H</span> : <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span>.+1 = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> ?<span class="id">x</span> |- <span class="id">_</span>] =&gt; <span class="id">rename</span> <span class="id">H</span> <span class="id">into</span> <span class="id">H_onth</span>;<span class="id">remember</span> <span class="id">x</span> <span class="kwd">as</span> <span class="id">dr</span> <span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_addsub</span> : (<span class="id">p0</span> + 1)%<span class="id">Nrec</span>.-1 = <span class="id">p0</span>). <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_addsub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_r0r1</span> : <span class="id">r0</span> &lt;= <span class="id">r1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_r1</span>; <span class="id">rewrite</span> <span class="id">H_r1</span> <span class="kwd">in</span> <span class="id">H_r</span>'; <span class="id">subst</span> <span class="id">r</span>; <span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">s</span>, (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>), (<span class="id"><a href="Algorand.algorand_model.html#nextvoters_val_for">nextvoters_val_for</a></span> <span class="id">v</span> <span class="id">pre</span>' <span class="id">r1</span> <span class="id">p0</span> <span class="id">s</span>); <span class="id">repeat</span> <span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#nextvote_val_credentials_checked">nextvote_val_credentials_checked</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">uid</span>:=<span class="id">uid</span>) (<span class="id">u</span>:=(<span class="id"><a href="Algorand.algorand_model.html#adv_period_val_result">adv_period_val_result</a></span> <span class="id">pre</span>' <span class="id">v</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">eassumption</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">subst</span> <span class="id">dr</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>; <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_quorum_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_value_quorum">nextvote_value_quorum</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#finseq_size">finseq_size</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#card_fseq">card_fseq</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> |[|- <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#is_true">is_true</a></span> (<span class="id"><a href="Algorand.algorand_model.html#tau_v">tau_v</a></span> &lt;= ?<span class="id">A</span>) -&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#is_true">is_true</a></span> (<span class="id"><a href="Algorand.algorand_model.html#tau_v">tau_v</a></span> &lt;= ?<span class="id">B</span>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id">suff</span> -&gt;: <span class="id">A</span> = <span class="id">B</span> <span class="kwd">by</span>[] <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#imfset_filter_size_lem">imfset_filter_size_lem</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#adv_period_val_result">adv_period_val_result</a></span> <span class="id">pre</span>' <span class="id">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">first</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Heqdr</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> /= <span class="id">H_p0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> //=; <span class="id">first</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fset1U">in_fset1U</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">Hin</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#getf_set">getf_set</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">voter</span> <span class="id">H_voter</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_nextvote</span> : (<span class="id">voter</span>,<span class="id">v</span>) \<span class="kwd">in</span> <span class="id">pre</span>'.(<span class="id"><a href="Algorand.algorand_model.html#nextvotes_val">nextvotes_val</a></span>) (<span class="id">r1</span>, <span class="id">p0</span>, <span class="id">s</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_voter</span>;<span class="id">move</span>=&gt;/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [] [<span class="id">xu</span> <span class="id">xv</span>] /= /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>];<span class="id">intros</span>-&gt;-&gt;.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#received_nextvote_val">received_nextvote_val</a></span> <span class="kwd">with</span> (<span class="id">u</span>:=(<span class="id"><a href="Algorand.algorand_model.html#adv_period_val_result">adv_period_val_result</a></span> <span class="id">pre</span>' <span class="id">v</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="id">eassumption</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">subst</span> <span class="id">dr</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>; <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_round</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_uid</span> : (<span class="id">uid</span> == <span class="id">uid</span>) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span>). <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>; <span class="id">trivial</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_uid</span> <span class="kwd">in</span> <span class="id">H_round</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_rps</span> <span class="kwd">as</span> [<span class="id">H_r0</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">step_lt</span> <span class="id">addn</span>] <span class="kwd">in</span> <span class="id">H_lt</span>. <span class="id">rewrite</span> <span class="id">H_r0</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">H_adv</span> <span class="id">_</span>]. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span> <span class="kwd">in</span> <span class="id">H_adv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_round</span> <span class="kwd">in</span> <span class="id">H_adv</span>. <span class="id">clear</span> -<span class="id">H_adv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_adv</span>; <span class="id">lia</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pre</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_rps</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">step_lt</span>] <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_ev">msg_ev</a></span> <span class="id">msg</span>); <span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_type">msg_type</a></span> <span class="id">msg</span>);<span class="id">cbn</span> -[<span class="id">step_lt</span>] <span class="kwd">in</span> <span class="id">H_lt</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_rps</span> <span class="id">H_lt</span> =&gt; -&gt; -&gt; -&gt;;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;internal&nbsp;step&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">Huid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">Huid</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_key_ustate_opt</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">ustate_key</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_key_ustate_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_key_ustate</span>]. <span class="id">clear</span> <span class="id">H_g1_key_ustate_opt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">ustate_key</span>]) <span class="kwd">as</span> <span class="id">u</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H0</span>; <span class="id">injection</span> <span class="id">Hequstep_out</span>; <span class="id">clear</span> <span class="id">Hequstep_out</span>; <span class="id">intros</span> &lt;- &lt;-; <span class="id">inversion</span> <span class="id">H_rps</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> [<span class="id">H_lam</span> [<span class="id">H_vrps</span> [<span class="id">H_ccs</span> [<span class="id">H_s</span> [<span class="id">H_rest</span>]]]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H4</span> <span class="id">H_s</span>; <span class="kwd">by</span> <span class="id">lia</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>; <span class="id">try</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">try</span> <span class="id">contradiction</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H0</span> <span class="id">H1</span> =&gt; <span class="id">H_nv_stv</span> <span class="id">H_stv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_nv_stv</span> <span class="kwd">as</span> [<span class="id">H_lam</span> [<span class="id">H_vrps</span> [<span class="id">H_ccs</span> [<span class="id">H_s</span> [<span class="id">H_rest</span>]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H5</span> <span class="id">H_s</span>. <span class="kwd">by</span> <span class="id">lia</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;no&nbsp;nextvote&nbsp;ok&nbsp;-&nbsp;need&nbsp;s&nbsp;&gt;&nbsp;3&nbsp;assumption?&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_lt_0</span>;<span class="id">rewrite</span> <span class="id">H_g1_key_ustate</span> -<span class="id">Hequ</span> /<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">H2</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>;<span class="id">move</span>: (<span class="id">pre0</span>.(<span class="id"><a href="Algorand.algorand_model.html#step">step</a></span>)) =&gt; <span class="id">s</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_ltP">step_ltP</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn0">ltn0</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rps</span>;<span class="id">inversion</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H2</span> <span class="id">H3</span> <span class="id">H4</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_lt</span>. <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;unfold&nbsp;certvote_timeout_ok&nbsp;in&nbsp;H0.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;inversion&nbsp;H0;&nbsp;subst.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;clear&nbsp;-H4&nbsp;H1.&nbsp;rewrite&nbsp;H1&nbsp;in&nbsp;H4.&nbsp;inversion&nbsp;H4.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;rewrite&nbsp;&lt;-&nbsp;H_rps&nbsp;in&nbsp;H_lt;&nbsp;apply&nbsp;step_lt_irrefl&nbsp;in&nbsp;H_lt;&nbsp;contradiction.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;recover&nbsp;from&nbsp;partition&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_g2_opt</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g2</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_g2_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_g2</span>]; <span class="id">clear</span> <span class="id">H_g1_g2_opt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_g2</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;enter&nbsp;partition&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_g2_opt</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g2</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_g2_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_g2</span>]; <span class="id">clear</span> <span class="id">H_g1_g2_opt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_g2</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;corrupt&nbsp;user&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">Huid</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">Huid</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_rps</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_ustate_key_opt</span> : <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">ustate_key</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_ustate_key_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_ustate_key</span>]; <span class="id">clear</span> <span class="id">H_g1_ustate_key_opt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_ustate_key</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;replay&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_g2_opt</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g2</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_g2_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_g2</span>]; <span class="id">clear</span> <span class="id">H_g1_g2_opt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_g2</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;forge&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_g1_g2_opt</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g1</span>]) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_g2</span>])).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_g1_g2_opt</span> <span class="kwd">as</span> [<span class="id">H_g1_g2</span>]; <span class="id">clear</span> <span class="id">H_g1_g2_opt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_g1_g2</span> <span class="kwd">in</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_rps</span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span> <span class="kwd">in</span> <span class="id">H_lt</span>; <span class="id">assumption</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_in_period_entered">honest_in_period_entered</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, 1 &lt; <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span>, <span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.safety.html#period_advance_at">period_advance_at</a></span> <span class="id">n</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">p</span> <span class="id">H_p_gt</span> <span class="id">uid</span> [<span class="id">ix</span> <span class="id">H_in_period</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_in_period</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">H_g</span>: (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span>) =&gt; [<span class="id">g</span>|] // <span class="id">H_in_period</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>]) <span class="kwd">as</span> [<span class="id">u</span>|] <span class="id">eqn</span>:<span class="id">H_u</span>;[|<span class="id">exfalso</span>;<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_in_period</span> =&gt; [<span class="id">H_honest</span> [<span class="id">H_r</span> <span class="id">H_p</span>]].<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">P</span> := <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id">uid</span> (<span class="kwd">fun</span> <span class="id">u</span> =&gt; (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) == <span class="id">r</span>) &amp;&amp; (<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) == <span class="id">p</span>)).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_Pg</span> : <span class="id">P</span> <span class="id">g</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id">P</span> /<span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id">H_u</span> <span class="id">H_r</span> <span class="id">H_p</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_NPg0</span>  : ~~ <span class="id">P</span> <span class="id">g0</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id">P</span> /<span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>]) <span class="kwd">as</span> [<span class="id">u0</span>|] <span class="id">eqn</span>:<span class="id">H_u0</span>;[|<span class="id">exact</span>].<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_r0</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_p0</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_start</span> =&gt; [<span class="id">H_users_before</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety.html#users_before_round">users_before_round</a></span> <span class="kwd">in</span> <span class="id">H_users_before</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in_u0</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g0</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u0</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_users_before</span> <span class="id">_</span> <span class="id">H_in_u0</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u0</span>. <span class="id">case</span>: <span class="id">H_u0</span> <span class="id">H_users_before</span> =&gt; -&gt; [<span class="id">H_u0_step</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_u0_step</span> =&gt; [| [] <span class="id">_</span> [] <span class="id">_</span> [] <span class="id">H_p</span>' <span class="id">_</span>];[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_r0</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span>|].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_p_gt</span>;<span class="id">rewrite</span> -<span class="id">H_p0</span> <span class="id">H_p</span>' <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_Pg</span> <span class="id">H_NPg0</span>}[<span class="id">n</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_change</span>]]]]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id"><a href="Algorand.safety_helpers.html#path_gsteps_onth">path_gsteps_onth</a></span> <span class="id">H_path</span> <span class="id">H_g</span> <span class="id">H_NPg0</span> <span class="id">H_Pg</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<span class="id">g1</span>,<span class="id">g2</span>;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#transition_from_path">transition_from_path</a></span> <span class="id">H_path</span>) <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in2</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_change</span> =&gt; [] <span class="id">_</span>;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] <span class="id">eqn</span>:<span class="id">H_u2</span> =&gt; <span class="id">H_P2</span>;[<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u2</span>|].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#in_mem">in_mem</a></span> /= /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#pred_of_finmap">pred_of_finmap</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#gtrans_preserves_users">gtrans_preserves_users</a></span> <span class="id">H_step</span>).<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span> <span class="id">H_change</span> <span class="id">H_in1</span> <span class="id">H_in2</span> <span class="id">H_p_gt</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">H_step</span>);<span class="id">try</span> <span class="kwd">by</span> <span class="id">exfalso</span>;<span class="id">move</span>: <span class="id">H_change</span> =&gt; [] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="id">move</span>: <span class="id">H_change</span> =&gt; [] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">gtransition_unfold</span>;<span class="id">unfold</span> <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> // (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_in1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:(<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>]) =&gt; <span class="id">u</span>;<span class="id">destruct</span> <span class="id">u</span>,<span class="id">corrupt</span>;<span class="id">exact</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_change</span> =&gt; [] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> {1}/<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> /<span class="id">P</span> /<span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_eq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">A</span> /<span class="id">A</span>{<span class="id">A</span>}].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key_ustate</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">key_ustate</span>] : <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>) <span class="kwd">as</span> <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_pre</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_r</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">key_ustate</span>, <span class="id">H_in2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span> <span class="kwd">in</span> <span class="id">Hequ</span>; <span class="id">rewrite</span> <span class="id">Hequ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">ustate1</span> <span class="id">ustate2</span>; <span class="id">subst</span> <span class="id">ustate1</span> <span class="id">ustate2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#getf_set">getf_set</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) (<span class="id">r</span>,<span class="id">p</span>,0)) <span class="kwd">as</span> <span class="id">H_step_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_step</span>}<span class="id">H_after</span> : <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">u</span> <span class="id">ustate_post</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#gtr_rps_non_decreasing">gtr_rps_non_decreasing</a></span> <span class="id">H_step</span> (<span class="id">uid</span>:=<span class="id">uid</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">symmetry</span> <span class="kwd">in</span> <span class="id">Hequ</span>;<span class="id">rewrite</span> <span class="id">Hequ</span>;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#ustate_after_iff_step_le">ustate_after_iff_step_le</a></span> <span class="kwd">in</span> <span class="id">H_after</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_after</span> =&gt;[|[<span class="id">a</span> <span class="id">b</span>]];[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_r</span>;<span class="id">left</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">a</span>|<span class="id">left</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">b</span>=&gt;[|[<span class="id">b</span> <span class="id">_</span>]];[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_p</span>|<span class="id">exfalso</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H_pre</span>;<span class="id">rewrite</span> <span class="id">a</span> <span class="id">b</span> <span class="id">H_r</span> <span class="id">H_p</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>;<span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>)=<span class="id">ustate_post</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) /\ <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate_post</span> = (<span class="id">r</span>,<span class="id">p</span>,1) <span class="kwd">by</span> <span class="id">tauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<span class="id">destruct</span> <span class="id">H1</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">Heqresult</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">ustate_post</span> <span class="id">sent</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">destruct</span> <span class="id">H_pre</span>;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_r</span> <span class="id">H_p</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;adv_period_open_result&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_p</span> <span class="id">H_r</span>;<span class="id">simpl</span> =&gt; -&gt; -&gt;;<span class="id">clear</span>;<span class="id">split</span>;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;adv_period_val_result&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_p</span> <span class="id">H_r</span>;<span class="id">simpl</span> =&gt; -&gt; -&gt;;<span class="id">clear</span>;<span class="id">split</span>;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="comment">(*&nbsp;certify&nbsp;result&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id">H_p</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> <span class="kwd">in</span> <span class="id">H_p_gt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_pre</span>;<span class="id">rewrite</span> -<span class="id">H_r</span> -<span class="id">H_p</span> /<span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">repeat</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|[|- <span class="id">context</span> <span class="id">X</span> [<span class="kwd">match</span> ?<span class="id">x</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_change</span> =&gt; [] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> {1}/<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /<span class="id">P</span> /<span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span> == <span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_eq</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">A</span> /<span class="id">A</span> {<span class="id">A</span>}].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ustate_key</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">ustate_key</span>] : <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>) <span class="kwd">as</span> <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_pre</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_r</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H_p</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">ustate_key</span>, <span class="id">H_in2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span> <span class="kwd">in</span> <span class="id">Hequ</span>; <span class="id">rewrite</span> <span class="id">Hequ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">ustate1</span> <span class="id">ustate2</span>; <span class="id">subst</span> <span class="id">ustate1</span> <span class="id">ustate2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#getf_set">getf_set</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) (<span class="id">r</span>,<span class="id">p</span>,0)) <span class="kwd">as</span> <span class="id">H_step_lt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_step</span>}<span class="id">H_after</span> : <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">u</span> <span class="id">ustate_post</span> <span class="kwd">by</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#gtr_rps_non_decreasing">gtr_rps_non_decreasing</a></span> <span class="id">H_step</span> (<span class="id">uid</span>:=<span class="id">uid</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">symmetry</span> <span class="kwd">in</span> <span class="id">Hequ</span>;<span class="id">rewrite</span> <span class="id">Hequ</span>;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#ustate_after_iff_step_le">ustate_after_iff_step_le</a></span> <span class="kwd">in</span> <span class="id">H_after</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_after</span> =&gt;[|[<span class="id">a</span> <span class="id">b</span>]];[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_r</span>;<span class="id">left</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">a</span>|<span class="id">left</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">b</span>=&gt;[|[<span class="id">b</span> <span class="id">_</span>]];[<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_p</span>|<span class="id">exfalso</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H_pre</span>;<span class="id">rewrite</span> <span class="id">a</span> <span class="id">b</span> <span class="id">H_r</span> <span class="id">H_p</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>;<span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span>: <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>)=<span class="id">ustate_post</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) /\ <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate_post</span> = (<span class="id">r</span>,<span class="id">p</span>,1) <span class="kwd">by</span> <span class="id">tauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">result</span>;<span class="id">destruct</span> <span class="id">H0</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>:<span class="id">Heqresult</span> =&gt; ? ?;<span class="id">subst</span> <span class="id">ustate_post</span> <span class="id">sent</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">destruct</span> <span class="id">H_pre</span>;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_r</span> <span class="id">H_p</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>. <span class="id">move</span>: <span class="id">H_change</span> =&gt; [] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#corrupt_user_result">corrupt_user_result</a></span>, <span class="id">P</span>, <span class="id"><a href="Algorand.safety_helpers.html#upred">upred</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid</span>==<span class="id">uid0</span>) <span class="id">eqn</span>:<span class="id">H_eq</span>;[|<span class="kwd">by</span> <span class="id">apply</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ustate_key</span>).<br/>
Qed.</div>
<br/>
<div class="doc">An honest node can enter period <span class="bracket"><span class="id">p</span>' &gt; 1</span> only if at least one honest node
participated in period <span class="bracket"><span class="id">p</span>' - 1</span>. Note that we freeze the state of corrupt
users, so any user whose period actually advanced must have been honest
at the time. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="adv_period_from_honest_in_prev">adv_period_from_honest_in_prev</a></span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r0</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r0</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> &gt; 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r0</span> &lt;= <span class="id">r</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.safety.html#period_advance_at">period_advance_at</a></span> <span class="id">n</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">g1</span> <span class="id">g2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">uid</span>', <span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span> <span class="id">r</span> (<span class="id">p</span>.-1) <span class="id">uid</span>' <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_p</span> <span class="id">H_r</span> [<span class="id">g1</span> [<span class="id">g2</span> <span class="id">H_adv</span>]].<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#period_advance_only_by_next_votes">period_advance_only_by_next_votes</a></span> <span class="kwd">in</span> <span class="id">H_adv</span>;[|<span class="id">eassumption</span>..].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_adv</span> <span class="kwd">as</span> (<span class="id">s</span> &amp; <span class="id">v</span> &amp; <span class="id">next_voters</span> &amp; <span class="id">H_voters_cred</span> &amp; <span class="id">H_voters_size</span> &amp; <span class="id">_</span> &amp; ?).<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_n</span> : <span class="id">n</span>.+2 &gt; 0) <span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="kwd">exists</span> <span class="id">honest_voter</span>, <span class="id">honest_voter</span> \<span class="kwd">in</span> <span class="id">next_voters</span> /\ <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>.-1,<span class="id">s</span>) <span class="id">honest_voter</span> <span class="id">trace</span>) <span class="kwd">as</span> (<span class="id">uid_honest</span> &amp; <span class="id">H_honest_voter</span> &amp; <span class="id">H_honest</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">destruct</span> <span class="id">v</span>;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_voters_size</span>;[<span class="id">eapply</span> <span class="id"><a href="Algorand.quorums.html#quorum_v_has_honest">quorum_v_has_honest</a></span>|<span class="id">eapply</span> <span class="id"><a href="Algorand.quorums.html#quorum_b_has_honest">quorum_b_has_honest</a></span>];<span class="id">eassumption</span>).<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_voters_size</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">uid_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">uid_honest</span> <span class="id">H_honest_voter</span>).<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#received_next_vote">received_next_vote</a></span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">msg_bit</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">match</span> <span class="id">v</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">uid_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">uid_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">d</span> <span class="id">H</span>].<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H</span>) <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_r_eq</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg_bit</span> = <span class="id">r</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id">msg_bit</span> /=; <span class="id">destruct</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_r_eq</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H1</span> <span class="id">H_r</span>).<br/>
&nbsp;&nbsp;<span class="id">cbn</span> -[<span class="id">user_sent</span> <span class="id">step_in_path_at</span> <span class="id">msg_step</span>] <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">lapply</span> <span class="id">H1</span>;[<span class="id">clear</span> <span class="id">H1</span>|<span class="id">destruct</span> <span class="id">v</span>;<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;<span class="id">intros</span> (<span class="id">ix</span> &amp; <span class="id">g1</span> &amp; <span class="id">g2</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_sent</span>).<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span>;<span class="kwd">exists</span> <span class="id">ix</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_onth</span>:= <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_user_in</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_sent</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_uid_eq</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg_bit</span> = <span class="id">uid_honest</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id">msg_bit</span> /=; <span class="id">destruct</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_uid_eq</span> <span class="kwd">in</span> <span class="id">H_user_in</span>,<span class="id">H_sent</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_user_in</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_start_label</span> := <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_sent</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_user_in</span>).<br/>
&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;Honest&nbsp;at&nbsp;ix&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">suff</span>: (<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid_honest</span> <span class="id">g1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#user_honest_from_during">user_honest_from_during</a></span> <span class="id">H_path</span> <span class="id">H_onth</span> (<span class="id">H_in</span>:=<span class="id">H_user_in</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_start_label</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_during_le">honest_during_le</a></span> .<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">v</span>;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_user_in</span>]) <span class="id">H_start_label</span> =&gt; <span class="id">u</span>. <span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">u</span>, <span class="id">v</span>;<span class="id">case</span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<h2> Users cannot nextvote for both a value and bottom </h2>
<br/>
<div class="doc">If there is a quorum of voters for the value <span class="bracket"><span class="id">v</span></span>,
then there cannot be a quorum of voters for bottom. </div>
<span class="kwd">Definition</span> <span class="id"><a name="period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> (<span class="id">v</span>:<span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>) (<span class="id">r</span> <span class="id">p</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">trace</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s</span> (<span class="id">voters</span>: {<span class="id">fset</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>}),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">voters</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#tau_v">tau_v</a></span> &lt;= #|` <span class="id">voters</span> | -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>',<br/>
&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">u</span> \<span class="kwd">in</span> <span class="id">voters</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">u</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#nextvoted_val_in_path">nextvoted_val_in_path</a></span> <span class="id">trace</span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">v</span>')<br/>
&nbsp;&nbsp;&nbsp;-&gt; <span class="id">v</span>' = <span class="id">v</span>) /\<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s</span> (<span class="id">voters</span>: {<span class="id">fset</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>}),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">voters</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#tau_b">tau_b</a></span> &lt;= #|` <span class="id">voters</span> | -&gt;<br/>
&nbsp;&nbsp;&nbsp;~(<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">u</span> \<span class="kwd">in</span> <span class="id">voters</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">u</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#nextvoted_bot_in_path">nextvoted_bot_in_path</a></span> <span class="id">trace</span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>)).<br/>
<br/>
<div class="doc">If all users nextvote for <span class="bracket"><span class="id">v</span></span> and all users did not nextvote for bottom, then
<span class="bracket"><span class="id">period_nextvoted_exclusively_for</span></span> holds. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="period_nextvoted_exclusively_from_nextvotes">period_nextvoted_exclusively_from_nextvotes</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> (<span class="id">H_p_gt</span>: 1 &lt; <span class="id">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v</span><br/>
&nbsp;&nbsp;(<span class="id">H_nextvote_val</span> : <span class="kwd">forall</span> (<span class="id">uid</span> : <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) (<span class="id">s</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v</span>' : <span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#nextvoted_val_in_path">nextvoted_val_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_no_nextvotes_open</span> : <span class="kwd">forall</span> (<span class="id">uid</span> : <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) (<span class="id">s</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>, <span class="id">p</span>, <span class="id">s</span>) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id"><a href="Algorand.quorums.html#nextvoted_bot_in_path">nextvoted_bot_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
&nbsp;&nbsp;<span class="id">split</span> =&gt; <span class="id">s</span> <span class="id">voters</span> <span class="id">H_creds</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;nextvote_val&nbsp;quorums&nbsp;all&nbsp;voted&nbsp;for&nbsp;v&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">honest_voter</span> [<span class="id">H_hv_in</span> <span class="id">H_hv_honest</span>]]:= <span class="id"><a href="Algorand.quorums.html#quorum_v_has_honest">quorum_v_has_honest</a></span> <span class="id">trace</span> <span class="id">H_creds</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">v</span>' /(<span class="id">_</span> <span class="id">_</span> <span class="id">H_hv_in</span> <span class="id">H_hv_honest</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id">H_nextvote_val</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;no&nbsp;nextvote_open&nbsp;quorums&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">honest_voter</span> [<span class="id">H_hv_in</span> <span class="id">H_hv_honest</span>]]:= <span class="id"><a href="Algorand.quorums.html#quorum_b_has_honest">quorum_b_has_honest</a></span> <span class="id">trace</span> <span class="id">H_creds</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_hv_in</span> <span class="id">H_hv_honest</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id">H_no_nextvotes_open</span>: <span class="id">H_hv_honest</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">period_nextvoted_exclusively_for</span></span> disallows <span class="bracket"><span class="id">nextvote_bottom_quorum</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="no_bottom_quorums_during_from_nextvoted_excl">no_bottom_quorums_during_from_nextvoted_excl</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">p</span> <span class="id">v</span> (<span class="id">H_excl</span>: <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">ix</span> <span class="id">g</span> (<span class="id">H_g</span>: <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span>)<br/>
&nbsp;&nbsp;<span class="id">uid</span> <span class="id">u</span> (<span class="id">H_u</span>: <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_r</span>: <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">r</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_p</span>: <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">p</span>.+1):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>, ~ <span class="id"><a href="Algorand.algorand_model.html#nextvote_bottom_quorum">nextvote_bottom_quorum</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
<div>&nbsp;<span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_bottom_quorum">nextvote_bottom_quorum</a></span> =&gt; <span class="id">s</span> <span class="id">H_bot_quorum</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_excl</span> =&gt; [<span class="id">_</span> /(<span class="id">_</span> <span class="id">s</span> (<span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>)) <span class="id">H_no_bot_votes</span>].<br/>
&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_no_bot_votes</span> (<span class="id"><a href="Algorand.safety.html#nextvote_open_credentials_checked">nextvote_open_credentials_checked</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g</span> <span class="id">H_u</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>) <span class="id">p</span> <span class="id">s</span>)).<br/>
&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H_no_bot_votes</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_bot_quorum</span>;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#card_fseq">card_fseq</a></span> <span class="id"><a href="Algorand.safety_helpers.html#finseq_size">finseq_size</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;<span class="id">move</span>=&gt;<span class="id">bot_voter</span>;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#nextvoters_open_for">nextvoters_open_for</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span> /= =&gt; <span class="id">H_bv_in</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id">have</span>[<span class="id">d</span> <span class="id">H_recv</span>]:= <span class="id"><a href="Algorand.safety.html#received_nextvote_open">received_nextvote_open</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g</span> <span class="id">H_u</span> <span class="id">H_bv_in</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/(<span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_recv</span>).<br/>
Qed.</div>
<br/>
<h2> Lemmas for entering period with starting value </h2>
<br/>
<div class="doc">If users enter exclusively for <span class="bracket"><span class="id">v</span></span> and <span class="bracket"><span class="id">u</span></span> advances to <span class="bracket"><span class="id">p</span> + 1</span>, then <span class="bracket"><span class="id">u</span></span>'s starting
value at <span class="bracket"><span class="id">p</span> + 1</span> is <span class="bracket"><span class="id">v</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_at_entry_from_excl">stv_at_entry_from_excl</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>:<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> <span class="id">v</span> (<span class="id">H_excl</span>: <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix</span> <span class="id">uid</span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_adv</span>: <span class="id"><a href="Algorand.safety.html#period_advance_at">period_advance_at</a></span> <span class="id">ix</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span>.+1 <span class="id">g1</span> <span class="id">g2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">u</span> (<span class="id">H_u</span>: <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>.+1] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_excl</span> <span class="id">H_adv</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id"><a href="Algorand.safety.html#period_advance_only_by_next_votes">period_advance_only_by_next_votes</a></span> <span class="id">H_path</span> <span class="id">H_start</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>) <span class="id">H_adv</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">nv_step</span> [<span class="id">v0</span> [<span class="id">voters</span> [<span class="id">H_creds</span> [<span class="id">H_size</span> [<span class="id">H_stv</span> <span class="id">H_voters_voted</span>]]]]]].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_stv</span> =&gt; [<span class="id">u</span>' [<span class="id">H_u</span>' <span class="id">H_u</span>'<span class="id">_stv</span>]].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_u</span>';<span class="id">rewrite</span> <span class="id">H_u</span>;<span class="id">case</span> =&gt; ?;<span class="id">subst</span> <span class="id">u</span>'.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_u</span>'<span class="id">_stv</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">v0</span> <span class="kwd">as</span> [<span class="id">v0</span>|].<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;nextvote_val&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#f_equal">f_equal</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#proj1">proj1</a></span> <span class="id">H_excl</span> <span class="id">nv_step</span> <span class="id">voters</span> <span class="id">H_creds</span> <span class="id">H_size</span> <span class="id">v0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">voter</span> <span class="id">H_voter_in</span> <span class="id">H_voter_honest</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_voters_voted</span> <span class="id">_</span> <span class="id">H_voter_in</span>) =&gt; [<span class="id">d</span> <span class="id">H_recv</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_recv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>) <span class="id">H_voter_honest</span>).<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;nextvote_open&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> ((<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#proj2">proj2</a></span> <span class="id">H_excl</span>) <span class="id">nv_step</span> <span class="id">voters</span> <span class="id">H_creds</span> <span class="id">H_size</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">voter</span> <span class="id">H_voter_in</span> <span class="id">H_voter_honest</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_voters_voted</span> <span class="id">_</span> <span class="id">H_voter_in</span>) =&gt; [<span class="id">d</span> <span class="id">H_recv</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_recv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>) <span class="id">H_voter_honest</span>).<br/>
Qed.</div>
<br/>
<div class="doc">If users enter exclusively for <span class="bracket"><span class="id">v</span></span> in <span class="bracket"><span class="id">r</span>, <span class="id">p</span> - 1</span> and <span class="bracket"><span class="id">u</span></span> sends a message at <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span>, then
<span class="bracket"><span class="id">u</span></span>'s starting value at <span class="bracket"><span class="id">p</span></span> is <span class="bracket"><span class="id">v</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_at_send_from_excl">stv_at_send_from_excl</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>:<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">p</span> (<span class="id">H_p_gt</span>: 1 &lt; <span class="id">p</span>)<br/>
&nbsp;&nbsp;<span class="id">v</span> (<span class="id">H_excl</span>: <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">ix</span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_step</span>: <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">uid</span> <span class="id">msg</span> (<span class="id">H_send</span> : <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_r_msg</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span> = <span class="id">r</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_p_msg</span>: <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> <span class="id">msg</span> = <span class="id">p</span>)<br/>
&nbsp;&nbsp;<span class="id">u</span> (<span class="id">H_u</span>: <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span>) :<br/>
&nbsp;<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_sent_at</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">msg</span> <span class="kwd">by</span> <span class="kwd">exists</span> <span class="id">g1</span>, <span class="id">g2</span>;<span class="id">split</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_honest_in</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_honest_in_from_send">user_honest_in_from_send</a></span> <span class="id">H_sent_at</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_r_msg</span> <span class="id">H_p_msg</span> <span class="kwd">in</span> <span class="id">H_honest_in</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:(<span class="id"><a href="Algorand.safety.html#honest_in_period_entered">honest_in_period_entered</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_honest_in</span>) =&gt; [<span class="id">ix_entry</span> [<span class="id">ge1</span> [<span class="id">ge2</span> <span class="id">H_entry</span>]]].<br/>
&nbsp;&nbsp;<span class="id">move</span>:(<span class="id">H_entry</span>) =&gt; [<span class="id">_</span> [<span class="id">_</span> [<span class="id">ukey2</span> [<span class="id">_</span> [<span class="id">_</span> <span class="id">H_ue_step</span>]]]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_ue</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ukey2</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">ue</span>:<span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := <span class="id">ge2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) [`<span class="id">ukey2</span>] <span class="kwd">in</span> <span class="id">H_ue</span> <span class="id">H_ue_step</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_ue_step</span> =&gt; [<span class="id">H_r_ue</span> <span class="id">H_p_ue</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_stv_entry</span>: <span class="id">ue</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">p</span>](<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_predK">ltn_predK</a></span> <span class="id">H_p_gt</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">refine</span> (<span class="id"><a href="Algorand.safety.html#stv_at_entry_from_excl">stv_at_entry_from_excl</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_excl</span> <span class="id">_</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ukey2</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_predK">ltn_predK</a></span> <span class="id">H_p_gt</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_reach</span>: <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">ge2</span> <span class="id">g1</span> <span class="kwd">by</span> <span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#post_enter_reaches_sent">post_enter_reaches_sent</a></span>;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>[<span class="id">H_r_u</span> <span class="id">H_p_u</span> <span class="id">_</span>] := <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_send</span> <span class="id">H_u</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">symmetry</span>;<span class="id">rewrite</span> -<span class="id">H_stv_entry</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#stv_forward">stv_forward</a></span> <span class="id">H_reach</span> <span class="id">H_ue</span> <span class="id">H_u</span>);<span class="id">congruence</span>.<br/>
Qed.</div>
<br/>
<h2> Vote uniqueness based on value nextvoted in previous period </h2>
<br/>
<div class="doc">If all honest nodes that entered a period <span class="bracket"><span class="id">p</span> - 1 &gt;= 2</span> did so exclusively for
value <span class="bracket"><span class="id">v</span></span>, then an honest node cannot cert-vote for any value other than <span class="bracket"><span class="id">v</span></span> in step
2 of period <span class="bracket"><span class="id">p</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="prev_period_nextvotes_limits_honest_soft_vote">prev_period_nextvotes_limits_honest_soft_vote</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">p</span> (<span class="id">H_p_gt</span>: 1 &lt; <span class="id">p</span>)<br/>
&nbsp;&nbsp;<span class="id">v</span> (<span class="id">H_excl</span>: <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">trace</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span>, <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,2) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>', <span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">H_honest</span> <span class="id">v</span>' [<span class="id">ix</span> <span class="id">H_voted</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_voted</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_send</span>]]].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_u</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>).<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u</span>: <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>] <span class="kwd">in</span> <span class="id">H_u</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">stv_fwd</span> : <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id"><a href="Algorand.safety.html#stv_at_send_from_excl">stv_at_send_from_excl</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_excl</span> <span class="id">H_step</span> <span class="id">H_send</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#erefl">erefl</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#erefl">erefl</a></span> <span class="id">H_u</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span>:=<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_send</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> =&gt; -/= [<span class="id">H_r_u</span> <span class="id">H_p_u</span> <span class="id">_</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">no_bot_quroums</span>: <span class="kwd">forall</span> <span class="id">s</span>, ~<span class="id"><a href="Algorand.algorand_model.html#nextvote_bottom_quorum">nextvote_bottom_quorum</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">s</span>. {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">p</span>](<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_predK">ltn_predK</a></span> <span class="id">H_p_gt</span>) <span class="kwd">in</span> <span class="id">H_p_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#no_bottom_quorums_during_from_nextvoted_excl">no_bottom_quorums_during_from_nextvoted_excl</a></span>;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">case</span>:(<span class="id"><a href="Algorand.safety.html#softvote_precondition">softvote_precondition</a></span> <span class="id">H_send</span> <span class="id">H_u</span>).<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;softvote_new&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#softvote_new_ok">softvote_new_ok</a></span> =&gt; -[<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [[]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#cert_may_exist">cert_may_exist</a></span> <span class="id">H_r_u</span> <span class="id">H_p_u</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subn1">subn1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;softvote_repr&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#softvote_repr_ok">softvote_repr_ok</a></span> =&gt; -[<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [[<span class="id">H_cert</span> <span class="id">_</span>]|[<span class="id">_</span> <span class="id">H_stv</span>']].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>:<span class="id">H_cert</span>;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#cert_may_exist">cert_may_exist</a></span> <span class="id">H_r_u</span> <span class="id">H_p_u</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subn1">subn1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>:<span class="id">H_stv</span>';<span class="id">rewrite</span> <span class="id">stv_fwd</span> =&gt; -[&lt;-].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">If all honest nodes that entered a period <span class="bracket"><span class="id">p</span> &gt;= 2</span> did so exclusively for
value <span class="bracket"><span class="id">v</span></span>, then an honest node cannot cert-vote for any value other than <span class="bracket"><span class="id">v</span></span> in step
3 of period <span class="bracket"><span class="id">p</span>'</span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="prev_period_nextvotes_limits_cert_vote">prev_period_nextvotes_limits_cert_vote</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>),<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>) ,<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, 1 &lt; <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>, <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">v</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,3) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#certvoted_in_path">certvoted_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g0</span> <span class="id">trace</span> <span class="id">H_path</span> <span class="id">r</span> <span class="id">H_start</span> <span class="id">p</span> <span class="id">H_p</span> <span class="id">v</span> <span class="id">H_excl</span> <span class="id">uid</span> <span class="id">v</span>' <span class="id">H_honest</span> <span class="id">H_vote</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_vote</span> <span class="kwd">as</span> [<span class="id">ix_cert</span> <span class="id">H_vote</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_honest_in</span>:= <span class="id"><a href="Algorand.safety_helpers.html#user_honest_in_from_send">user_honest_in_from_send</a></span> <span class="id">H_vote</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_vote</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_vote</span> <span class="kwd">as</span> (<span class="id">g1_v</span> &amp; <span class="id">g2_v</span> &amp; <span class="id">H_vote_step</span> &amp; <span class="id">H_vote_send</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g2</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_vote_step</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_in</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g2_v</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_vote_send</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_u</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u</span>: <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := (<span class="id">g2_v</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_in</span>]) <span class="kwd">in</span> <span class="id">H_u</span>.<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_softvotes_for_v</span> := <span class="id"><a href="Algorand.safety.html#prev_period_nextvotes_limits_honest_soft_vote">prev_period_nextvotes_limits_honest_soft_vote</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p</span> <span class="id">H_excl</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">H_in_certvals</span> <span class="id">_</span>]:= <span class="id"><a href="Algorand.safety.html#certvote_postcondition">certvote_postcondition</a></span> <span class="id">H_vote_send</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span> <span class="kwd">in</span> <span class="id">H_in_certvals</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_creds</span> := <span class="id"><a href="Algorand.safety.html#softvote_credentials_checked">softvote_credentials_checked</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g2</span> <span class="id">H_u</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>) <span class="id">v</span>' <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_in_certvals</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span> /<span class="id"><a href="Algorand.algorand_model.html#soft_weight">soft_weight</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_size</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">uid_sv</span> [<span class="id">H_in_sv</span> <span class="id">H_sv_honest</span>]] := <span class="id"><a href="Algorand.quorums.html#quorum_s_has_honest">quorum_s_has_honest</a></span> <span class="id">trace</span> <span class="id">H_creds</span> <span class="id">H_size</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">H_softvotes_for_v</span> <span class="id">_</span> <span class="id">H_sv_honest</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> [<span class="id">d</span> <span class="id">H_recv</span>]: <span class="kwd">exists</span> <span class="id">d</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">uid</span> <span class="id">d</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Softvote">Softvote</a></span> (<span class="id"><a href="Algorand.algorand_model.html#val">val</a></span> <span class="id">v</span>') <span class="id">r</span> <span class="id">p</span> <span class="id">uid_sv</span>) <span class="id">trace</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_in_sv</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> /= [[<span class="id">x_uid</span> <span class="id">x_v</span>] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_in_x</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> ? /= ?]];<span class="id">subst</span> <span class="id">x_uid</span> <span class="id">x_v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety.html#received_softvote">received_softvote</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g2</span> <span class="id">H_u</span> <span class="id">H_in_x</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>)).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety.html#received_was_sent">received_was_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_recv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>) <span class="id">H_sv_honest</span>).<br/>
Qed.</div>
<br/>
<h2> Lemmas for propagating value nextvoted for from previous period </h2>
<br/>
<div class="doc">In <span class="bracket"><span class="id">p</span> - 1</span>, all nextvotes were for <span class="bracket"><span class="id">v</span></span>, and at step 2 in <span class="bracket"><span class="id">p</span></span>, all softvotes were for
<span class="bracket"><span class="id">v</span></span>, then at all steps in <span class="bracket"><span class="id">p</span></span>, all nextvotes were for <span class="bracket"><span class="id">v</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="nextvotes_val_follow_softvotes">nextvotes_val_follow_softvotes</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> (<span class="id">H_p_gt</span>: 1 &lt; <span class="id">p</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v</span> (<span class="id">H_excl</span>: <span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">trace</span>):<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">uid_sv</span> : <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,2) <span class="id">uid_sv</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>', <span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span> <span class="id">trace</span> <span class="id">uid_sv</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">uid_nv</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">uid_nv</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>', <span class="id"><a href="Algorand.quorums.html#nextvoted_val_in_path">nextvoted_val_in_path</a></span> <span class="id">trace</span> <span class="id">uid_nv</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_softvotes</span> <span class="id">uid_nv</span> <span class="id">s</span> <span class="id">H_honest_nv</span> <span class="id">v</span>' [<span class="id">ix_nv</span> <span class="id">H_nextvoted</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_nextvoted</span>) =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step_nv</span> <span class="id">H_send_nv</span>]]].<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_in1</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send_nv</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_u1</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_in1</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u1</span> : <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>] <span class="kwd">in</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix_nv</span> <span class="id">trace</span> <span class="id">uid_nv</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span>' <span class="id">s</span>) <span class="id">r</span> <span class="id">p</span> <span class="id">uid_nv</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">H_nextvoted</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">case</span>:(<span class="id"><a href="Algorand.safety.html#nextvote_val_precondition">nextvote_val_precondition</a></span> <span class="id">H_send_nv</span> <span class="id">H_u1</span>).<br/>
&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_softvotes_for_v</span> := <span class="id"><a href="Algorand.safety.html#prev_period_nextvotes_limits_honest_soft_vote">prev_period_nextvotes_limits_honest_soft_vote</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_excl</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step_nv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_creds</span> := <span class="id"><a href="Algorand.safety.html#softvote_credentials_checked">softvote_credentials_checked</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g1</span> <span class="id">H_u1</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">_</span>) <span class="id">v</span>' <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span> /<span class="id"><a href="Algorand.algorand_model.html#soft_weight">soft_weight</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_size</span> <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">uid_sv</span> [<span class="id">H_in_sv</span> <span class="id">H_sv_honest</span>]] := <span class="id"><a href="Algorand.quorums.html#quorum_s_has_honest">quorum_s_has_honest</a></span> <span class="id">trace</span> <span class="id">H_creds</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">H_softvotes_for_v</span> <span class="id">_</span> <span class="id">H_sv_honest</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/(<span class="id"><a href="Algorand.safety.html#softvotes_sent">softvotes_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g1</span> <span class="id">H_u1</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>)): <span class="id">H_sv_honest</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_in_sv</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> /= [] <span class="id">x</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_x_in</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#matchValue">matchValue</a></span>. <span class="id">destruct</span> <span class="id">x</span>. <span class="id">move</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> ? /= ?;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
<br/>
&nbsp;&nbsp;* <span class="id">move</span> =&gt; [<span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety.html#stv_at_send_from_excl">stv_at_send_from_excl</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_excl</span> <span class="id">H_step_nv</span> <span class="id">H_send_nv</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#erefl">erefl</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#erefl">erefl</a></span> <span class="id">H_u1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt; -&gt;.<br/>
Qed.</div>
<br/>
<div class="doc">If users enter exclusively for <span class="bracket"><span class="id">v</span></span> in <span class="bracket"><span class="id">p</span> - 1</span>, then users enter exclusively for <span class="bracket"><span class="id">v</span></span> in <span class="bracket"><span class="id">p</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="excl_enter_excl_next">excl_enter_excl_next</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>),<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>),<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">p</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v</span> : <span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;1 &lt; <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.-1 <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g0</span> <span class="id">trace</span> <span class="id">H_path</span> <span class="id">r</span> <span class="id">H_start</span> <span class="id">p</span> <span class="id">v</span> <span class="id">H_p_gt</span> <span class="id">H_prev_excl</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_prev_excl</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_honest_softvotes</span>: <span class="kwd">forall</span> <span class="id">uid</span>, <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,2) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>', <span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v</span>' = <span class="id">v</span><br/>
&nbsp;&nbsp;&nbsp;:= <span class="id"><a href="Algorand.safety.html#prev_period_nextvotes_limits_honest_soft_vote">prev_period_nextvotes_limits_honest_soft_vote</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_prev_excl</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_nextvote_val_respects</span>: <span class="kwd">forall</span> <span class="id">uid</span> <span class="id">s</span> <span class="id">v</span>', <span class="id"><a href="Algorand.quorums.html#nextvoted_val_in_path">nextvoted_val_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">v</span>' -&gt; <span class="id">v</span>' = <span class="id">v</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>:= (<span class="id"><a href="Algorand.safety.html#nextvotes_val_follow_softvotes">nextvotes_val_follow_softvotes</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p_gt</span> <span class="id">H_prev_excl</span> <span class="id">H_honest_softvotes</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H</span> <span class="id">uid</span> <span class="id">s</span> <span class="id">v</span>' <span class="id">H_voted</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id">H</span>: (<span class="id">H_voted</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_voted</span> =&gt; [<span class="id">ix</span> <span class="id">H_voted</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_during_from_sent">honest_during_from_sent</a></span> <span class="id">H_path</span> <span class="id">H_voted</span>).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_no_nextvotes_open</span>: <span class="kwd">forall</span> <span class="id">uid</span> <span class="id">s</span>, <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">uid</span> <span class="id">trace</span> -&gt; ~<span class="id"><a href="Algorand.quorums.html#nextvoted_bot_in_path">nextvoted_bot_in_path</a></span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">s</span> <span class="id">H_honest</span> [<span class="id">ix</span> [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_vote</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_u</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_g1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> := <span class="id"><a href="Algorand.safety.html#nextvote_open_precondition">nextvote_open_precondition</a></span> <span class="id">H_vote</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] /(<span class="id">_</span> <span class="id">H_p_gt</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>:=<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_vote</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> =&gt; -/=[<span class="id">H_r_u</span> <span class="id">H_p_u</span> <span class="id">H_s_u</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subn1">subn1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety.html#no_bottom_quorums_during_from_nextvoted_excl">no_bottom_quorums_during_from_nextvoted_excl</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_prev_excl</span> <span class="id">H_g1</span> <span class="id">H_u</span> <span class="id">H_r_u</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_predK">ltn_predK</a></span> <span class="id">H_p_gt</span>).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/(<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_from_nextvotes">period_nextvoted_exclusively_from_nextvotes</a></span> <span class="id">H_path</span>).<br/>
Qed.</div>
<br/>
<h2> Propagate certificate information forward </h2>
<br/>
<div class="doc">Cert info from <span class="bracket"><span class="id">saw_v</span></span> at <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> remains true at <span class="bracket"><span class="id">g1</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="certinfo_forward">certinfo_forward</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">p</span> <span class="id">v</span> <span class="id">uid</span> (<span class="id">H_saw</span>: <span class="id"><a href="Algorand.quorums.html#saw_v">saw_v</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">uid</span>)<br/>
&nbsp;&nbsp;<span class="id">ix</span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_step</span>: <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">u</span> (<span class="id">H_u</span>: <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span>)<br/>
&nbsp;&nbsp;<span class="id">msg</span> (<span class="id">H_send</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>)<br/>
&nbsp;&nbsp;(<span class="id">H_u_step</span>: <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id">r</span>,<span class="id">p</span>,4) (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span>)):<br/>
&nbsp;&nbsp;<span class="id">v</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span><br/>
&nbsp;&nbsp;/\ <span class="kwd">exists</span> <span class="id">b</span>, <span class="id">b</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span> <span class="id">u</span> <span class="id">r</span> /\ <span class="id"><a href="Algorand.algorand_model.html#valid_block_and_hash">valid_block_and_hash</a></span> <span class="id">b</span> <span class="id">v</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_saw</span> =&gt; /(@<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">trace</span>)=&gt; -[<span class="id">g_mid</span> <span class="id">H_g_mid</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> =&gt; // <span class="id">key_mid</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u_mid</span>: <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := <span class="id">g_mid</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_mid</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>[<span class="id">H_v_certval_mid</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>[<span class="id">H_blocks_mid</span>] /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span> <span class="id">H_mid_step_le</span>].<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_g1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">key1</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>) <span class="kwd">in</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_u</span> =&gt; ?;<span class="id">subst</span> <span class="id">u</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u</span> := <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key1</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g_mid</span> <span class="id">g1</span>) <span class="kwd">as</span> <span class="id">H_reach</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#index">index</a></span> <span class="id">g_mid</span> <span class="id">trace</span> &lt;= <span class="id">ix</span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#order_ix_from_steps">order_ix_from_steps</a></span> <span class="id">H_path</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_index">onth_index</a></span> <span class="id">H_g_mid</span>) (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">H</span> <span class="id">_</span> <span class="id">key_mid</span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>)).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_le_lt_trans">step_le_lt_trans</a></span> <span class="id">H_mid_step_le</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>:= (<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_end">utransition_label_end</a></span> <span class="id">H_send</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>))).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#step_le_lt_trans">step_le_lt_trans</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span> <span class="id">H_path</span> <span class="id">H</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_index">onth_index</a></span> <span class="id">H_g_mid</span>) (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>)).<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_softvotes_advance</span> := <span class="id"><a href="Algorand.safety_helpers.html#softvotes_monotone">softvotes_monotone</a></span> <span class="id">H_reach</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key_mid</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">v</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span> <span class="id">u</span> <span class="id">r</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_v_certval_mid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_size_mid</span> <span class="id">H_votes_mid</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_trans">leq_trans</a></span> <span class="id">H_size_mid</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubset_leq_card">fsubset_leq_card</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#subset_imfset">subset_imfset</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">x</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">x_mem</span> <span class="id">x_prop</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="id">split</span>;[|<span class="id">exact</span> <span class="id">x_prop</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id">H_softvotes_advance</span> <span class="id">r</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_votes_mid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mapP">mapP</a></span> =&gt; -[<span class="id">x</span> <span class="id">H_x_in</span> <span class="id">H_x2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mapP">mapP</a></span>;<span class="kwd">exists</span> <span class="id">x</span>;[|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id">H_softvotes_advance</span> <span class="id">r</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_blocks_mid</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> [<span class="id">b</span>' <span class="id">H_b</span>' /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span> <span class="id">H_b</span>'<span class="id">_valid</span>].<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">b</span>' \<span class="kwd">in</span> <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">H_b</span>'<span class="id">_valid</span>}<span class="id">b</span>' <span class="id">H_b</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: (<span class="id"><a href="Algorand.safety_helpers.html#blocks_monotone">blocks_monotone</a></span> <span class="id">H_reach</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key_mid</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>)).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">split</span>;[|<span class="kwd">exists</span> <span class="id">b</span>';<span class="id">split</span>].<br/>
Qed.</div>
<br/>
<h2> Entering period for certified value </h2>
<br/>
<div class="doc"><span class="bracket"><span class="id">v</span></span> certified in <span class="bracket"><span class="id">p</span></span> means users enter <span class="bracket"><span class="id">p</span></span> nextvoting for <span class="bracket"><span class="id">v</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="certificate_is_start_of_next_period">certificate_is_start_of_next_period</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>)<br/>
&nbsp;&nbsp;<span class="id">p</span> <span class="id">v</span> (<span class="id">H_cert</span>: <span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_cert</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_cert</span> <span class="kwd">as</span> [<span class="id">certvote_quorum</span> [<span class="id">H_comm</span> [<span class="id">H_q_size</span> <span class="id">H_vote</span>]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.quorums.html#quorum_c_has_honest">quorum_c_has_honest</a></span> <span class="id">trace</span> <span class="id">H_comm</span> <span class="id">H_q_size</span>) <span class="kwd">as</span> [<span class="id">certvoter</span> [<span class="id">H_inq</span> <span class="id">H_cv_honest</span>]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:(<span class="id">H_vote</span> <span class="id">certvoter</span> <span class="id">H_inq</span>) =&gt; [<span class="id">ix_cv</span> [<span class="id">g1_cv</span> [<span class="id">g2_cv</span> [<span class="id">H_step_cv</span> <span class="id">H_sent_cv</span>]]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g2</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step_cv</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">key2</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_sent_cv</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_u2</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key2</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u2</span>: <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := <span class="id">g2_cv</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key2</span>] <span class="kwd">in</span> <span class="id">H_u2</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>:(<span class="id"><a href="Algorand.safety.html#certvote_postcondition">certvote_postcondition</a></span> <span class="id">H_sent_cv</span> <span class="id">H_u2</span>) =&gt; [<span class="id">H_certvals</span> [[<span class="id">b</span> [<span class="id">H_blocks</span> <span class="id">H_block_valid</span>]] <span class="id">H_g2_step</span>]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_certvoters_saw_v</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> : <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>, <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">certvote_quorum</span> -&gt; <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>, <span class="id">p</span>, 3) <span class="id">uid</span> <span class="id">trace</span> -&gt; <span class="id"><a href="Algorand.quorums.html#saw_v">saw_v</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">uid</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">cv2</span> <span class="id">H_in2</span> <span class="id">H_hon2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">H_vote</span> <span class="id">_</span> <span class="id">H_in2</span>) =&gt; [<span class="id">ix2</span> [<span class="id">g1</span>' [<span class="id">g2</span>' [<span class="id">H_step</span>' <span class="id">H_send</span>']]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:(<span class="id"><a href="Algorand.safety.html#certvote_postcondition">certvote_postcondition</a></span> <span class="id">H_send</span>' (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>'))) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">H_certvals</span>' [[<span class="id">b</span>' [<span class="id">H_blocks</span>' <span class="id">H_block_valid</span>']] <span class="id">H_g2</span>'<span class="id">_step</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#saw_v">saw_v</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/(@<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState_eqType">GState_eqType</a></span> <span class="id">_</span> <span class="id">trace</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">g2</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step</span>').<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_in">onth_in</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>')).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="id">split</span>;[|<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="id">split</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span>;<span class="kwd">exists</span> <span class="id">b</span>';[|<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span>;<span class="id">move</span>: <span class="id">H_g2</span>'<span class="id">_step</span> =&gt; [-&gt; [-&gt; -&gt;]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>/<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_softvote_quorums_only_for_v</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">quorum2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">quorum2</span> `&lt;=` <span class="id"><a href="Algorand.quorums.html#committee">committee</a></span> <span class="id">r</span> <span class="id">p</span> 2 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#tau_s">tau_s</a></span> &lt;= #|` <span class="id">quorum2</span>| -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>',<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">voter</span>, <span class="id">voter</span> \<span class="kwd">in</span> <span class="id">quorum2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,2) <span class="id">voter</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#softvoted_in_path">softvoted_in_path</a></span> <span class="id">trace</span> <span class="id">voter</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v</span>' = <span class="id">v</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">q2</span> <span class="id">H_certs_q2</span> <span class="id">H_size_q2</span> <span class="id">v</span>' <span class="id">H_voters_q2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#tau_s">tau_s</a></span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#soft_weight">soft_weight</a></span> <span class="id">v</span> <span class="id">u2</span> <span class="id">r</span> <span class="id">p</span>) <span class="kwd">as</span> <span class="id">H_v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">move</span>: <span class="id">H_certvals</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [] //).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_votes_checked</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#softvote_credentials_checked">softvote_credentials_checked</a></span> <span class="id">H_path</span> <span class="id">H_start</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step_cv</span>) <span class="id">H_u2</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:(<span class="id"><a href="Algorand.quorums.html#quorums_s_honest_overlap">quorums_s_honest_overlap</a></span> <span class="id">trace</span> (<span class="id">H_votes_checked</span> <span class="id">v</span> <span class="id">p</span>) <span class="id">H_v</span> <span class="id">H_certs_q2</span> <span class="id">H_size_q2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt; [<span class="id">common_voter</span> [<span class="id">H_voter_in_q1</span> [<span class="id">H_voter_in_q2</span> <span class="id">H_voter_honest</span>]]].<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_voter_in_q2</span> <span class="id">H_voter_honest</span>):<span class="id">H_voters_q2</span> =&gt; {<span class="id">H_voter_in_q2</span>}[<span class="id">ix_sv</span>' <span class="id">H_voted_v</span>'].<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_voter_in_q1</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [[<span class="id">x_1</span> <span class="id">x_2</span>]] /= /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H</span>] /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="id">H1</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H1</span> <span class="id">H2</span> <span class="id">H</span> =&gt; {<span class="id">x_1</span>}&lt;- {<span class="id">x_2</span>}&lt;- =&gt; <span class="id">H_in_softvotes</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:(<span class="id"><a href="Algorand.safety.html#softvotes_sent">softvotes_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_g2</span> <span class="id">H_u2</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>) <span class="id">H_in_softvotes</span> <span class="id">H_voter_honest</span>) =&gt; [<span class="id">ix_sv</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> (<span class="id"><a href="Algorand.safety.html#no_two_softvotes_in_p">no_two_softvotes_in_p</a></span> <span class="id">H_path</span> <span class="id">H_voted_v</span>').<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_interquorum_v</span> := <span class="id"><a href="Algorand.quorums.html#interquorum_c_v_certinfo">interquorum_c_v_certinfo</a></span> <span class="id">H_comm</span> <span class="id">H_q_size</span> <span class="id">H_certvoters_saw_v</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_interquorum_b</span> := <span class="id"><a href="Algorand.quorums.html#interquorum_c_b_certinfo">interquorum_c_b_certinfo</a></span> <span class="id">H_comm</span> <span class="id">H_q_size</span> <span class="id">H_certvoters_saw_v</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;For&nbsp;value&nbsp;votes:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;By&nbsp;interquorum&nbsp;assumptions,&nbsp;any&nbsp;nextvote&nbsp;quorum&nbsp;contains&nbsp;an&nbsp;honest&nbsp;voter<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;(would&nbsp;have)&nbsp;certvoted&nbsp;for&nbsp;v&nbsp;in&nbsp;step&nbsp;3.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Having&nbsp;seen&nbsp;a&nbsp;quorum&nbsp;of&nbsp;softvotes&nbsp;rules&nbsp;out&nbsp;an&nbsp;stv-based&nbsp;nextvote.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;quorum&nbsp;of&nbsp;softvotes&nbsp;for&nbsp;the&nbsp;v'&nbsp;they&nbsp;voted&nbsp;for<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;would&nbsp;have&nbsp;honest&nbsp;overlap&nbsp;with&nbsp;the&nbsp;softvote&nbsp;v&nbsp;quorum<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;so&nbsp;by&nbsp;no_two_softvotes_in_p&nbsp;we&nbsp;have&nbsp;v&nbsp;=&nbsp;v'.<br/>
&nbsp;&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">s</span> <span class="id">nextvoters</span> <span class="id">H_nv_creds</span> <span class="id">H_nv_size</span> <span class="id">v</span>' <span class="id">H_nv_voted</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_interquorum_v</span> =&gt; /(<span class="id">_</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">_</span> <span class="id">H_nv_creds</span> <span class="id">H_nv_size</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt; -[<span class="id">uid_nv</span> [<span class="id">H_in_nv</span> [<span class="id">H_saw_v</span> <span class="id">H_honest</span>]]].<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_nv_voted</span> =&gt;/(<span class="id">_</span> <span class="id">_</span> <span class="id">H_in_nv</span> <span class="id">H_honest</span>){<span class="id">H_in_nv</span>} [<span class="id">ix_nv</span> [<span class="id">g1_nv</span> [<span class="id">g2_nv</span> [<span class="id">H_step_nv</span> <span class="id">H_send_nv</span>]]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">key1_nv</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send_nv</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u1_nv</span> := <span class="id">g1_nv</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">key1_nv</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">case</span>:(<span class="id"><a href="Algorand.safety.html#nextvote_val_precondition">nextvote_val_precondition</a></span> <span class="id">H_send_nv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>)) =&gt; [[<span class="id">b0</span>]|].<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;nextvote_val_ok&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_val_ok">nextvote_val_ok</a></span> =&gt; -[<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvals">certvals</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_sv_size</span> <span class="id">H_sv_votes</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_sv_creds</span> := (<span class="id"><a href="Algorand.safety.html#softvote_credentials_checked">softvote_credentials_checked</a></span> <span class="id">H_path</span> <span class="id">H_start</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step_nv</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>) <span class="id">v</span>' <span class="id">p</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">H_softvote_quorums_only_for_v</span> <span class="id">_</span> <span class="id">H_sv_creds</span> <span class="id">H_sv_size</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>:= <span class="id"><a href="Algorand.safety.html#softvotes_sent">softvotes_sent</a></span> <span class="id">H_path</span> <span class="id">H_start</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step_nv</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span> <span class="id">r</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>=&gt; <span class="id">H_sv_sent</span> <span class="id">voter</span> <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H_sv_sent</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H_in</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [[<span class="id">x0</span> <span class="id">x1</span>] /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> -&gt;] /= -&gt;].<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;nextvote_stv_ok&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_stv_ok">nextvote_stv_ok</a></span> =&gt; -[] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">H_s</span>] [/(<span class="id">_</span> <span class="id">v</span>)<span class="id">H_no_good_certvals</span> <span class="id">_</span>] <span class="id">_</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_good_certval</span> := <span class="id"><a href="Algorand.safety.html#certinfo_forward">certinfo_forward</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_saw_v</span> <span class="id">H_step_nv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>) <span class="id">H_send_nv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> <span class="kwd">in</span> <span class="id">H_good_certval</span>;<span class="id">cbn</span> -[<span class="id">step_le</span>] <span class="kwd">in</span> <span class="id">H_good_certval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span>: <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id">r</span>,<span class="id">p</span>,4) (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>;<span class="id">rewrite</span> /= !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="id">H_s</span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id">H_good_certval</span> =&gt; [<span class="id">H_v_certval</span> [<span class="id">b0</span> [<span class="id">H_b0_blocks</span> <span class="id">H_b0_valid</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> (<span class="id">H_no_good_certvals</span> <span class="id">H_v_certval</span> <span class="id">_</span> <span class="id">H_b0_blocks</span> <span class="id">H_b0_valid</span>).<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;For&nbsp;no&nbsp;bottom&nbsp;votes:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;By&nbsp;interquorum&nbsp;assumption,&nbsp;any&nbsp;nextvote&nbsp;quorum&nbsp;contains&nbsp;an&nbsp;honest&nbsp;voter<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;(would&nbsp;have)&nbsp;certvoted&nbsp;for&nbsp;v&nbsp;in&nbsp;step&nbsp;3.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Having&nbsp;seen&nbsp;enough&nbsp;softvotes&nbsp;violates&nbsp;the&nbsp;precondition&nbsp;for&nbsp;voting&nbsp;for&nbsp;bottom.<br/>
&nbsp;&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;{<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">s</span> <span class="id">bot_voters</span> <span class="id">H_bot_creds</span> <span class="id">H_bot_size</span> <span class="id">H_bot_voted</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_interquorum_b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt; /(<span class="id">_</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">_</span> <span class="id">H_bot_creds</span> <span class="id">H_bot_size</span>){<span class="id">H_bot_creds</span> <span class="id">H_bot_size</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;=&gt; -[<span class="id">honest_bot_voter</span> [<span class="id">H_honest_in</span> [<span class="id">H_honest_saw</span> <span class="id">H_honest_honest</span>]]].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_bot_voted</span> =&gt; /(<span class="id">_</span> <span class="id">_</span> <span class="id">H_honest_in</span> <span class="id">H_honest_honest</span>){<span class="id">H_honest_in</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">ix_nv</span> [<span class="id">g1_nv</span> [<span class="id">g2_nv</span> [<span class="id">H_step_nv</span> <span class="id">H_send_nv</span>]]]].<br/>
<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">key1_nv</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send_nv</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u1_nv</span> := <span class="id">g1_nv</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">key1_nv</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> := <span class="id"><a href="Algorand.safety.html#nextvote_open_precondition">nextvote_open_precondition</a></span> <span class="id">H_send_nv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; -[<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">_</span>] [<span class="id">H_s</span>] [/(<span class="id">_</span> <span class="id">v</span>)<span class="id">H_no_good_certvals</span> <span class="id">_</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_good_certval</span> := <span class="id"><a href="Algorand.safety.html#certinfo_forward">certinfo_forward</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_honest_saw</span> <span class="id">H_step_nv</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1_nv</span>) <span class="id">H_send_nv</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span>, <span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> <span class="kwd">in</span> <span class="id">H_good_certval</span>;<span class="id">cbn</span> -[<span class="id">step_le</span>] <span class="kwd">in</span> <span class="id">H_good_certval</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id">r</span>,<span class="id">p</span>,4) (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>;<span class="id">rewrite</span> /= !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span> <span class="id">H_s</span> /=.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id">H_good_certval</span> =&gt; [<span class="id">H_v_certval</span> [<span class="id">b0</span> [<span class="id">H_b0_blocks</span> <span class="id">H_b0_valid</span>]]].<br/>
&nbsp;&nbsp;<span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id">H_no_good_certvals</span> <span class="id">H_v_certval</span> <span class="id">_</span> <span class="id">H_b0_blocks</span> <span class="id">H_b0_valid</span>).<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">v</span></span> certified in <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> means users enter all <span class="bracket"><span class="id">p</span>' &gt;= <span class="id">p</span></span> nextvoting for <span class="bracket"><span class="id">v</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="certificate_is_start_of_later_periods">certificate_is_start_of_later_periods</a></span><br/>
&nbsp;&nbsp;<span class="id">trace</span> <span class="id">g0</span>  (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">r</span> (<span class="id">H_start</span>: <span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>,  1 &lt;= <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>', <span class="id">p</span> &lt;= <span class="id">p</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#period_nextvoted_exclusively_for">period_nextvoted_exclusively_for</a></span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>' <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">p</span> <span class="id">H_p</span> <span class="id">v</span> <span class="id">H_cert</span> <span class="id">p</span>' <span class="id">H_p_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>: <span class="id">p</span>' = (<span class="id">p</span> + (<span class="id">p</span>' - <span class="id">p</span>))%<span class="id">nat</span> <span class="kwd">by</span> <span class="id">symmetry</span>;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subnKC">subnKC</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">p</span>' - <span class="id">p</span>)%<span class="id">nat</span> =&gt; <span class="id">n</span> {<span class="id">p</span>' <span class="id">H_p_lt</span>}-&gt;.<br/>
&nbsp;&nbsp;<span class="id">elim</span>:<span class="id">n</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Next&nbsp;step&nbsp;after&nbsp;certification&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span>;<span class="id">apply</span>/(<span class="id"><a href="Algorand.safety.html#certificate_is_start_of_next_period">certificate_is_start_of_next_period</a></span> <span class="id">H_path</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Later&nbsp;steps&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">n</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addnS">addnS</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety.html#excl_enter_excl_next">excl_enter_excl_next</a></span> <span class="id">H_path</span> <span class="id">H_start</span> (<span class="id">p</span>:=(<span class="id">p</span>+<span class="id">n</span>).+1)).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn_gt0">addn_gt0</a></span> <span class="id">H_p</span>.<br/>
Qed.</div>
<br/>
<h2> One certificate per period </h2>
<br/>
<div class="doc">Only one value can be certified in a given <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> pair. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="one_certificate_per_period">one_certificate_per_period</a></span>: <span class="kwd">forall</span> <span class="id">g0</span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v1</span>, <span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v2</span>, <span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v1</span> = <span class="id">v2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">g0</span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p</span> <span class="id">H_start</span> <span class="id">H_path</span> <span class="id">v1</span> <span class="id">H_cert1</span> <span class="id">v2</span> <span class="id">H_cert2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_cert1</span> <span class="kwd">as</span> (<span class="id">quorum1</span> &amp; <span class="id">H_q1</span> &amp; <span class="id">H_size1</span> &amp; <span class="id">H_cert1</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_cert2</span> <span class="kwd">as</span> (<span class="id">quorum2</span> &amp; <span class="id">H_q2</span> &amp; <span class="id">H_size2</span> &amp; <span class="id">H_cert2</span>).<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.quorums.html#quorums_c_honest_overlap">quorums_c_honest_overlap</a></span> <span class="id">trace</span> <span class="id">H_q1</span> <span class="id">H_size1</span> <span class="id">H_q2</span> <span class="id">H_size2</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">voter</span> &amp; <span class="id">H_common1</span> &amp; <span class="id">H_common2</span> &amp; <span class="id">H_honest</span>).<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_cert1</span> <span class="id">_</span> <span class="id">H_common1</span>).<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_cert2</span> <span class="id">_</span> <span class="id">H_common2</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_cert1</span> <span class="kwd">as</span> [<span class="id">ix1</span> <span class="id">H_cert1</span>].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_cert2</span> <span class="kwd">as</span> [<span class="id">ix2</span> <span class="id">H_cert2</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#user_honest_at">user_honest_at</a></span> <span class="id">ix1</span> <span class="id">trace</span> <span class="id">voter</span>) <span class="kwd">as</span> <span class="id">H_honest1</span>. {<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_cert1</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span>. <span class="id">move</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_vote</span>]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote</span>)) <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">ustate</span> := <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote</span>] <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">clearbody</span> <span class="id">ustate</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H1</span>: (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate</span>) = (<span class="id">r</span>,<span class="id">p</span>,3) := <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_vote</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_at_from_during">honest_at_from_during</a></span> <span class="id">H_honest</span> <span class="id">H_path</span>) <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">_</span> <span class="id">_</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>)).<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">_</span> <span class="id">H0</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.algorand_model.html#user_honest_at">user_honest_at</a></span> <span class="id">ix2</span> <span class="id">trace</span> <span class="id">voter</span>) <span class="kwd">as</span> <span class="id">H_honest2</span>. {<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_cert2</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.quorums.html#certvoted_in_path_at">certvoted_in_path_at</a></span>. <span class="id">move</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_vote</span>]]].<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_at_from_during">honest_at_from_during</a></span> <span class="id">H_honest</span> <span class="id">H_path</span>) <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">_</span> <span class="id">_</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>)).<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote</span>)).<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">ustate</span> := <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote</span>] <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">clearbody</span> <span class="id">ustate</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">_</span> <span class="id">H0</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_vote</span> <span class="id">H0</span>);<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> (<span class="id"><a href="Algorand.safety.html#no_two_certvotes_in_p">no_two_certvotes_in_p</a></span> <span class="id">H_path</span> <span class="id">H_cert1</span> <span class="id">H_honest1</span> <span class="id">H_cert2</span> <span class="id">H_honest2</span>).<br/>
Qed.</div>
<br/>
<h2> Safety </h2>
<br/>
<div class="doc">The safety theorem: only one value can be certified in each round. This means
that at most one block is approved in a given round. </div>
<span class="kwd">Theorem</span> <span class="id"><a name="safety">safety</a></span> : <span class="kwd">forall</span> (<span class="id">g0</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) (<span class="id">trace</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) (<span class="id">r</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>),<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety.html#state_before_round">state_before_round</a></span> <span class="id">r</span> <span class="id">g0</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">p1</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v1</span> : <span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>), <span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p1</span> <span class="id">v1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">p2</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) (<span class="id">v2</span> : <span class="id"><a href="Algorand.algorand_model.html#Value">Value</a></span>), <span class="id"><a href="Algorand.quorums.html#certified_in_period">certified_in_period</a></span> <span class="id">trace</span> <span class="id">r</span> <span class="id">p2</span> <span class="id">v2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">v1</span> = <span class="id">v2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">g0</span> <span class="id">trace</span> <span class="id">r</span> <span class="id">H_start</span> <span class="id">H_path</span> <span class="id">p1</span> <span class="id">v1</span> <span class="id">H_cert1</span> <span class="id">p2</span> <span class="id">v2</span> <span class="id">H_cert2</span>.<br/>
&nbsp;&nbsp;<span class="id">wlog</span>: <span class="id">p1</span> <span class="id">v1</span> <span class="id">H_cert1</span> <span class="id">p2</span> <span class="id">v2</span> <span class="id">H_cert2</span> / (<span class="id">p1</span> &lt;= <span class="id">p2</span>).<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;showing&nbsp;this&nbsp;suffices&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_narrowed</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">p1</span> &lt;= <span class="id">p2</span>) <span class="id">eqn</span>:<span class="id">H_test</span>;[|<span class="id">symmetry</span>];<span class="id">eapply</span> <span class="id">H_narrowed</span>;<span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnW">ltnW</a></span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span>. <span class="id">rewrite</span> <span class="id">H_test</span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Continuing&nbsp;proof&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_le</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqVneq">eqVneq</a></span> <span class="id">p1</span> <span class="id">p2</span>).<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;Two&nbsp;blocks&nbsp;certified&nbsp;in&nbsp;same&nbsp;period.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">p2</span>; <span class="id">clear</span> <span class="id">H_le</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety.html#one_certificate_per_period">one_certificate_per_period</a></span>;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;*<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Second&nbsp;certificate&nbsp;produced&nbsp;in&nbsp;a&nbsp;later&nbsp;period&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">p1</span> &lt; <span class="id">p2</span>) <span class="kwd">as</span> <span class="id">Hlt</span> <span class="kwd">by</span> (<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_neqAle">ltn_neqAle</a></span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="id">split</span>;<span class="id">assumption</span>).<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H_le</span> <span class="id">i</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (1 &lt;= <span class="id">p1</span>) <span class="kwd">as</span> <span class="id">H_p1</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_cert1</span> =&gt; [<span class="id">quorum_p1</span> [<span class="id">H_creds</span> [<span class="id">H_size</span> <span class="id">_</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id"><a href="Algorand.quorums.html#quorum_c_has_honest">quorum_c_has_honest</a></span> <span class="id">trace</span> <span class="id">H_creds</span> <span class="id">H_size</span>) =&gt; [<span class="id">voter1</span> [<span class="id">H_in</span> <span class="id">_</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_creds</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubsetP">fsubsetP</a></span> /(<span class="id">_</span> <span class="id">_</span> <span class="id">H_in</span>) /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#imfsetP">imfsetP</a></span> [<span class="id">x</span> <span class="id">H</span> <span class="id">H_x</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_x</span> <span class="id">H</span> =&gt; {<span class="id">x</span>}&lt;- /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.algorand_model.html#credentials_valid_period">credentials_valid_period</a></span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_p2</span>: <span class="id">p1</span> &lt;= <span class="id">p2</span>.-1 <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_predK">ltn_predK</a></span> <span class="id">Hlt</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssreflect.html#nosimpl">nosimpl</a></span> <span class="id">H_cert2</span>) <span class="kwd">as</span> (<span class="id">q2</span> &amp; <span class="id">H_q2</span> &amp; <span class="id">H_size2</span> &amp; <span class="id">H_cert2_voted</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.quorums.html#quorum_c_has_honest">quorum_c_has_honest</a></span> <span class="id">trace</span> <span class="id">H_q2</span> <span class="id">H_size2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">as</span> (<span class="id">honest_voter</span> &amp; <span class="id">H_honest_q</span> &amp; <span class="id">H_honest_in</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_cert2_voted</span> <span class="id">honest_voter</span> <span class="id">H_honest_q</span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssreflect.html#nosimpl">nosimpl</a></span> <span class="id">H_cert2_voted</span>) <span class="kwd">as</span> (<span class="id">ix</span> &amp; <span class="id">ga1</span> &amp; <span class="id">ga2</span> &amp; [<span class="id">H_step2</span> <span class="id">H_send_vote2</span>]).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span> <span class="id">r</span> <span class="id">p2</span> <span class="id">honest_voter</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> (<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_in_from_during_and_send">honest_in_from_during_and_send</a></span>;[<span class="id">eassumption</span>..|<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>]).<br/>
<br/>
&nbsp;&nbsp;<span class="id">symmetry</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_p2</span>': 1 &lt; <span class="id">p2</span> <span class="kwd">by</span> <span class="id">apply</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_trans">leq_trans</a></span> (<span class="id">n</span>:=<span class="id">p1</span>.+1));[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span>|].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_excl</span> := <span class="id"><a href="Algorand.safety.html#certificate_is_start_of_later_periods">certificate_is_start_of_later_periods</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p1</span> <span class="id">H_cert1</span> <span class="id">H_p2</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety.html#prev_period_nextvotes_limits_cert_vote">prev_period_nextvotes_limits_cert_vote</a></span> <span class="id">H_path</span> <span class="id">H_start</span> <span class="id">H_p2</span>' <span class="id">H_excl</span> <span class="id">H_honest_in</span> <span class="id">H_cert2_voted</span>).<br/>
Qed.</div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
