
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Algorand.safety_helpers</title>
<meta name="description" content="Documentation of Coq module Algorand.safety_helpers" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="hideAll('proofscript')">
<h1 class="title">Module Algorand.safety_helpers</h1>
<div class="coq">
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.all_ssreflect.html">all_ssreflect</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html">finmap</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html">multiset</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.zify.zify.html">zify</a></span>.<br/>
<span class="kwd">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Reals.html">Reals</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Relations.Relation_Definitions.html">Relation_Definitions</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Relations.Relation_Operators.html">Relation_Operators</a></span>.<br/>
<span class="kwd">From</span> <span class="id">mathcomp</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html">boolp</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.Rstruct.html">Rstruct</a></span>.<br/>
<span class="kwd">From</span> <span class="id">Algorand</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="Algorand.fmap_ext.html">fmap_ext</a></span> <span class="id"><a href="Algorand.algorand_model.html">algorand_model</a></span>.<br/>
<br/>
<span class="kwd">Set</span> <span class="kwd">Implicit</span> <span class="kwd">Arguments</span>.<br/>
<span class="id">Unset</span> <span class="id">Strict</span> <span class="kwd">Implicit</span>.<br/>
<span class="id">Unset</span> <span class="id">Printing</span> <span class="kwd">Implicit</span> <span class="id">Defensive</span>.<br/>
<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">mset_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">fmap_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">fset_scope</span>.<br/>
<br/>
<h1> Safety helper definitions and results </h1>
<br/>
<div class="doc">This module contains helper functions and lemmas
used when proving safety of the transition system. </div>
<br/>
<span class="kwd">Ltac</span> <span class="id">finish_case</span> := <span class="id">simpl</span>;<span class="id">solve</span>[<span class="id">repeat</span> <span class="id">first</span>[<span class="id">reflexivity</span>|<span class="id">eassumption</span>|<span class="id">split</span>|<span class="id">eexists</span>]].<br/>
<br/>
<div class="doc">Gather all the unfoldings we might want for working with transitions into
a hint database for use with autounfold. </div>
<span class="id">Create</span> <span class="id">HintDb</span> <span class="id">utransition_unfold</span> <span class="id">discriminated</span>.<br/>
#[<span class="id">export</span>] <span class="kwd">Hint</span> <span class="id">Unfold</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#propose_result">propose_result</a></span>      <span class="id"><a href="Algorand.algorand_model.html#propose_ok">propose_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#repropose_ok">repropose_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#no_propose_ok">no_propose_ok</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#softvote_result">softvote_result</a></span>     <span class="id"><a href="Algorand.algorand_model.html#softvote_new_ok">softvote_new_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#softvote_repr_ok">softvote_repr_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#no_softvote_ok">no_softvote_ok</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#certvote_result">certvote_result</a></span>     <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#no_certvote_ok">no_certvote_ok</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#nextvote_result">nextvote_result</a></span>     <span class="id"><a href="Algorand.algorand_model.html#nextvote_val_ok">nextvote_val_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_open_ok">nextvote_open_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#nextvote_stv_ok">nextvote_stv_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#no_nextvote_ok">no_nextvote_ok</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#certvote_timeout_ok">certvote_timeout_ok</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span>       <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span>         <span class="id"><a href="Algorand.algorand_model.html#certvote_result">certvote_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_open">set_nextvotes_open</a></span>  <span class="id"><a href="Algorand.algorand_model.html#adv_period_open_ok">adv_period_open_ok</a></span>  <span class="id"><a href="Algorand.algorand_model.html#adv_period_open_result">adv_period_open_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#set_nextvotes_val">set_nextvotes_val</a></span>   <span class="id"><a href="Algorand.algorand_model.html#adv_period_val_ok">adv_period_val_ok</a></span>   <span class="id"><a href="Algorand.algorand_model.html#adv_period_val_result">adv_period_val_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#set_certvotes">set_certvotes</a></span>       <span class="id"><a href="Algorand.algorand_model.html#certify_ok">certify_ok</a></span>          <span class="id"><a href="Algorand.algorand_model.html#certify_result">certify_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#vote_msg">vote_msg</a></span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span> : <span class="id">utransition_unfold</span>.<br/>
<br/>
<span class="id">Create</span> <span class="id">HintDb</span> <span class="id">gtransition_unfold</span> <span class="id">discriminated</span>.<br/>
#[<span class="id">export</span>] <span class="kwd">Hint</span> <span class="id">Unfold</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#tick_ok">tick_ok</a></span> <span class="id"><a href="Algorand.algorand_model.html#tick_update">tick_update</a></span> <span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#is_partitioned">is_partitioned</a></span> <span class="id"><a href="Algorand.algorand_model.html#recover_from_partitioned">recover_from_partitioned</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#is_unpartitioned">is_unpartitioned</a></span> <span class="id"><a href="Algorand.algorand_model.html#make_partitioned">make_partitioned</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#corrupt_user_result">corrupt_user_result</a></span> : <span class="id">gtransition_unfold</span>.<br/>
<br/>
<span class="kwd">Arguments</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> : <span class="id">clear</span> <span class="id">implicits</span>.<br/>
<br/>
<h2> Generic path lemmas </h2>
<br/>
<div class="doc">Dropping elements from a path still results in a path. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="path_drop">path_drop</a></span> <span class="id">T</span> (<span class="id">R</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#rel">rel</a></span> <span class="id">T</span>) <span class="id">x</span> <span class="id">p</span> (<span class="id">H</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span> <span class="id">p</span>) <span class="id">n</span>:<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">p</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Lists.List.html#nil">List.nil</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Lists.List.html#cons">List.cons</a></span> <span class="id">x</span>' <span class="id">p</span>' =&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span>' <span class="id">p</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof1')">Proof.</span></div>
<div class="proofscript" id="proof1">
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">elim</span>: <span class="id">n</span> <span class="id">x</span> <span class="id">p</span> <span class="id">H</span>=&gt; [|<span class="id">n</span> <span class="id">IHn</span>] <span class="id">x</span> [|<span class="id">a</span> <span class="id">l</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [] <span class="id">H_path</span>];<span class="id">last</span> <span class="id">apply</span> <span class="id">IHn</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id">path_drop</span>' <span class="id">T</span> (<span class="id">R</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#rel">rel</a></span> <span class="id">T</span>) <span class="id">x</span> <span class="id">p</span> (<span class="id">H</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span> <span class="id">p</span>) <span class="id">n</span>:<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> (<span class="id">x</span>::<span class="id">p</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;| [::] =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span><br/>
&nbsp;&nbsp;| [:: <span class="id">x</span>' &amp; <span class="id">p</span>'] =&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span>' <span class="id">p</span>'<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof2')">Proof.</span></div>
<div class="proofscript" id="proof2">
&nbsp;&nbsp;<span class="id">elim</span>: <span class="id">n</span> <span class="id">x</span> <span class="id">p</span> <span class="id">H</span>=&gt; [|<span class="id">n</span> <span class="id">IHn</span>] <span class="id">x</span> <span class="id">p</span> <span class="id">H_path</span> //=.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id">IHn</span>: {<span class="id">IHn</span>}<span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">p</span>;[|<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; []].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#add1n">add1n</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_drop">drop_drop</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">p</span>);[|<span class="id">destruct</span> <span class="id">l</span>;[|<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; []]].<br/>
Qed.</div>
<br/>
<div class="doc">Predicate <span class="bracket"><span class="id">path</span></span> still holds after taking <span class="bracket"><span class="id">n</span></span> elements. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="path_prefix">path_prefix</a></span> : <span class="kwd">forall</span> <span class="id">T</span> <span class="id">R</span> <span class="id">p</span> (<span class="id">x</span>:<span class="id">T</span>) <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span> <span class="id">p</span> -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">n</span> <span class="id">p</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof3')">Proof.</span></div>
<div class="proofscript" id="proof3">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">p</span>;[<span class="id">done</span>|].<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; /= <span class="id">x</span> <span class="id">n</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">Hr</span> <span class="id">Hpath</span>].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="kwd">by</span> <span class="id">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Proposition does not hold initially but holds for last element implies there
must be a point in the path where it becomes true. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="path_steps">path_steps</a></span> : <span class="kwd">forall</span> {<span class="id">T</span>} (<span class="id">R</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#rel">rel</a></span> <span class="id">T</span>) <span class="id">x0</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#path">path</a></span> <span class="id">R</span> <span class="id">x0</span> <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id">T</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~~ <span class="id">P</span> <span class="id">x0</span> -&gt; <span class="id">P</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last">last</a></span> <span class="id">x0</span> <span class="id">p</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> (<span class="id">x0</span> :: <span class="id">p</span>) <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">x1</span> :: <span class="id">x2</span> :: <span class="id">_</span> =&gt; ~~ <span class="id">P</span> <span class="id">x1</span> &amp;&amp; <span class="id">P</span> <span class="id">x2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof4')">Proof.</span></div>
<div class="proofscript" id="proof4">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">T</span> <span class="id">R</span> <span class="id">x0</span> <span class="id">p</span> <span class="id">H_path</span> <span class="id">P</span> <span class="id">H_x0</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">p</span> <span class="id">H_path</span>. <span class="id">induction</span> <span class="id">p</span> <span class="kwd">using</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_ind">last_ind</a></span>.<br/>
&nbsp;&nbsp;* <span class="id">simpl</span>. <span class="id">intros</span> <span class="id">_</span> <span class="id">H_b</span>. <span class="id">exfalso</span>. <span class="id">revert</span> <span class="id">H_b</span>. <span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;* <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_rcons">last_rcons</a></span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#rcons_path">rcons_path</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_path</span> <span class="id">H_step</span>] <span class="id">H_x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">P</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last">last</a></span> <span class="id">x0</span> <span class="id">p</span>)) <span class="id">eqn</span>:<span class="id">H_last</span>.<br/>
&nbsp;&nbsp;+ <span class="id">destruct</span> <span class="id">IHp</span> <span class="kwd">as</span> [<span class="id">n</span>' <span class="id">Hind</span>];[<span class="id">done</span>..|]. <span class="kwd">exists</span> <span class="id">n</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>';<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">Hind</span> |- *. <span class="id">destruct</span> <span class="id">p</span>;[<span class="kwd">by</span> <span class="id">exfalso</span>|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnP">ltnP</a></span> <span class="id">n</span>' (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">p</span>));[|<span class="kwd">by</span> (<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_oversize">drop_oversize</a></span> <span class="kwd">in</span> <span class="id">Hind</span>)].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_rcons">drop_rcons</a></span>;[<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span>' <span class="id">p</span>) <span class="kwd">as</span> [|? [|]];[<span class="id">done</span>..|<span class="id">tauto</span>]|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnW">ltnW</a></span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;+ <span class="id">clear</span> <span class="id">IHp</span>. <span class="kwd">exists</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">p</span>) <span class="id">eqn</span>:<span class="id">H_size</span>. <span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size0nil">size0nil</a></span> <span class="id">H_size</span>) <span class="kwd">in</span> <span class="id">H_last</span> |- *. <span class="id">simpl</span>. <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_nth">drop_nth</a></span> <span class="id">x0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#cats1">cats1</a></span>, &lt;- <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_size_cat">drop_size_cat</a></span>;[|<span class="id">reflexivity</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_cat">nth_cat</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_size</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnSn">ltnSn</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> <span class="id">n</span> <span class="kwd">with</span> (<span class="id">n</span>.+1.-1).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H_size</span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_last">nth_last</a></span>, <span class="id">H_last</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_rcons">size_rcons</a></span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span>. <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnSn">leqnSn</a></span>.<br/>
Qed.</div>
<br/>
<h2> Generic multiset lemmas </h2>
<br/>
<div class="doc">Element <span class="bracket"><span class="id">x</span></span> in mset of seq iff <span class="bracket"><span class="id">x</span></span> is in seq. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="in_seq_mset">in_seq_mset</a></span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">x</span> : <span class="id">T</span>) (<span class="id">s</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>):<br/>
&nbsp;&nbsp;(<span class="id">x</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#seq_mset">seq_mset</a></span> <span class="id">s</span>) = (<span class="id">x</span> \<span class="kwd">in</span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof5')">Proof.</span></div>
<div class="proofscript" id="proof5">
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_mem">perm_mem</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_eq_seq_mset">perm_eq_seq_mset</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The number of elements in the preimage of <span class="bracket"><span class="id">f</span></span> w.r.t. <span class="bracket"><span class="id">b</span></span> and multiset <span class="bracket"><span class="id">m</span></span> is
the same as applying <span class="bracket"><span class="id">map_mset</span></span> on <span class="bracket"><span class="id">f</span></span> and <span class="bracket"><span class="id">m</span></span> and then <span class="bracket"><span class="id">b</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="map_mset_count">map_mset_count</a></span> {<span class="id">A</span> <span class="id">B</span> :<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>} (<span class="id">f</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) (<span class="id">m</span> : {<span class="id">mset</span> <span class="id">A</span>}) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">b</span>:<span class="id">B</span>), (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#count">count</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#preim">preim</a></span> <span class="id">f</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#pred1">pred1</a></span> <span class="id">b</span>)) <span class="id">m</span>) = (<span class="id"><a href="Algorand.algorand_model.html#map_mset">map_mset</a></span> <span class="id">f</span> <span class="id">m</span>) <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof6')">Proof.</span></div>
<div class="proofscript" id="proof6">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#map_mset">map_mset</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">m</span>}(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#EnumMset.f">EnumMset.f</a></span> <span class="id">m</span>) =&gt; <span class="id">l</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset_seqE">mset_seqE</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#count_map">count_map</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Element membership w.r.t. preimage is preserved by <span class="bracket"><span class="id">map_mset</span></span> on the multiset <span class="bracket"><span class="id">m</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="map_mset_has">map_mset_has</a></span> {<span class="id">A</span> <span class="id">B</span> :<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>} (<span class="id">f</span>: <span class="id">A</span> -&gt; <span class="id">B</span>) (<span class="id">m</span> : {<span class="id">mset</span> <span class="id">A</span>}) :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">b</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id">B</span>), <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> <span class="id">b</span> (<span class="id"><a href="Algorand.algorand_model.html#map_mset">map_mset</a></span> <span class="id">f</span> <span class="id">m</span>) = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#preim">preim</a></span> <span class="id">f</span> <span class="id">b</span>) <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof7')">Proof.</span></div>
<div class="proofscript" id="proof7">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_map">has_map</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#eq_has_r">eq_has_r</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_mem">perm_mem</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_eq_seq_mset">perm_eq_seq_mset</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The support of a multiset is unique when viewed as a sequence. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="finsupp_mset_uniq">finsupp_mset_uniq</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span>:{<span class="id">mset</span> <span class="id">T</span>}):<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#uniq">uniq</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#finsupp">finsupp</a></span> <span class="id">A</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof8')">Proof.</span></div>
<div class="proofscript" id="proof8">
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_uniq">perm_uniq</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_undup_mset">perm_undup_mset</a></span> <span class="id">A</span>));<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#undup_uniq">undup_uniq</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The sequence of a subset of a multiset is equal to the subset's finite support modulo reordering. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="msubset_finsupp">msubset_finsupp</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span> <span class="id">B</span>: {<span class="id">mset</span> <span class="id">T</span>}):<br/>
&nbsp;&nbsp;(<span class="id">A</span> `&lt;=` <span class="id">B</span>)%<span class="id">mset</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#finsupp">finsupp</a></span> <span class="id">A</span>) [<span class="id">seq</span> <span class="id">i</span> &lt;- <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#finsupp">finsupp</a></span> <span class="id">B</span> | <span class="id">i</span> \<span class="kwd">in</span> <span class="id">A</span>].<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof9')">Proof.</span></div>
<div class="proofscript" id="proof9">
&nbsp;&nbsp;<span class="id">move</span>=&gt;<span class="id">H_sub</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#uniq_perm">uniq_perm</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#finsupp_mset_uniq">finsupp_mset_uniq</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#filter_uniq">filter_uniq</a></span>;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#finsupp_mset_uniq">finsupp_mset_uniq</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>=&gt;<span class="id">x</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_filter">mem_filter</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msuppE">msuppE</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andb_idr">andb_idr</a></span> //.<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_sub</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_subset">msubset_subset</a></span>. <span class="id">apply</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Summing up elements in a multiset subset is the same as taking sequence length. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="msubset_size_sum">msubset_size_sum</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span> <span class="id">B</span>: {<span class="id">mset</span> <span class="id">T</span>}):<br/>
&nbsp;&nbsp;(<span class="id">A</span> `&lt;=` <span class="id">B</span>)%<span class="id">mset</span> -&gt;<br/>
&nbsp;&nbsp;\<span class="id">sum_</span>(<span class="id">i</span> &lt;- <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#finsupp">finsupp</a></span> <span class="id">B</span>) <span class="id">A</span> <span class="id">i</span> = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">A</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof10')">Proof.</span></div>
<div class="proofscript" id="proof10">
&nbsp;&nbsp;<span class="id">move</span>=&gt;<span class="id">H_sub</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#bigID">bigID</a></span> (<span class="kwd">fun</span> <span class="id">i</span> =&gt; <span class="id">i</span> \<span class="kwd">in</span> <span class="id">A</span>)) /= -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#big_filter">big_filter</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#perm_big">perm_big</a></span> <span class="id">_</span> (<span class="id"><a href="Algorand.safety_helpers.html#msubset_finsupp">msubset_finsupp</a></span> <span class="id">H_sub</span>)) -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#size_mset">size_mset</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#big1">big1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>=&gt;<span class="id">i</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset_eq0P">mset_eq0P</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The size of a unioned multiset is sum of the size of its components. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="mset_add_size">mset_add_size</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span> <span class="id">B</span> : {<span class="id">mset</span> <span class="id">T</span>}):<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id">A</span> `+` <span class="id">B</span>) = (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">A</span> + <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">B</span>)%<span class="id">nat</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof11')">Proof.</span></div>
<div class="proofscript" id="proof11">
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#size_mset">size_mset</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#eq_bigr">eq_bigr</a></span> (<span class="kwd">fun</span> <span class="id">a</span> =&gt; <span class="id">A</span> <span class="id">a</span> + <span class="id">B</span> <span class="id">a</span>)%<span class="id">nat</span>);[|<span class="kwd">by</span> <span class="id">move</span> =&gt; ? <span class="id">_</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetE2">msetE2</a></span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#big_split">big_split</a></span> !<span class="id"><a href="Algorand.safety_helpers.html#msubset_size_sum">msubset_size_sum</a></span> //.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -{1}[<span class="id">B</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0D">mset0D</a></span>. <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetSD">msetSD</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msub0set">msub0set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -{1}[<span class="id">A</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetD0">msetD0</a></span>. <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetDS">msetDS</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msub0set">msub0set</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The size of <span class="bracket"><span class="id">msetn</span> <span class="id">n</span> <span class="id">x</span></span>  is <span class="bracket"><span class="id">n</span></span> for any <span class="bracket"><span class="id">x</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="msetn_size">msetn_size</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) <span class="id">n</span> (<span class="id">x</span>:<span class="id">T</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetn">msetn</a></span> <span class="id">n</span> <span class="id">x</span>) = <span class="id">n</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof12')">Proof.</span></div>
<div class="proofscript" id="proof12">
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#size_mset">size_mset</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#finsupp_msetn">finsupp_msetn</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">n</span>=&gt;[|<span class="id">n</span>] /=.<br/>
&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.bigop.html#big_nil">big_nil</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#big_seq_fset1">big_seq_fset1</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetnxx">msetnxx</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The subset of a multiset has smaller size. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="msubset_size">msubset_size</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span> <span class="id">B</span> : {<span class="id">mset</span> <span class="id">T</span>}):<br/>
&nbsp;&nbsp;(<span class="id">A</span> `&lt;=` <span class="id">B</span>)%<span class="id">mset</span> -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">A</span> &lt;= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">B</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof13')">Proof.</span></div>
<div class="proofscript" id="proof13">
&nbsp;&nbsp;<span class="id">move</span>=&gt;<span class="id">H_sub</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetBDK">msetBDK</a></span> <span class="id">H_sub</span>) <span class="id"><a href="Algorand.safety_helpers.html#mset_add_size">mset_add_size</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_addl">leq_addl</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">If msets are equal after adding seqs to mset <span class="bracket"><span class="id">A</span></span>, this implies seqs have the same elements. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="msetD_seq_mset_perm_eq">msetD_seq_mset_perm_eq</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">A</span>: {<span class="id">mset</span> <span class="id">T</span>}) (<span class="id">l</span> <span class="id">l</span>': <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>):<br/>
&nbsp;&nbsp;<span class="id">A</span> `+` <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#seq_mset">seq_mset</a></span> <span class="id">l</span> = <span class="id">A</span> `+` <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#seq_mset">seq_mset</a></span> <span class="id">l</span>' -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> <span class="id">l</span> <span class="id">l</span>'.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof14')">Proof.</span></div>
<div class="proofscript" id="proof14">
&nbsp;&nbsp;<span class="id">move</span>/(<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#f_equal">f_equal</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetB">msetB</a></span>^~<span class="id">A</span>)); <span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetDKB">msetDKB</a></span> =&gt; <span class="id">H_seq_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_trans">perm_trans</a></span> <span class="id">_</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_eq_seq_mset">perm_eq_seq_mset</a></span> <span class="id">l</span>')).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_sym">perm_sym</a></span> -<span class="id">H_seq_eq</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_eq_seq_mset">perm_eq_seq_mset</a></span>.<br/>
Qed.</div>
<br/>
<h2> Generic sequence lemmas </h2>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="in_memP">in_memP</a></span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#Equality.Exports.eqType">eqType</a></span>) (<span class="id">x</span> : <span class="id">T</span>) <span class="id">l</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#reflect">reflect</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Lists.List.html#In">List.In</a></span> <span class="id">x</span> <span class="id">l</span>) (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#in_mem">in_mem</a></span> <span class="id">x</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#mem">mem</a></span> <span class="id">l</span>)).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof15')">Proof.</span></div>
<div class="proofscript" id="proof15">
<span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#iffP">iffP</a></span> <span class="kwd">with</span> (<span class="id">P</span> := <span class="id">x</span> \<span class="kwd">in</span> <span class="id">l</span>).<br/>
- <span class="kwd">by</span> <span class="id">case</span>: (<span class="id">x</span> \<span class="kwd">in</span> <span class="id">l</span>) =&gt; //; <span class="id">constructor</span>.<br/>
- <span class="id">elim</span>: <span class="id">l</span> =&gt; [|<span class="id">h</span> <span class="id">l</span> <span class="id">IH</span>] //=.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>; <span class="id">case</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">first</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>=&gt;-&gt;; <span class="id">left</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id">IH</span> =&gt; <span class="id">mem_x</span>; <span class="id">right</span>.<br/>
- <span class="id">elim</span>: <span class="id">l</span> =&gt; [|<span class="id">h</span> <span class="id">l</span> <span class="id">IH</span>] //=; <span class="id">case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt;-&gt;; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>; <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">left</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id">IH</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span> =&gt; <span class="id">mem_x</span>; <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">right</span>.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="take_rcons">take_rcons</a></span> <span class="id">T</span> : <span class="kwd">forall</span> (<span class="id">s</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) (<span class="id">x</span> : <span class="id">T</span>), <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">s</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#rcons">rcons</a></span> <span class="id">s</span> <span class="id">x</span>) = <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof16')">Proof.</span></div>
<div class="proofscript" id="proof16">
 <span class="id">elim</span> =&gt; //=; <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">a</span> <span class="id">l</span> <span class="id">IH</span> <span class="id">x</span>; <span class="id">rewrite</span> <span class="id">IH</span>. Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="perm_eq_cons1P">perm_eq_cons1P</a></span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#Equality.Exports.eqType">eqType</a></span>) (<span class="id">s</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) (<span class="id">a</span> : <span class="id">T</span>) : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#reflect">reflect</a></span> (<span class="id">s</span> = [:: <span class="id">a</span>]) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> <span class="id">s</span> [:: <span class="id">a</span>]).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof17')">Proof.</span></div>
<div class="proofscript" id="proof17">
<span class="id">case</span>: <span class="id">s</span> =&gt; [|<span class="id">x</span> <span class="id">s</span>]; <span class="id">first</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> /= ?<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span>; <span class="id">constructor</span>.<br/>
<span class="id">case</span>: <span class="id">s</span> =&gt; [|<span class="id">y</span> <span class="id">s</span>].<br/>
&nbsp;&nbsp;<span class="id">apply</span>: (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#iffP">iffP</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#idP">idP</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> /= ?<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqxx">eqxx</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; [<span class="id">Ht</span> <span class="id">Ht</span>'].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Ht</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hax</span>: (<span class="id">a</span> == <span class="id">x</span>) =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hax</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt;-&gt;; <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_refl">perm_refl</a></span>.<br/>
<span class="id">apply</span>: (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#iffP">iffP</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#idP">idP</a></span>) =&gt; //.<br/>
<span class="id">set</span> <span class="id">s1</span> := [:: <span class="id">_</span> &amp; <span class="id">_</span>].<br/>
<span class="id">set</span> <span class="id">s2</span> := [:: <span class="id">_</span>].<br/>
<span class="id">move</span> =&gt; <span class="id">Hpr</span>.<br/>
<span class="kwd">by</span> <span class="id">have</span> <span class="id">Hs</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">s1</span> = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">s2</span> <span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_size">perm_size</a></span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas relating seqs and sets </h2>
<br/>
<div class="doc">A set derived from an empty seq is the empty set. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="set_nil">set_nil</a></span> : <span class="kwd">forall</span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#Finite.Exports.finType">finType</a></span>), [<span class="id">set</span> <span class="id">x</span> <span class="kwd">in</span> [::]] = @<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#set0">set0</a></span> <span class="id">T</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof18')">Proof.</span></div>
<div class="proofscript" id="proof18">
 <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">T</span>. Qed.</div>
<br/>
<div class="doc">The cardinality of seq as set is size of the unduplicated seq. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="finseq_size">finseq_size</a></span> : <span class="kwd">forall</span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#Finite.Exports.finType">finType</a></span>) (<span class="id">s</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>), #|<span class="id">s</span>| = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#undup">undup</a></span> <span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof19')">Proof.</span></div>
<div class="proofscript" id="proof19">
<span class="id">move</span>=&gt; <span class="id">T</span> <span class="id">s</span>.<br/>
<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#cardsE">cardsE</a></span>.<br/>
<span class="id">elim</span>: <span class="id">s</span> =&gt; //=; <span class="id">first</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#set_nil">set_nil</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#cards0">cards0</a></span>.<br/>
<span class="id">move</span> =&gt; <span class="id">x</span> <span class="id">s</span> <span class="id">IH</span>.<br/>
<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#set_cons">set_cons</a></span> /=.<br/>
<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span> =&gt; //=.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">xs</span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span> <span class="id">Hsuff</span>: <span class="id">x</span> |: [<span class="id">set</span> <span class="id">x0</span> <span class="kwd">in</span> <span class="id">s</span>] = [<span class="id">set</span> <span class="id">x</span> <span class="kwd">in</span> <span class="id">s</span>] <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hsuff</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#setP">setP</a></span> =&gt; <span class="id">y</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#in_setU1">in_setU1</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hxy</span>: (<span class="id">y</span> == <span class="id">x</span>) =&gt; //.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hxy</span>=&gt;-&gt;.<br/>
<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">Hx</span>.<br/>
<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.finset.html#cardsU1">cardsU1</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span> <span class="id">Hx</span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#add1n">add1n</a></span> <span class="id">IH</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A set derived using filter in seq and filter directly have same size. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="imfset_filter_size_lem">imfset_filter_size_lem</a></span> (<span class="id">A</span> <span class="id">B</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.choice.html#Choice.Exports.choiceType">choiceType</a></span>) (<span class="id">f</span> : <span class="id">A</span> -&gt; <span class="id">B</span>) (<span class="id">sq</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">A</span>) (<span class="id">P</span> : <span class="id">A</span> -&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#bool">bool</a></span>):<br/>
&nbsp;&nbsp;#|` [<span class="id">fset</span> <span class="id">x</span> | <span class="id">x</span> <span class="kwd">in</span> [<span class="id">seq</span> <span class="id">f</span> <span class="id">x</span> | <span class="id">x</span> &lt;- <span class="id">sq</span> &amp; <span class="id">P</span> <span class="id">x</span>]]| = #|` [<span class="id">fset</span> <span class="id">f</span> <span class="id">x</span> | <span class="id">x</span> <span class="kwd">in</span> <span class="id">sq</span> &amp; <span class="id">P</span> <span class="id">x</span>]|.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof20')">Proof.</span></div>
<div class="proofscript" id="proof20">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">f</span> <span class="id">sq</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#Imfset.imfsetE">Imfset.imfsetE</a></span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#size_seq_fset">size_seq_fset</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_size">perm_size</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#uniq_perm">uniq_perm</a></span>;[<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#undup_uniq">undup_uniq</a></span>..|].<br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">fx</span>. <span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#map_id">map_id</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#filter_undup">filter_undup</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Bool.Bool.html#eq_true_iff_eq">Bool.eq_true_iff_eq</a></span>;<span class="id">rewrite</span> -!/(<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#is_true">is_true</a></span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">split</span>;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mapP">mapP</a></span> =&gt; [<span class="id">x</span> <span class="id">H_x</span> -&gt;];<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#map_f">map_f</a></span>;<span class="id">move</span>:<span class="id">H_x</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
Qed.</div>
<br/>
<h2> Generic definitions </h2>
<br/>
<div class="doc">Turn <span class="bracket"><span class="id">pred</span></span> on <span class="bracket"><span class="id">UState</span></span> into <span class="bracket"><span class="id">pred</span></span> on <span class="bracket"><span class="id">GState</span></span> - assumed false if <span class="bracket"><span class="id">uid</span></span> not present. </div>
<span class="kwd">Definition</span> <span class="id"><a name="upred">upred</a></span> <span class="id">uid</span> (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>) : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">fun</span> <span class="id">g</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> =&gt; <span class="id">P</span> <span class="id">u</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Turn <span class="bracket"><span class="id">pred</span></span> on <span class="bracket"><span class="id">UState</span></span> into <span class="bracket"><span class="id">pred</span></span> on <span class="bracket"><span class="id">GState</span></span> - assumed true if <span class="bracket"><span class="id">uid</span></span> not present. </div>
<span class="kwd">Definition</span> <span class="id">upred</span>' <span class="id">uid</span> (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span>) : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">fun</span> <span class="id">g</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> =&gt; <span class="id">P</span> <span class="id">u</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#true">true</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<h2> Lemmas about the step of a user state </h2>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_le</span></span> is equivalent to <span class="bracket"><span class="id">step_leb</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_leP">step_leP</a></span>: <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span>, <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#reflect">reflect</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">s1</span> <span class="id">s2</span>) (<span class="id"><a href="Algorand.algorand_model.html#step_leb">step_leb</a></span> <span class="id">s1</span> <span class="id">s2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof21')">Proof.</span></div>
<div class="proofscript" id="proof21">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [[<span class="id">r1</span> <span class="id">p1</span>] <span class="id">s1</span>] [[<span class="id">r2</span> <span class="id">p2</span>] <span class="id">s2</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">H</span>:(<span class="id"><a href="Algorand.algorand_model.html#step_leb">step_leb</a></span> <span class="id">_</span> <span class="id">_</span>);<span class="id">constructor</span>;[|<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="kwd">in</span> <span class="id">H</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> !(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>).<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_lt</span></span> is equivalent to <span class="bracket"><span class="id">step_ltb</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_ltP">step_ltP</a></span>: <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span>, <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#reflect">reflect</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">s1</span> <span class="id">s2</span>) (<span class="id"><a href="Algorand.algorand_model.html#step_ltb">step_ltb</a></span> <span class="id">s1</span> <span class="id">s2</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof22')">Proof.</span></div>
<div class="proofscript" id="proof22">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [[<span class="id">r1</span> <span class="id">p1</span>] <span class="id">s1</span>] [[<span class="id">r2</span> <span class="id">p2</span>] <span class="id">s2</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">H</span>:(<span class="id"><a href="Algorand.algorand_model.html#step_ltb">step_ltb</a></span> <span class="id">_</span> <span class="id">_</span>);<span class="id">constructor</span>;[|<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="kwd">in</span> <span class="id">H</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> !(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#reflect_eq">reflect_eq</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>).<br/>
Qed.</div>
<br/>
<div class="doc">Weaken step: less-than implies less-than-or-equal. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_ltW">step_ltW</a></span> <span class="id">a</span> <span class="id">b</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">b</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">a</span> <span class="id">b</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof23')">Proof.</span></div>
<div class="proofscript" id="proof23">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [[? ?] ?],<span class="id">b</span> <span class="kwd">as</span> [[? ?]?].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span>,<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span>;<span class="id">intuition</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Transitivitity of <span class="bracket"><span class="id">step_le</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_le_trans">step_le_trans</a></span> <span class="id">a</span> <span class="id">b</span> <span class="id">c</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">a</span> <span class="id">b</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">b</span> <span class="id">c</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">a</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof24')">Proof.</span></div>
<div class="proofscript" id="proof24">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [[? ?] ?],<span class="id">b</span> <span class="kwd">as</span> [[? ?]?],<span class="id">c</span> <span class="kwd">as</span> [[? ?]?].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_trans">leq_trans</a></span>;<span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Transitivity of <span class="bracket"><span class="id">step_lt</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_lt_trans">step_lt_trans</a></span> <span class="id">a</span> <span class="id">b</span> <span class="id">c</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">b</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">b</span> <span class="id">c</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof25')">Proof.</span></div>
<div class="proofscript" id="proof25">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [[? ?] ?],<span class="id">b</span> <span class="kwd">as</span> [[? ?]?],<span class="id">c</span> <span class="kwd">as</span> [[? ?]?].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">a</span> &lt; <span class="id">b</span></span> and <span class="bracket"><span class="id">b</span> &lt;= <span class="id">c</span></span> implies <span class="bracket"><span class="id">a</span> &lt; <span class="id">c</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_lt_le_trans">step_lt_le_trans</a></span> <span class="id">a</span> <span class="id">b</span> <span class="id">c</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">b</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">b</span> <span class="id">c</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof26')">Proof.</span></div>
<div class="proofscript" id="proof26">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [[? ?] ?],<span class="id">b</span> <span class="kwd">as</span> [[? ?]?],<span class="id">c</span> <span class="kwd">as</span> [[? ?]?].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span>, <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_trans">leq_trans</a></span>;<span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">a</span> &lt;= <span class="id">b</span></span> and <span class="bracket"><span class="id">b</span> &lt; <span class="id">c</span></span> implies <span class="bracket"><span class="id">a</span> &lt; <span class="id">c</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_le_lt_trans">step_le_lt_trans</a></span> <span class="id">a</span> <span class="id">b</span> <span class="id">c</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">a</span> <span class="id">b</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">b</span> <span class="id">c</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> <span class="id">a</span> <span class="id">c</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof27')">Proof.</span></div>
<div class="proofscript" id="proof27">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">a</span> <span class="kwd">as</span> [[? ?] ?],<span class="id">b</span> <span class="kwd">as</span> [[? ?]?],<span class="id">c</span> <span class="kwd">as</span> [[? ?]?].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span>, <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_ab</span> <span class="kwd">as</span> [<span class="id">H_ab</span>|[-&gt; <span class="id">H_ab</span>]];<span class="id">destruct</span> <span class="id">H_bc</span> <span class="kwd">as</span> [<span class="id">H_bc</span>|[-&gt; <span class="id">H_bc</span>]];[<span class="id">left</span>..|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltn_trans">ltn_trans</a></span>;<span class="id">eassumption</span>|<span class="id">assumption</span>|<span class="id">assumption</span>|];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">right</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|];<span class="id">clear</span> -<span class="id">H_ab</span> <span class="id">H_bc</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_ltn_trans">leq_ltn_trans</a></span>;<span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step</span></span> is not less than itself. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_lt_irrefl">step_lt_irrefl</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>: ~<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof28')">Proof.</span></div>
<div class="proofscript" id="proof28">
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> =&gt; <span class="id">Hrp</span>; <span class="id">case</span>: <span class="id">Hrp</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> //.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt; ?; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span>; <span class="id">case</span> =&gt; //; <span class="id">case</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step</span></span> is less than or equal to itself. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_le_refl">step_le_refl</a></span> <span class="id">step</span>: <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">step</span> <span class="id">step</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof29')">Proof.</span></div>
<div class="proofscript" id="proof29">
&nbsp;&nbsp;<span class="id">clear</span>;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span>;<span class="id">intuition</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">ustate_after</span></span> and <span class="bracket"><span class="id">step_le</span></span> are equivalent. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="ustate_after_iff_step_le">ustate_after_iff_step_le</a></span> <span class="id">u1</span> <span class="id">u2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u1</span>) (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u2</span>)<br/>
&nbsp;&nbsp;&lt;-&gt; <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">u1</span> <span class="id">u2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof30')">Proof.</span></div>
<div class="proofscript" id="proof30">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span>;<span class="id">destruct</span> <span class="id">u1</span>, <span class="id">u2</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span>;<span class="id">tauto</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Transitivity of <span class="bracket"><span class="id">ustate_after</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="ustate_after_transitive">ustate_after_transitive</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">us3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us2</span> <span class="id">us3</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us3</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof31')">Proof.</span></div>
<div class="proofscript" id="proof31">
<span class="id">move</span> =&gt; <span class="id">us1</span> <span class="id">us2</span> <span class="id">us3</span>.<br/>
<span class="id">rewrite</span> -!<span class="id"><a href="Algorand.safety_helpers.html#ustate_after_iff_step_le">ustate_after_iff_step_le</a></span>.<br/>
<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_le_trans">step_le_trans</a></span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas about tick functions </h2>
<br/>
<div class="doc"><span class="bracket"><span class="id">tick_ok_users</span></span> function as a predicate. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="tick_ok_usersP">tick_ok_usersP</a></span> : <span class="kwd">forall</span> <span class="id">increment</span> (<span class="id">g</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>),<br/>
&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#reflect">reflect</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> (<span class="id">uid</span> : <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) (<span class="id">h</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)), <span class="id"><a href="Algorand.algorand_model.html#user_can_advance_timer">user_can_advance_timer</a></span> <span class="id">increment</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">h</span>])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#tick_ok_users">tick_ok_users</a></span> <span class="id">increment</span> <span class="id">g</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof32')">Proof.</span></div>
<div class="proofscript" id="proof32">
<span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">g</span>.<br/>
<span class="id">exact</span>: <span class="id"><a href="Algorand.fmap_ext.html#allfP">allfP</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Domain of users unchanged after tick. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="tick_users_domf">tick_users_domf</a></span> : <span class="kwd">forall</span> <span class="id">increment</span> <span class="id">pre</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span> <span class="id">increment</span> <span class="id">pre</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof33')">Proof.</span></div>
<div class="proofscript" id="proof33">
<span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">pre</span>.<br/>
<span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">tick_users</span></span> at <span class="bracket"><span class="id">uid</span></span> results in <span class="bracket"><span class="id">user_advance_timer</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="tick_users_upd">tick_users_upd</a></span> : <span class="kwd">forall</span> <span class="id">increment</span> <span class="id">pre</span> <span class="id">uid</span> (<span class="id">h</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span> <span class="id">increment</span> <span class="id">pre</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span> <span class="id">increment</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">h</span>]).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof34')">Proof.</span></div>
<div class="proofscript" id="proof34">
<span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">pre</span> <span class="id">uid</span> <span class="id">h</span>.<br/>
<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">tick_users</span></span> results in <span class="bracket"><span class="id">None</span></span> if the user not in the domain of the pre-state. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="tick_users_notin">tick_users_notin</a></span> : <span class="kwd">forall</span> <span class="id">increment</span> <span class="id">pre</span> <span class="id">uid</span> (<span class="id">h</span> : <span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span> <span class="id">increment</span> <span class="id">pre</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof35')">Proof.</span></div>
<div class="proofscript" id="proof35">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">pre</span> <span class="id">uid</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span> <span class="id">increment</span> <span class="id">pre</span>)); <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas about <span class="bracket"><span class="id">merge_msgs_deadline</span></span> and <span class="bracket"><span class="id">send_broadcasts</span></span> </h2>
<br/>
<div class="doc">A message in <span class="bracket"><span class="id">merge_msgs_deadline</span></span> is either already in the mailbox or
   it is a member of the messages being merged. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="in_merge_msgs">in_merge_msgs</a></span> : <span class="kwd">forall</span> <span class="id">d</span> (<span class="id">msg</span>:<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>) <span class="id">now</span> <span class="id">msgs</span> <span class="id">mailbox</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">d</span>,<span class="id">msg</span>) \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#merge_msgs_deadline">merge_msgs_deadline</a></span> <span class="id">now</span> <span class="id">msgs</span> <span class="id">mailbox</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">msg</span> \<span class="kwd">in</span> <span class="id">msgs</span> \/ (<span class="id">d</span>,<span class="id">msg</span>) \<span class="kwd">in</span> <span class="id">mailbox</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof36')">Proof.</span></div>
<div class="proofscript" id="proof36">
&nbsp;&nbsp;<span class="id">move</span>=&gt; <span class="id">d</span> <span class="id">msg</span> <span class="id">now</span> <span class="id">msgs</span> <span class="id">mb</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>=&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetDP">msetDP</a></span> [|];[|<span class="id">right</span>;<span class="id">done</span>].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_mem">perm_mem</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#perm_eq_seq_mset">perm_eq_seq_mset</a></span> <span class="id">_</span>)) =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mapP">mapP</a></span> [<span class="id">x</span> <span class="id">H_x</span> [<span class="id">_</span> -&gt;]];<span class="id">left</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">send_broadcasts</span></span> definition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="send_broadcastsE">send_broadcastsE</a></span> <span class="id">now</span> <span class="id">targets</span> <span class="id">prev_msgs</span> <span class="id">msgs</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">now</span> <span class="id">targets</span> <span class="id">prev_msgs</span> <span class="id">msgs</span> = <span class="id"><a href="Algorand.fmap_ext.html#updf">updf</a></span> <span class="id">prev_msgs</span> <span class="id">targets</span> (<span class="kwd">fun</span> <span class="id">_</span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#merge_msgs_deadline">merge_msgs_deadline</a></span> <span class="id">now</span> <span class="id">msgs</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof37')">Proof.</span></div>
<div class="proofscript" id="proof37">
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssreflect.html#unlock">unlock</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">send_broadcasts</span></span> at <span class="bracket"><span class="id">uid</span></span> results in <span class="bracket"><span class="id">merge_msgs_deadline</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="send_broadcasts_in">send_broadcasts_in</a></span> : <span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span> <span class="id">uid</span> <span class="id">msgs</span> <span class="id">targets</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">h</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">msgpool</span>) (<span class="id">h</span>' : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">targets</span>),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">now</span> <span class="id">targets</span> <span class="id">msgpool</span> <span class="id">msgs</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id"><a href="Algorand.algorand_model.html#merge_msgs_deadline">merge_msgs_deadline</a></span> <span class="id">now</span> <span class="id">msgs</span> <span class="id">msgpool</span>.[<span class="id">h</span>]).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof38')">Proof.</span></div>
<div class="proofscript" id="proof38">
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; *;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">send_brodcasts</span></span> results in <span class="bracket"><span class="id">None</span></span> if <span class="bracket"><span class="id">uid</span></span> is not in the domain of <span class="bracket"><span class="id">msgpool</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="send_broadcast_notin">send_broadcast_notin</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span> <span class="id">uid</span> <span class="id">msgs</span> <span class="id">targets</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">h</span> : <span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">msgpool</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">now</span> <span class="id">targets</span> <span class="id">msgpool</span> <span class="id">msgs</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof39')">Proof.</span></div>
<div class="proofscript" id="proof39">
&nbsp;&nbsp;<span class="id">move</span> =&gt; *;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (?<span class="id">k</span> \<span class="id">notin</span> ?<span class="id">f</span>) <span class="kwd">with</span> (<span class="id">k</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rtopology.html#f">f</a></span>).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">send_brodcasts</span></span> at <span class="bracket"><span class="id">uid</span></span> results in <span class="bracket"><span class="id">msgpool</span></span> at <span class="bracket"><span class="id">uid</span></span> if <span class="bracket"><span class="id">uid</span></span> is in <span class="bracket"><span class="id">msgpool</span></span>,
but uid is not in targets of <span class="bracket"><span class="id">send_broadcasts</span></span> function. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="send_broadcast_notin_targets">send_broadcast_notin_targets</a></span> : <span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span> <span class="id">uid</span> <span class="id">msgs</span> <span class="id">targets</span><br/>
&nbsp;&nbsp;(<span class="id">h</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">msgpool</span>) (<span class="id">h</span>' : <span class="id">uid</span> \<span class="id">notin</span> <span class="id">targets</span>),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">now</span> <span class="id">targets</span> <span class="id">msgpool</span> <span class="id">msgs</span>).[? <span class="id">uid</span>] = <span class="id">msgpool</span>.[? <span class="id">uid</span>].<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof40')">Proof.</span></div>
<div class="proofscript" id="proof40">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">msgpool</span> <span class="id">now</span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">targets</span> <span class="id">h</span> <span class="id">h</span>'.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span> <span class="id">updf_update</span>' // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">send_broadcast</span></span> contains <span class="bracket"><span class="id">msg</span></span> but original mailbox does not, <span class="bracket"><span class="id">msg</span></span> must be in <span class="bracket"><span class="id">l</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="broadcasts_prop">broadcasts_prop</a></span><br/>
&nbsp;&nbsp;<span class="id">uid</span> (<span class="id">msg</span>:<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>) (<span class="id">l</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>)<br/>
&nbsp;&nbsp;<span class="id">time</span> (<span class="id">targets</span> : {<span class="id">fset</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>}) (<span class="id">mailboxes</span>' <span class="id">mailboxes</span> : {<span class="id">fmap</span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span> -&gt; {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>}}):<br/>
&nbsp;&nbsp;(<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> <span class="id">mailboxes</span>'.[? <span class="id">uid</span>] `&lt;=` <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> <span class="id">mailboxes</span>.[? <span class="id">uid</span>])%<span class="id">mset</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">match</span> (<span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">time</span> <span class="id">targets</span> <span class="id">mailboxes</span>' <span class="id">l</span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">msg_mset</span> =&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="kwd">fun</span> <span class="id">p</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span> =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>) <span class="id">msg_mset</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span> -&gt;<br/>
&nbsp;&nbsp;~~<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">mailboxes</span>.[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">msg_mset</span> =&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="kwd">fun</span> <span class="id">p</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span> =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>) <span class="id">msg_mset</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span> -&gt; <span class="id">msg</span> \<span class="kwd">in</span> <span class="id">l</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof41')">Proof.</span></div>
<div class="proofscript" id="proof41">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_sub</span> <span class="id">H_pre</span> <span class="id">H_post</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>: ~~<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="kwd">fun</span> <span class="id">p</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span> =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>) (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> <span class="id">mailboxes</span>.[?<span class="id">uid</span>])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> <span class="id">H_post</span>;[|<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#enum_mset0">enum_mset0</a></span>].<br/>
&nbsp;&nbsp;<span class="id">move</span> {<span class="id">H_post</span>} =&gt; <span class="id">H_post</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span> <span class="kwd">in</span> <span class="id">H_pre</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">mailboxes</span>'.[?<span class="id">uid</span>]/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> =&gt; <span class="id">H_mb</span>';<br/>
&nbsp;&nbsp;&nbsp;[|<span class="kwd">by</span> <span class="id">move</span>:<span class="id">H_pre</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> //;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">congr</span> (<span class="id">uid</span> \<span class="id">notin</span> <span class="id">_</span>): <span class="id">H_mb</span>';<span class="id">apply</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span>: ~~<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="kwd">fun</span> <span class="id">p</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span> =&gt; <span class="id">p</span>.2 == <span class="id">msg</span>) (<span class="id">mailboxes</span>'.[<span class="id">H_mb</span>'])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNN">contraNN</a></span>:<span class="id">H_post</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> /= [<span class="id">x</span> <span class="id">H_in</span> <span class="id">H_x</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span>;<span class="kwd">exists</span> <span class="id">x</span>;[<span class="id">apply</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msubset_subset">msubset_subset</a></span> <span class="id">H_sub</span>);<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>|].<br/>
&nbsp;&nbsp;<span class="id">move</span> {<span class="id">H_post</span>} =&gt; <span class="id">H_post</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: {<span class="id">mailboxes</span> <span class="id">H_sub</span>}<span class="id">H_pre</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">case</span>:(<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">targets</span>)/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#boolP">boolP</a></span>=&gt;<span class="id">H_tgt</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[|<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraTT">contraTT</a></span>;<span class="id">rewrite</span> <span class="id">updf_update</span>'].<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> {<span class="id">targets</span> <span class="id">H_tgt</span>}// =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> /=[[<span class="id">d</span> <span class="id">msg</span>'] <span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> /=<span class="id">H_msg</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_msg</span> <span class="id">H_in</span>=&gt; {<span class="id">msg</span>'}-&gt; /<span class="id"><a href="Algorand.safety_helpers.html#in_merge_msgs">in_merge_msgs</a></span> [//|<span class="id">H_in</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="kwd">in</span> <span class="id">H_post</span>;<span class="id">contradict</span> <span class="id">H_post</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span>;<span class="kwd">exists</span> (<span class="id">d</span>,<span class="id">msg</span>).<br/>
Qed.</div>
<br/>
<h2> Definition of <span class="bracket"><span class="id">onth</span></span>, lemmas about <span class="bracket"><span class="id">onth</span></span> and <span class="bracket"><span class="id">step</span></span> </h2>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span>: option returning <span class="bracket"><span class="id">n</span></span>th element of seq if <span class="bracket"><span class="id">n</span></span> small enough. </div>
<span class="kwd">Definition</span> <span class="id"><a name="onth">onth</a></span> {<span class="id">T</span> : <span class="kwd">Type</span>} (<span class="id">s</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) (<span class="id">n</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#option">option</a></span> <span class="id">T</span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#ohead">ohead</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">s</span>).<br/>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span> results in <span class="bracket"><span class="id">Some</span></span> if the index is small. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_size">onth_size</a></span> : <span class="kwd">forall</span> <span class="id">T</span> (<span class="id">s</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) <span class="id">n</span> <span class="id">x</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span> -&gt; <span class="id">n</span> &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof42')">Proof.</span></div>
<div class="proofscript" id="proof42">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">T</span> <span class="id">s</span> <span class="id">n</span> <span class="id">x</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">contradict</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_oversize">drop_oversize</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">If <span class="bracket"><span class="id">onth</span></span> of a prefix is not <span class="bracket"><span class="id">None</span></span> then <span class="bracket"><span class="id">onth</span></span> of the original sequence is the same. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_from_prefix">onth_from_prefix</a></span> <span class="id">T</span> (<span class="id">s</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) <span class="id">k</span> <span class="id">n</span> <span class="id">x</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">k</span> <span class="id">s</span>) <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof43')">Proof.</span></div>
<div class="proofscript" id="proof43">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_prefix</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_inbounds</span>: <span class="id">n</span> &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">k</span> <span class="id">s</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span>;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_oversize</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_oversize">drop_oversize</a></span> <span class="kwd">in</span> <span class="id">H_prefix</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_prefix</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#ohead">ohead</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -{2}(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#cat_take_drop">cat_take_drop</a></span> <span class="id">k</span> <span class="id">s</span>) <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_cat">drop_cat</a></span> <span class="id">H_inbounds</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">k</span> <span class="id">s</span>)).<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span> equal to <span class="bracket"><span class="id">Some</span> <span class="id">x</span></span> implies <span class="bracket"><span class="id">n</span></span>th element is <span class="bracket"><span class="id">x</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_nth">onth_nth</a></span> <span class="id">T</span> (<span class="id">s</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) <span class="id">ix</span> <span class="id">x</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span> -&gt; (<span class="kwd">forall</span> <span class="id">x0</span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth">nth</a></span> <span class="id">x0</span> <span class="id">s</span> <span class="id">ix</span> = <span class="id">x</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof44')">Proof.</span></div>
<div class="proofscript" id="proof44">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#ohead">ohead</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_drop</span> <span class="id">x0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">ix</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_drop">nth_drop</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">ix</span> <span class="id">s</span>);<span class="id">simpl</span>;<span class="id">congruence</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span> equal to <span class="bracket"><span class="id">Some</span> <span class="id">x</span></span> means <span class="bracket"><span class="id">x</span></span> is in the sequence. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_in">onth_in</a></span> (<span class="id">T</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#Equality.Exports.eqType">eqType</a></span>) (<span class="id">s</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) <span class="id">ix</span> <span class="id">x</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span> -&gt; <span class="id">x</span> \<span class="kwd">in</span> <span class="id">s</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof45')">Proof.</span></div>
<div class="proofscript" id="proof45">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -(<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H</span> <span class="id">x</span>).<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_nth">mem_nth</a></span> <span class="id">_</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H</span>)).<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span> equal to <span class="bracket"><span class="id">Some</span> <span class="id">x</span></span> means that the last element of the prefixed sequence is <span class="bracket"><span class="id">x</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_take_last">onth_take_last</a></span> <span class="id">T</span> (<span class="id">s</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>) <span class="id">n</span> <span class="id">x</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#some">some</a></span> <span class="id">x</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">x0</span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last">last</a></span> <span class="id">x0</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">n</span>.+1 <span class="id">s</span>) = <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof46')">Proof.</span></div>
<div class="proofscript" id="proof46">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_x</span> <span class="id">x0</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_size</span> := <span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_x</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_last">nth_last</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_takel">size_takel</a></span> // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_take">nth_take</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Predicates true for all elements of a sequence are true for elements returned by <span class="bracket"><span class="id">onth</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="all_onth">all_onth</a></span> <span class="id">T</span> <span class="id">P</span> <span class="id">s</span>: @<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all">all</a></span> <span class="id">T</span> <span class="id">P</span> <span class="id">s</span> -&gt; <span class="kwd">forall</span> <span class="id">ix</span> <span class="id">x</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span> -&gt; <span class="id">P</span> <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof47')">Proof.</span></div>
<div class="proofscript" id="proof47">
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all_nthP">all_nthP</a></span> =&gt; <span class="id">H</span> <span class="id">ix</span> <span class="id">x</span> <span class="id">H_g</span>. <span class="id">rewrite</span> -(<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_g</span> <span class="id">x</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>, (<span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_g</span>).<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">x</span></span> in <span class="bracket"><span class="id">s</span></span> implies <span class="bracket"><span class="id">onth</span></span> (the index of <span class="bracket"><span class="id">x</span></span> in <span class="bracket"><span class="id">s</span></span>) is <span class="bracket"><span class="id">x</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_index">onth_index</a></span> (<span class="id">T</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#Equality.Exports.eqType">eqType</a></span>) (<span class="id">x</span> : <span class="id">T</span>) (<span class="id">s</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id">T</span>): <span class="id">x</span> \<span class="kwd">in</span> <span class="id">s</span> -&gt; <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">s</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#index">index</a></span> <span class="id">x</span> <span class="id">s</span>) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof48')">Proof.</span></div>
<div class="proofscript" id="proof48">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#ohead">ohead</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_nth">drop_nth</a></span> <span class="id">x</span>);[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_index">nth_index</a></span>|<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#index_mem">index_mem</a></span>].<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">at_step</span></span> holds for <span class="bracket"><span class="id">n</span></span>th element with <span class="bracket"><span class="id">P</span></span> and <span class="bracket"><span class="id">n</span></span>th element is <span class="bracket"><span class="id">g</span></span>, then <span class="bracket"><span class="id">P</span> <span class="id">g</span></span> holds. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="at_step_onth">at_step_onth</a></span> <span class="id">n</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#at_step">at_step</a></span> <span class="id">n</span> <span class="id">path</span> <span class="id">P</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">path</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof49')">Proof.</span></div>
<div class="proofscript" id="proof49">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#at_step">at_step</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hdrop</span>: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">path</span>) =&gt; [|<span class="id">a</span> <span class="id">l</span>] //=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">HP</span> <span class="id">g</span>; <span class="id">case</span> =&gt;&lt;-.<br/>
Qed.</div>
<br/>
<div class="doc">If <span class="bracket"><span class="id">n</span></span>th element is <span class="bracket"><span class="id">g</span></span> and <span class="bracket"><span class="id">P</span> <span class="id">g</span></span> holds, then <span class="bracket"><span class="id">at_step</span></span> holds for <span class="bracket"><span class="id">n</span></span> and <span class="bracket"><span class="id">P</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_at_step">onth_at_step</a></span> <span class="id">n</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) <span class="id">g</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">path</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>), <span class="id">P</span> <span class="id">g</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#at_step">at_step</a></span> <span class="id">n</span> <span class="id">path</span> <span class="id">P</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof50')">Proof.</span></div>
<div class="proofscript" id="proof50">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#at_step">at_step</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hdrop</span>: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">path</span>) =&gt; [|<span class="id">a</span> <span class="id">l</span>] //=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;&lt;-.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">onth</span></span> is true at <span class="bracket"><span class="id">ix</span></span> implies <span class="bracket"><span class="id">onth</span></span> is true at truncated trace for size of new trace minus one. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="onth_take_some">onth_take_some</a></span> : <span class="kwd">forall</span> (<span class="id">trace</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) <span class="id">ix</span> <span class="id">g</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">ix</span>.+1 <span class="id">trace</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">ix</span>.+1 <span class="id">trace</span>)).-1 = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof51')">Proof.</span></div>
<div class="proofscript" id="proof51">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">trace</span> <span class="id">ix</span> <span class="id">g</span> <span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_onth</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>.<br/>
&nbsp;&nbsp;<span class="id">erewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_nth">drop_nth</a></span> <span class="kwd">with</span> (<span class="id">x0</span>:=<span class="id">g</span>). <span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_last">nth_last</a></span>. <span class="id">erewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#onth_take_last">onth_take_last</a></span> <span class="kwd">with</span> (<span class="id">x</span>:=<span class="id">g</span>); <span class="id">try</span> <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>. <span class="id">inversion</span> <span class="id">H_onth</span>. <span class="id">intuition</span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas about <span class="bracket"><span class="id">step_in_path_at</span></span> </h2>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> implies a global transition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="transition_from_path">transition_from_path</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">states</span> <span class="id">ix</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">states</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H_step</span> : <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">states</span>):<br/>
&nbsp;&nbsp;<span class="id">g1</span> ~~&gt; <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof52')">Proof.</span></div>
<div class="proofscript" id="proof52">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">states</span>. <span class="id">inversion</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path</span>]; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_path</span>} := <span class="id">path_drop</span>' <span class="id">H_path</span> <span class="id">ix</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">ix</span> (<span class="id">g</span> :: <span class="id">states</span>));[<span class="id">done</span>|].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">l</span>;[<span class="id">done</span>|].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> [-&gt; -&gt;].<br/>
&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; [] /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> with same index must be with same states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_ix_same">step_ix_same</a></span> <span class="id">trace</span> <span class="id">ix</span> <span class="id">g1</span> <span class="id">g2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g3</span> <span class="id">g4</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g3</span> <span class="id">g4</span> <span class="id">ix</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">g3</span> = <span class="id">g1</span> /\ <span class="id">g4</span> = <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof53')">Proof.</span></div>
<div class="proofscript" id="proof53">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">ix</span> <span class="id">trace</span>) <span class="kwd">as</span> [|? [|]];(<span class="id">tauto</span> || <span class="id">intuition</span> <span class="id">congruence</span>).<br/>
Qed.</div>
<br/>
<div class="doc">A step in path at <span class="bracket"><span class="id">n</span></span> from <span class="bracket"><span class="id">g1</span></span> to <span class="bracket"><span class="id">g2</span></span> means <span class="bracket"><span class="id">g1</span></span> is at index <span class="bracket"><span class="id">n</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_in_path_onth_pre">step_in_path_onth_pre</a></span> {<span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span>} (<span class="id">H_step</span> : <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span>)<br/>
&nbsp;&nbsp;: <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">path</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof54')">Proof.</span></div>
<div class="proofscript" id="proof54">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>. <span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">path</span>) <span class="kwd">as</span> [|? []];<span class="id">destruct</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span>;<span class="id">reflexivity</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> from <span class="bracket"><span class="id">g1</span></span> to <span class="bracket"><span class="id">g2</span></span> with <span class="bracket"><span class="id">n</span></span> means <span class="bracket"><span class="id">g2</span></span> is at index <span class="bracket"><span class="id">n</span>+1</span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_in_path_onth_post">step_in_path_onth_post</a></span> {<span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span>} (<span class="id">H_step</span> : <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span>)<br/>
&nbsp;&nbsp;: <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">path</span> <span class="id">n</span>.+1 = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof55')">Proof.</span></div>
<div class="proofscript" id="proof55">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>. <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#add1n">add1n</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_drop">drop_drop</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">path</span>) <span class="kwd">as</span> [|? []];<span class="id">destruct</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H0</span>;<span class="id">reflexivity</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> of truncated path implies <span class="bracket"><span class="id">step_in_path_at</span></span> of original path. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_in_path_prefix">step_in_path_prefix</a></span> (<span class="id">g1</span> <span class="id">g2</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) <span class="id">n</span> <span class="id">k</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) :<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">k</span> <span class="id">path</span>)<br/>
&nbsp;&nbsp;-&gt; <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof56')">Proof.</span></div>
<div class="proofscript" id="proof56">
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">k</span> <span class="id">path</span>;<span class="id">induction</span> <span class="id">n</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">k</span> <span class="id">path</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">path</span>;[<span class="id">done</span>|];<span class="id">destruct</span> <span class="id">k</span>;[<span class="id">done</span>|];<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">path</span>;[<span class="id">done</span>|];<span class="id">destruct</span> <span class="id">k</span>;<span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">k</span> <span class="id">path</span>. <span class="id">destruct</span> <span class="id">k</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span>;<span class="id">intro</span>;<span class="id">exfalso</span>;<span class="id">destruct</span> <span class="id">path</span>;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">path</span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>. <span class="id">apply</span> <span class="id">IHn</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> implies <span class="bracket"><span class="id">step_in_path_at</span></span> of truncated path provided the truncation
is sufficiently long. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="step_in_path_take">step_in_path_take</a></span> (<span class="id">g1</span> <span class="id">g2</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) <span class="id">n</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) :<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">path</span><br/>
&nbsp;&nbsp;-&gt; <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">n</span>.+2 <span class="id">path</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof57')">Proof.</span></div>
<div class="proofscript" id="proof57">
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">path</span>; <span class="id">induction</span> <span class="id">n</span>.<br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">path</span>;[<span class="id">done</span>|];<span class="id">destruct</span> <span class="id">path</span>;<span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">path</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">path</span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>. <span class="id">apply</span> <span class="id">IHn</span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas on <span class="bracket"><span class="id">reset_msg_delays</span></span> and <span class="bracket"><span class="id">reset_user_msg_delays</span></span> </h2>
<br/>
<div class="doc">Reset_deadline in <span class="bracket"><span class="id">reset_user_msg_delays</span></span> if <span class="bracket"><span class="id">m</span></span> is in <span class="bracket"><span class="id">msgs</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="reset_msg_delays_fwd">reset_msg_delays_fwd</a></span> : <span class="kwd">forall</span> (<span class="id">msgs</span> : {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>}) (<span class="id">m</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>),<br/>
&nbsp;&nbsp;<span class="id">m</span> \<span class="kwd">in</span> <span class="id">msgs</span> -&gt; <span class="kwd">forall</span> <span class="id">now</span>, (<span class="id"><a href="Algorand.algorand_model.html#reset_deadline">reset_deadline</a></span> <span class="id">now</span> <span class="id">m</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> <span class="id">msgs</span> <span class="id">now</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof58')">Proof.</span></div>
<div class="proofscript" id="proof58">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">msgs</span> <span class="id">m</span> <span class="id">Hm</span> <span class="id">now</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_pred1">has_pred1</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_count">has_count</a></span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hcnt</span>: (0 &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#count_mem">count_mem</a></span> <span class="id">m</span> <span class="id">msgs</span>) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_count">has_count</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_pred1">has_pred1</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_trans">leq_trans</a></span>;[<span class="id">eassumption</span>|<span class="id">clear</span> <span class="id">Hcnt</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#count_mem_mset">count_mem_mset</a></span> (<span class="id"><a href="Algorand.algorand_model.html#reset_deadline">reset_deadline</a></span> <span class="id">now</span> <span class="id">m</span>) (<span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> <span class="id">msgs</span> <span class="id">now</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> -<span class="id"><a href="Algorand.safety_helpers.html#map_mset_count">map_mset_count</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#sub_count">sub_count</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">H</span> /= /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> -&gt;.<br/>
Qed.</div>
<br/>
<div class="doc">If <span class="bracket"><span class="id">m</span></span> was in <span class="bracket"><span class="id">reset_user_msg_delays</span></span> then the deadline must have been reset. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="reset_user_msg_delays_rev">reset_user_msg_delays_rev</a></span> (<span class="id">now</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>) (<span class="id">msgs</span> : {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span> * <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>}) (<span class="id">m</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>*<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>):<br/>
&nbsp;&nbsp;<span class="id">m</span> \<span class="kwd">in</span> <span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> <span class="id">msgs</span> <span class="id">now</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d0</span>, <span class="id">m</span> = <span class="id"><a href="Algorand.algorand_model.html#reset_deadline">reset_deadline</a></span> <span class="id">now</span> (<span class="id">d0</span>,<span class="id">m</span>.2) /\ (<span class="id">d0</span>,<span class="id">m</span>.2) \<span class="kwd">in</span> <span class="id">msgs</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof59')">Proof.</span></div>
<div class="proofscript" id="proof59">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hm</span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span>: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has">has</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#preim">preim</a></span> (<span class="id"><a href="Algorand.algorand_model.html#reset_deadline">reset_deadline</a></span> <span class="id">now</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#pred1">pred1</a></span> <span class="id">m</span>)) <span class="id">msgs</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">m</span> <span class="id">Hm</span> =&gt; [<span class="id">d</span> <span class="id">msg</span>] <span class="id">Hm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#hasP">hasP</a></span> =&gt; [[<span class="id">d0</span> <span class="id">msg0</span>] <span class="id">H_mem</span> <span class="id">H_preim</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_preim</span>; <span class="id">rewrite</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#preim">preim</a></span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#pred1">pred1</a></span> /= /<span class="id"><a href="Algorand.algorand_model.html#reset_deadline">reset_deadline</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> =&gt; <span class="id">Hn</span> <span class="id">Hd</span>; <span class="id">rewrite</span> -<span class="id">Hd</span> -<span class="id">Hn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="kwd">exists</span> <span class="id">d0</span>; <span class="id">split</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_count">has_count</a></span> <span class="id"><a href="Algorand.safety_helpers.html#map_mset_count">map_mset_count</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#count_mem_mset">count_mem_mset</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_count">has_count</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#has_pred1">has_pred1</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The domain of <span class="bracket"><span class="id">msgpool</span></span> is unchanged after <span class="bracket"><span class="id">reset_msg_delays</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="reset_msg_delays_domf">reset_msg_delays_domf</a></span> : <span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">msgpool</span> = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span> <span class="id">msgpool</span> <span class="id">now</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof60')">Proof.</span></div>
<div class="proofscript" id="proof60">
 <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">msgpool</span> <span class="id">pre</span>; <span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>. Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">reset_msg_delays</span></span> at <span class="bracket"><span class="id">uid</span></span> results in <span class="bracket"><span class="id">reset_user_msg_delays</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="reset_msg_delays_upd">reset_msg_delays_upd</a></span> : <span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span> <span class="id">uid</span> (<span class="id">h</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">msgpool</span>),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span> <span class="id">msgpool</span> <span class="id">now</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> (<span class="id"><a href="Algorand.algorand_model.html#reset_user_msg_delays">reset_user_msg_delays</a></span> <span class="id">msgpool</span>.[<span class="id">h</span>] <span class="id">now</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof61')">Proof.</span></div>
<div class="proofscript" id="proof61">
<span class="id">move</span> =&gt; <span class="id">msgpool</span> <span class="id">now</span> <span class="id">uid</span> <span class="id">h</span>.<br/>
<span class="id">have</span> <span class="id">Hu</span> := <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> <span class="id">_</span> <span class="id">h</span>.<br/>
<span class="id">have</span> <span class="id">Hu</span>' := <span class="id">Hu</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">msgpool</span>) <span class="id">_</span> <span class="id">h</span>.<br/>
<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hu</span>'.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">reset_msg_delays</span></span> results in <span class="bracket"><span class="id">None</span></span> if the user is not in the domain of the message pool. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="reset_msg_delays_notin">reset_msg_delays_notin</a></span> : <span class="kwd">forall</span> (<span class="id">msgpool</span> : <span class="id"><a href="Algorand.algorand_model.html#MsgPool">MsgPool</a></span>) <span class="id">now</span> <span class="id">uid</span><br/>
&nbsp;&nbsp;(<span class="id">h</span> : <span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">msgpool</span>),<br/>
&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span> <span class="id">msgpool</span> <span class="id">now</span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof62')">Proof.</span></div>
<div class="proofscript" id="proof62">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">msgpool</span> <span class="id">now</span> <span class="id">uid</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id">uid</span> \<span class="id">notin</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span> <span class="id">msgpool</span> <span class="id">now</span>)).<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#reset_msg_delays">reset_msg_delays</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>.<br/>
Qed.</div>
<br/>
<h2> Definitions and lemmas for sent and forged messages </h2>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="user_sent">user_sent</a></span> <span class="id">sender</span> (<span class="id">m</span> : <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>) (<span class="id">pre</span> <span class="id">post</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id">ms</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>), <span class="id">m</span> \<span class="kwd">in</span> <span class="id">ms</span><br/>
&nbsp;&nbsp;/\ ((<span class="kwd">exists</span> <span class="id">d</span> <span class="id">incoming</span>, <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">sender</span> <span class="id">d</span> <span class="id">incoming</span> <span class="id">ms</span>) <span class="id">pre</span> <span class="id">post</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\/ (<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_step_internal">lbl_step_internal</a></span> <span class="id">sender</span> <span class="id">ms</span>) <span class="id">pre</span> <span class="id">post</span>)).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="user_forged">user_forged</a></span> (<span class="id">msg</span>:<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>) (<span class="id">g1</span> <span class="id">g2</span>: <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_forge_msg">lbl_forge_msg</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_round">msg_round</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_period">msg_period</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_type">msg_type</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_ev">msg_ev</a></span> <span class="id">msg</span>)) <span class="id">g1</span> <span class="id">g2</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="user_sent_at">user_sent_at</a></span> <span class="id">ix</span> <span class="id">path</span> <span class="id">uid</span> <span class="id">msg</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">path</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
<br/>
<div class="doc">A user who sends a message must be in both pre and post states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="user_sent_in_pre">user_sent_in_pre</a></span> {<span class="id">sender</span> <span class="id">m</span> <span class="id">pre</span> <span class="id">post</span>} (<span class="id">H</span> : <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">sender</span> <span class="id">m</span> <span class="id">pre</span> <span class="id">post</span>):<br/>
&nbsp;&nbsp;<span class="id">sender</span> \<span class="kwd">in</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof63')">Proof.</span></div>
<div class="proofscript" id="proof63">
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>: <span class="id">H</span> =&gt; [<span class="id">msgs</span> [<span class="id">H_mem</span> [[<span class="id">d</span> [<span class="id">recv</span> <span class="id">H_step</span>]] | <span class="id">H_step</span>]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_step</span> =&gt; [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> <span class="id">H_step</span>]].<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="user_sent_in_post">user_sent_in_post</a></span> {<span class="id">sender</span> <span class="id">m</span> <span class="id">pre</span> <span class="id">post</span>} (<span class="id">H</span> : <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">sender</span> <span class="id">m</span> <span class="id">pre</span> <span class="id">post</span>):<br/>
&nbsp;&nbsp;<span class="id">sender</span> \<span class="kwd">in</span> <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof64')">Proof.</span></div>
<div class="proofscript" id="proof64">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">msgs</span> [<span class="id">H_mem</span> [[<span class="id">d</span> [<span class="id">recv</span> <span class="id">H_step</span>]] | <span class="id">H_step</span>]]]; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;- <span class="kwd">by</span> <span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_sender</span> [<span class="id">H_corrupt</span> <span class="id">H_step</span>]]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> [<span class="id">key_mailbox</span> [<span class="id">H_recv</span> <span class="id">H_post</span>]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">post</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span>, <span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">clear</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id">sender</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>.[<span class="id">sender</span> &lt;- <span class="id">ustate_post</span>]));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#dom_setf">dom_setf</a></span>; <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fset1U1">fset1U1</a></span>.<br/>
&nbsp;&nbsp;- <span class="kwd">by</span> <span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_sender</span> <span class="id">H_post</span>]]]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">post</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span>, <span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">clear</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">change</span> (<span class="id">sender</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>.[<span class="id">sender</span> &lt;- <span class="id">ustate_post</span>]));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#dom_setf">dom_setf</a></span>; <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fset1U1">fset1U1</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The step of a user in the pre-state who sends message is same as <span class="bracket"><span class="id">msg_step</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_label_start">utransition_label_start</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) = (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof65')">Proof.</span></div>
<div class="proofscript" id="proof65">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">sent</span> [<span class="id">msg_in</span> <span class="id">H_trans</span>]] <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">msg</span> <span class="id">msg_in</span> =&gt; <span class="id">mtype</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid_m</span> <span class="id">msg_in</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_trans</span> =&gt; [[<span class="id">d</span> [<span class="id">body</span> <span class="id">H_recv</span>]]|<span class="id">H_step</span>].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_recv</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">g1</span>;<span class="id">simpl</span> <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>. <span class="id">injection</span> <span class="id">H_u</span>;<span class="id">clear</span> <span class="id">H_u</span>. <span class="id">intros</span> &lt;-.<br/>
<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<span class="id">injection</span> <span class="id">Hequstep_out</span>;<span class="id">clear</span> <span class="id">Hequstep_out</span>;<span class="id">intros</span> &lt;- &lt;-;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">exfalso</span>;<span class="id">exact</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#notF">notF</a></span> <span class="id">msg_in</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Only&nbsp;one&nbsp;delivery&nbsp;transition&nbsp;actually&nbsp;sends&nbsp;a&nbsp;message&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">msg_in</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>; <span class="id">case</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> =&gt; [<span class="id">eq_type</span> <span class="id">eq_ev</span> <span class="id">eq_p</span> <span class="id">eq_r</span> <span class="id">eq_s</span>]; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span>;<span class="id">unfold</span> <span class="id">pre</span>',<span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span>;<span class="id">simpl</span>;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [-&gt; [-&gt;  -&gt;]];<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">g1</span>;<span class="id">simpl</span> <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u</span>;<span class="id">injection</span> <span class="id">H_u</span>;<span class="id">clear</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H</span>. <span class="id">rewrite</span> -&gt; <span class="id">H</span> <span class="kwd">in</span> * |- *. <span class="id">clear</span> <span class="id">key_user</span> <span class="id">users</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span>: <span class="id">msg_in</span> =&gt; <span class="id">msg_in</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">msg_in</span> <span class="id">H_step</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">injection</span> <span class="id">Hequstep_out</span>;<span class="id">clear</span> <span class="id">Hequstep_out</span>;<span class="id">intros</span> &lt;- &lt;-;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">rec</span> <span class="id">use_mem</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> [<span class="id">exfalso</span>;<span class="id">exact</span> <span class="id">H</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">H</span>|<span class="id">H</span>];[<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> &lt;- &lt;- &lt;- &lt;- &lt;-|<span class="id">use_mem</span> <span class="id">H</span>]]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">use_mem</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>:<span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">move</span>: <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>:<span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">move</span> :<span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<span class="id">clear</span>;<span class="id">simpl</span>;<span class="id">move</span>=&gt; [-&gt; [-&gt; -&gt;]];<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">The step of a user in post-state who sends a message is greater than the message step. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_label_end">utransition_label_end</a></span> : <span class="kwd">forall</span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span>) (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof66')">Proof.</span></div>
<div class="proofscript" id="proof66">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">sent</span> [<span class="id">msg_in</span> <span class="id">H_trans</span>]] <span class="id">u</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">msg</span> <span class="id">msg_in</span> =&gt; <span class="id">mtype</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid_m</span> /= <span class="id">msg_in</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H_trans</span> =&gt; [[<span class="id">d</span> [<span class="id">body</span> <span class="id">H_recv</span>]]|<span class="id">H_step</span>].<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;message&nbsp;delivery&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_recv</span> <span class="kwd">as</span> (<span class="id">key_ustate</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_step</span> &amp; <span class="id">H_honest</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; <span class="id">key_mailbox</span> &amp; <span class="id">H_msg_in_mailbox</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_u</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>. <span class="id">case</span> =&gt; {<span class="id">u</span>}&lt;-.<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">g1</span>;<span class="id">cbn</span> -[<span class="id">in_mem</span> <span class="id">mem</span> <span class="id">eq_op</span>] <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<span class="id">injection</span> <span class="id">Hequstep_out</span>;<span class="id">clear</span> <span class="id">Hequstep_out</span>;<span class="id">intros</span> &lt;- &lt;-;<br/>
&nbsp;&nbsp;<span class="id">try</span> (<span class="id">exfalso</span>;<span class="id">exact</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#notF">notF</a></span> <span class="id">msg_in</span>));<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">msg_in</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#is_true">is_true</a></span> (<span class="id">_</span> \<span class="kwd">in</span> [:: <span class="id">_</span>]) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#in_mem">in_mem</a></span> <span class="kwd">in</span> <span class="id">msg_in</span>; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Bool.Bool.html#orb_false_r">Bool.orb_false_r</a></span> <span class="kwd">in</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#elimT">elimT</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>) <span class="kwd">in</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">injection</span> <span class="id">msg_in</span>;<span class="id">clear</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> -&gt; -&gt; -&gt; -&gt; -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H0</span>;<span class="id">subst</span> <span class="id">pre</span>';<span class="id">clear</span>;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="comment">(*&nbsp;internal&nbsp;transition&nbsp;cases&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="kwd">as</span> (<span class="id">key_user</span> &amp; <span class="id">ustate_post</span> &amp; <span class="id">H_honest</span> &amp; <span class="id">H_step</span> &amp; -&gt;).<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_u</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>. <span class="id">case</span> =&gt; {<span class="id">u</span>}&lt;-.<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">g1</span>;<span class="id">cbn</span> -[<span class="id">in_mem</span> <span class="id">mem</span> <span class="id">eq_op</span>] <span class="kwd">in</span> * |- *.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span>: <span class="id">msg_in</span> =&gt; <span class="id">msg_in</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">msg_in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">ustate_post</span>,<span class="id">sent</span>) <span class="kwd">as</span> <span class="id">ustep_out</span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<br/>
&nbsp;&nbsp;<span class="id">injection</span> <span class="id">Hequstep_out</span>;<span class="id">clear</span> <span class="id">Hequstep_out</span>;<span class="id">intros</span> &lt;- &lt;-;<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">rec</span> <span class="id">use_mem</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> [<span class="id">exfalso</span>;<span class="id">exact</span> <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">H</span>|<span class="id">H</span>];[<span class="id">injection</span> <span class="id">H</span> <span class="kwd">as</span> &lt;- &lt;- &lt;- &lt;- &lt;-|<span class="id">use_mem</span> <span class="id">H</span>]]<br/>
&nbsp;&nbsp;<span class="kwd">in</span> <span class="id">use_mem</span> <span class="id">msg_in</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>:<span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">move</span>: <span class="id">H</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id">H</span>:<span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span>] =&gt; <span class="id">move</span>: <span class="id">H</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<span class="id">clear</span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">clear</span>;<span class="id">move</span>=&gt; [-&gt; [-&gt; <span class="id">H_step_val</span>]];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">repeat</span> (<span class="id">split</span> || <span class="id">right</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnSn">ltnSn</a></span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<h2> Definitions for receiving messages </h2>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="step_at">step_at</a></span> <span class="id">path</span> <span class="id">ix</span> <span class="id">lbl</span> :=<br/>
&nbsp;<span class="kwd">exists</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">path</span> /\ <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> <span class="id">lbl</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="msg_received">msg_received</a></span> <span class="id">uid</span> <span class="id">msg_deadline</span> <span class="id">msg</span> <span class="id">path</span> : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span> <span class="id">ms</span>, <span class="id"><a href="Algorand.safety_helpers.html#step_at">step_at</a></span> <span class="id">path</span> <span class="id">n</span><br/>
&nbsp;&nbsp;&nbsp;(<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">uid</span> <span class="id">msg_deadline</span> <span class="id">msg</span> <span class="id">ms</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="received_next_vote">received_next_vote</a></span> <span class="id">u</span> <span class="id">voter</span> <span class="id">round</span> <span class="id">period</span> <span class="id">step</span> <span class="id">value</span> <span class="id">path</span> : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">d</span>, <span class="id"><a href="Algorand.safety_helpers.html#msg_received">msg_received</a></span> <span class="id">u</span> <span class="id">d</span> (<span class="kwd">match</span> <span class="id">value</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Val">Nextvote_Val</a></span> (<span class="id"><a href="Algorand.algorand_model.html#next_val">next_val</a></span> <span class="id">v</span> <span class="id">step</span>) <span class="id">round</span> <span class="id">period</span> <span class="id">voter</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Nextvote_Open">Nextvote_Open</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_val">step_val</a></span> <span class="id">step</span>) <span class="id">round</span> <span class="id">period</span> <span class="id">voter</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>) <span class="id">path</span>.<br/>
<br/>
<h2> Labeling transitions </h2>
<br/>
<div class="doc">All global transitions have some label. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="transitions_labeled">transitions_labeled</a></span>: <span class="kwd">forall</span> <span class="id">g1</span> <span class="id">g2</span>,<br/>
&nbsp;&nbsp;<span class="id">g1</span> ~~&gt; <span class="id">g2</span> &lt;-&gt; <span class="kwd">exists</span> <span class="id">lbl</span>, <span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> <span class="id">lbl</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof67')">Proof.</span></div>
<div class="proofscript" id="proof67">
&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;forward&nbsp;-&nbsp;find&nbsp;label&nbsp;for&nbsp;transition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_tick">lbl_tick</a></span> <span class="id">increment</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pending</span> <span class="kwd">as</span> [<span class="id">deadline</span> <span class="id">msg</span>];<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">uid</span> <span class="id">deadline</span> <span class="id">msg</span> <span class="id">sent</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_step_internal">lbl_step_internal</a></span> <span class="id">uid</span> <span class="id">sent</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_exit_partition">lbl_exit_partition</a></span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_enter_partition">lbl_enter_partition</a></span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_corrupt_user">lbl_corrupt_user</a></span> <span class="id">uid</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_replay_msg">lbl_replay_msg</a></span> <span class="id">uid</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="Algorand.algorand_model.html#lbl_forge_msg">lbl_forge_msg</a></span> <span class="id">sender</span> <span class="id">r</span> <span class="id">p</span> <span class="id">mtype</span> <span class="id">mval</span>);<span class="id">finish_case</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;reverse&nbsp;-&nbsp;find&nbsp;transition&nbsp;from&nbsp;label&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> 1 <span class="kwd">as</span> [[] <span class="id">Hrel</span>];<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">Hrel</span>; <span class="id">case</span>: <span class="id">Hrel</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">Htick</span> -&gt;; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_tick">step_tick</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">x</span> [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> <span class="id">Hg2</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hg2</span> =&gt; [<span class="id">key_mailbox</span> [<span class="id">Hg1</span> <span class="id">Hg2</span>]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_deliver_msg">step_deliver_msg</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">x</span> [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> <span class="id">Hg2</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_internal">step_internal</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">H_part</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_exit_partition">step_exit_partition</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">H_part</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_enter_partition">step_enter_partition</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">H_in</span> [<span class="id">H_corrupt</span> <span class="id">H_g2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_corrupt_user">step_corrupt_user</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">H_in</span> [<span class="id">msg</span> [<span class="id">H_corrupt</span> [<span class="id">H_msg</span> <span class="id">H_g2</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_replay_msg">step_replay_msg</a></span>; <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">move</span> =&gt; <span class="id">H_in</span> [<span class="id">s0</span> [<span class="id">H_keys</span> [<span class="id">H_comm</span> [<span class="id">H_match</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">subst</span> <span class="id">g2</span>; <span class="id">eapply</span> <span class="id"><a href="Algorand.algorand_model.html#step_forge_msg">step_forge_msg</a></span>; <span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Internal transitions change the state - used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="internal_not_noop">internal_not_noop</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">l</span>, <span class="id">s</span> # <span class="id">pre</span> ~&gt; (<span class="id">post</span>, <span class="id">l</span>) -&gt; <span class="id">pre</span> &lt;&gt; <span class="id">post</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof68')">Proof.</span></div>
<div class="proofscript" id="proof68">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">s</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">l</span> <span class="id">Hst</span>;<span class="id">inversion</span> <span class="id">Hst</span>;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">all</span>: <span class="id">try</span> (<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> <span class="id">H2</span>; <span class="id">decompose</span> <span class="id">record</span> <span class="id">H2</span>; <span class="id">clear</span> <span class="id">H2</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [<span class="id">H</span> : <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> |- <span class="id">_</span>] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">_</span> [<span class="id">_</span> <span class="id">H_s</span>]];<span class="id">contradict</span> <span class="id">H_s</span>;<span class="id">rewrite</span> <span class="id">H_s</span>;<span class="id">simpl</span>;<span class="id">clear</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>;<span class="id">try</span> <span class="id">discriminate</span>; <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#esym">esym</a></span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Peano.html#n_Sn">n_Sn</a></span>).<br/>
&nbsp;&nbsp;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="id">decompose</span> <span class="id">record</span> <span class="id">H3</span>; <span class="id">clear</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> [<span class="id">_</span> [<span class="id">_</span> <span class="id">H_s</span>]];<span class="id">contradict</span> <span class="id">H_s</span>;<span class="id">rewrite</span> <span class="id">H_s</span>;<span class="id">simpl</span>;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#esym">esym</a></span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Peano.html#n_Sn">n_Sn</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">delivery_result</span></span> decreases mailbox size - used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="deliver_analysis1">deliver_analysis1</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g</span> <span class="id">uid</span> <span class="id">upost</span> <span class="id">r</span> <span class="id">m</span> <span class="id">l</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">key_mbox</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r</span>, <span class="id">m</span>) \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_mbox</span>] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">g2</span> := <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id">g</span> <span class="id">uid</span> <span class="id">key_mbox</span> (<span class="id">r</span>, <span class="id">m</span>) <span class="id">upost</span> <span class="id">l</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">uid2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid2</span>]))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid2</span>]))) &lt;-&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> = <span class="id">uid2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;/\ [<span class="id">mset</span> (<span class="id">r</span>,<span class="id">m</span>)] =( <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid</span>])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`\` <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid</span>]))%<span class="id">mset</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof69')">Proof.</span></div>
<div class="proofscript" id="proof69">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>=&gt; <span class="id">g</span> <span class="id">uid</span> <span class="id">upost</span> <span class="id">r</span> <span class="id">m</span> <span class="id">l</span> <span class="id">key_mbox</span> <span class="id">H_pending</span> <span class="id">g2</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">mb1</span>: {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>*<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>} := <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid</span>]).<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">mb2</span>: {<span class="id">mset</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Reals.Rdefinitions.html#RbaseSymbolsImpl.R">R</a></span>*<span class="id"><a href="Algorand.algorand_model.html#Msg">Msg</a></span>} := <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[?<span class="id">uid</span>]).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_singleton</span>: <span class="id">mb1</span> = (<span class="id">r</span>,<span class="id">m</span>) +` <span class="id">mb2</span>).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">mb1</span> <span class="id">mb2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id">g2</span> /<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">updf_update</span>'.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fset1U">in_fset1U</a></span>; <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">left</span>.<br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_uid</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">repeat</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[|- <span class="id">context</span> <span class="id">C</span>[<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> ?<span class="id">x</span>)]] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H</span> :<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrfun.html#odflt">odflt</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0">mset0</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">x</span>) = <span class="id">x</span>) <span class="kwd">by</span> <span class="id">done</span>; <span class="id">rewrite</span> <span class="id">H</span>; <span class="id">clear</span> <span class="id">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetBDKC">msetBDKC</a></span>;[|<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msub1set">msub1set</a></span>].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsetD11">fsetD11</a></span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">split</span>;[|<span class="kwd">by</span> <span class="id">move</span>:<span class="id">H_singleton</span> =&gt; /(<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#f_equal">f_equal</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetB">msetB</a></span>^~<span class="id">mb2</span>)) -&gt;;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetDC">msetDC</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetDKB">msetDKB</a></span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid2</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> &lt;-.<br/>
&nbsp;&nbsp;<span class="id">fold</span> <span class="id">mb1</span> <span class="id">mb2</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_singleton</span> <span class="id"><a href="Algorand.safety_helpers.html#mset_add_size">mset_add_size</a></span> <span class="id"><a href="Algorand.safety_helpers.html#msetn_size">msetn_size</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">intro</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">H_neq</span>:(<span class="id">uid2</span> == <span class="id">uid</span>);[<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">H_neq</span>|<span class="id">exfalso</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> *.<br/>
<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">mb1</span> <span class="id">mb2</span> <span class="id">H_singleton</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> ((<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)).[<span class="id">uid</span> &lt;- ((<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)).[<span class="id">key_mbox</span>] `\ (<span class="id">r</span>, <span class="id">m</span>))%<span class="id">mset</span>]) <span class="kwd">as</span> <span class="id">mailboxes</span>'.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">mailboxes</span>'.[?<span class="id">uid2</span>]/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> =&gt; <span class="id">H_mb</span>.<br/>
&nbsp;&nbsp;2: {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_mb</span>' := <span class="id">H_mb</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> <span class="kwd">in</span> <span class="id">H_mb</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">mailboxes</span>'. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="kwd">in</span> <span class="id">H_mb</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H_mb</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_mb</span>' <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#size_mset0">size_mset0</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inversion</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_uid2</span> : <span class="id">uid2</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">mailboxes</span>'.[? <span class="id">uid2</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">mailboxes</span>'.[<span class="id">H_mb</span>]). <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">mailboxes</span>'.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">done</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcastsE">send_broadcastsE</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">uid2</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#honest_users">honest_users</a></span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)))) <span class="id">eqn</span>:<span class="id">H_honest</span>; <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">updf_update</span>' <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnn">ltnn</a></span> <span class="kwd">in</span> <span class="id">H_size</span>; <span class="id">discriminate</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetD1">in_fsetD1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>. <span class="id">move</span> =&gt; [<span class="id">_</span> <span class="id">H_honest</span>'].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_honest</span> <span class="kwd">in</span> <span class="id">H_honest</span>'.<br/>
&nbsp;&nbsp;}<br/>
<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#setfNK">setfNK</a></span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_neq</span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_size</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_size</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negPn">negPn</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#msubset_size">msubset_size</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)[`<span class="id">H_uid2</span>]) =&gt; <span class="id">mb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -{1}[<span class="id">mb</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset0D">mset0D</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetSD">msetSD</a></span>, <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msub0set">msub0set</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetD1">in_fsetD1</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>. <span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_neq</span>; <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">H_neq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>; <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="kwd">in</span> <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">Message transitions with same resulting state has the same output messages - 
   used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_msg_result_analysis">utransition_msg_result_analysis</a></span> <span class="id">uid</span> <span class="id">upre</span> <span class="id">m</span> <span class="id">upost</span> <span class="id">l</span> <span class="id">l</span>'<br/>
&nbsp;&nbsp;(<span class="id">H_step</span>: <span class="id">uid</span> # <span class="id">upre</span>; <span class="id">m</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>))<br/>
&nbsp;&nbsp;(<span class="id">H_step</span>': <span class="id">uid</span> # <span class="id">upre</span>; <span class="id">m</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>')) :<br/>
&nbsp;&nbsp;<span class="id">l</span> = <span class="id">l</span>'.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof70')">Proof.</span></div>
<div class="proofscript" id="proof70">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span> <span class="id">H_step</span>'.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">upost</span>,<span class="id">l</span>) <span class="kwd">as</span> <span class="id">ustate_out</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span> <span class="id">eqn</span>:<span class="id">H_trans</span>; <span class="id">case</span>: <span class="id">Hequstate_out</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> &lt;- &lt;-; <span class="id">inversion</span> <span class="id">H_step</span>'; <span class="id">subst</span>; <span class="id">try</span> (<span class="kwd">by</span> []); <span class="id">exfalso</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre</span>'; <span class="id">subst</span> <span class="id">pre</span>'0; <span class="id">clear</span> -<span class="id">H2</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span>, <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span>, <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="kwd">in</span> <span class="id">H2</span>; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> &lt;- <span class="id">H6</span> <span class="kwd">in</span> <span class="id">H2</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre</span>'; <span class="id">subst</span> <span class="id">pre</span>'0; <span class="id">clear</span> -<span class="id">c</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span>, <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span>, <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="kwd">in</span> <span class="id">c</span>; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">c</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H6</span> <span class="kwd">in</span> <span class="id">c</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#vote_msg">vote_msg</a></span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">pre</span>'; <span class="id">subst</span> <span class="id">pre</span>'0.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>, <span class="id"><a href="Algorand.algorand_model.html#certvote_result">certvote_result</a></span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pre</span>; <span class="id">simpl</span> <span class="kwd">in</span> *.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H</span>; <span class="id">intros</span> &lt;-; <span class="id">intro</span>; <span class="id">clear</span> -<span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certvote_ok">certvote_ok</a></span>, <span class="id"><a href="Algorand.algorand_model.html#set_softvotes">set_softvotes</a></span>, <span class="id"><a href="Algorand.algorand_model.html#valid_rps">valid_rps</a></span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">intuition</span> <span class="id">auto</span>.<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">delivery_result</span></span> on a global state is the same means the message delivery
   transitions are equal - used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="deliver_deliver_lbl_unique">deliver_deliver_lbl_unique</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g</span> <span class="id">uid</span> <span class="id">uid</span>' <span class="id">upost</span> <span class="id">upost</span>' <span class="id">r</span> <span class="id">r</span>' <span class="id">m</span> <span class="id">m</span>' <span class="id">l</span> <span class="id">l</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">key_state</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) (<span class="id">key_mbox</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">key_state</span>' : <span class="id">uid</span>' \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) (<span class="id">key_mbox</span>' : <span class="id">uid</span>' \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>].(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r</span>, <span class="id">m</span>) \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_mbox</span>] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>] ; <span class="id">m</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>'].(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r</span>', <span class="id">m</span>') \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_mbox</span>'] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span>' # <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>'] ; <span class="id">m</span>' ~&gt; (<span class="id">upost</span>', <span class="id">l</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id">g</span> <span class="id">uid</span> <span class="id">key_mbox</span> (<span class="id">r</span>, <span class="id">m</span>) <span class="id">upost</span> <span class="id">l</span> = <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id">g</span> <span class="id">uid</span>' <span class="id">key_mbox</span>' (<span class="id">r</span>', <span class="id">m</span>') <span class="id">upost</span>' <span class="id">l</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> = <span class="id">uid</span>' /\ <span class="id">r</span> = <span class="id">r</span>' /\ <span class="id">m</span> = <span class="id">m</span>' /\ <span class="id">l</span> = <span class="id">l</span>'.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof71')">Proof.</span></div>
<div class="proofscript" id="proof71">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g</span> <span class="id">uid</span> <span class="id">uid</span>' <span class="id">upost</span> <span class="id">upost</span>' <span class="id">r</span> <span class="id">r</span>' <span class="id">m</span> <span class="id">m</span>' <span class="id">l</span> <span class="id">l</span>' <span class="id">key_state</span> <span class="id">key_mbox</span> <span class="id">key_state</span>' <span class="id">key_mbox</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H_honest</span> <span class="id">H_pending</span> <span class="id">H_step</span> <span class="id">H_honest</span>' <span class="id">H_pending</span>' <span class="id">H_step</span>' <span class="id">H_results</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">Fact1</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#deliver_analysis1">deliver_analysis1</a></span> <span class="id">upost</span> <span class="id">l</span> <span class="id">H_pending</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">Fact1</span>' :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#deliver_analysis1">deliver_analysis1</a></span> <span class="id">upost</span>' <span class="id">l</span>' <span class="id">H_pending</span>'.<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">Fact1</span> <span class="id">Fact1</span>'}[<span class="id">H_uids</span> <span class="id">H_pendings</span>] : <span class="id">uid</span> = <span class="id">uid</span>' /\ [<span class="id">mset</span> (<span class="id">r</span>,<span class="id">m</span>)] = [<span class="id">mset</span> (<span class="id">r</span>',<span class="id">m</span>')].<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_results</span> <span class="id">Fact1</span> <span class="id">Fact1</span>' =&gt; &lt;-.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">g2</span> := <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id">g</span> <span class="id">uid</span> <span class="id">key_mbox</span> (<span class="id">r</span>, <span class="id">m</span>) <span class="id">upost</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;<span class="id">cbv</span> <span class="id">zeta</span>. <span class="id">clearbody</span> <span class="id">g2</span>. <span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">H_uid</span> <span class="id">H_pending</span>] [<span class="id">H_uid</span>' <span class="id">H_pending</span>'].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H</span>: <span class="id">uid</span> = <span class="id">uid</span> <span class="kwd">by</span> <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;-<span class="id">H_uid</span>, <span class="id">H_uid</span>' <span class="kwd">in</span> <span class="id">H</span>;<span class="id">subst</span> <span class="id">uid</span>'.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">split</span>;[|<span class="id">rewrite</span> <span class="id">H_pending</span> -<span class="id">H_pending</span>'].<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">uid</span>'.<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_pendings</span>}[<span class="id">H_r</span> <span class="id">H_m</span>]: (<span class="id">r</span>,<span class="id">m</span>) = (<span class="id">r</span>',<span class="id">m</span>') <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset1P">mset1P</a></span>;<span class="id">rewrite</span> -<span class="id">H_pendings</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset11">mset11</a></span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">r</span>' <span class="id">m</span>'.<br/>
&nbsp;&nbsp;<span class="id">repeat</span> (<span class="id">split</span>;[<span class="id">reflexivity</span>|]).<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H</span>: <span class="id">upost</span> = <span class="id">upost</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#f_equal">f_equal</a></span> (<span class="kwd">fun</span> <span class="id">g</span> =&gt; <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>]) <span class="id">H_results</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> !<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>;<span class="id">clear</span>;<span class="id">congruence</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">upost</span>'.<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#bool_irrelevance">bool_irrelevance</a></span> <span class="id">key_state</span>' <span class="id">key_state</span>) <span class="kwd">in</span> <span class="id">H_step</span>'.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key_state</span>]) <span class="id">H_step</span> <span class="id">H_step</span>' =&gt; <span class="id">upre</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#utransition_msg_result_analysis">utransition_msg_result_analysis</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Message delivery transitions cannot be the same as internal transitions -
used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="deliver_internal_False">deliver_internal_False</a></span> :<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g</span> <span class="id">uid</span> <span class="id">uid</span>' <span class="id">upost</span> <span class="id">upost</span>' <span class="id">r</span> <span class="id">m</span> <span class="id">l</span> <span class="id">l</span>'<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">key_state</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) (<span class="id">key_mbox</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">key_state</span>' : <span class="id">uid</span>' \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>].(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">r</span>, <span class="id">m</span>) \<span class="kwd">in</span> <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span>).[<span class="id">key_mbox</span>] -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>] ; <span class="id">m</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>'].(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span>' # <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[<span class="id">key_state</span>'] ~&gt; (<span class="id">upost</span>', <span class="id">l</span>') -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> <span class="id">g</span> <span class="id">uid</span> <span class="id">key_mbox</span> (<span class="id">r</span>, <span class="id">m</span>) <span class="id">upost</span> <span class="id">l</span> = <span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> <span class="id">g</span> <span class="id">uid</span>' <span class="id">upost</span>' <span class="id">l</span>' -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof72')">Proof.</span></div>
<div class="proofscript" id="proof72">
<span class="id">clear</span>.<br/>
<span class="id">move</span> =&gt; <span class="id">g</span> <span class="id">uid</span> <span class="id">uid</span>' <span class="id">upost</span> <span class="id">upost</span>' <span class="id">r</span> <span class="id">m</span> <span class="id">l</span> <span class="id">l</span>' <span class="id">key_state</span> <span class="id">key_mbox</span> <span class="id">key_state</span>'.<br/>
<span class="id">move</span> =&gt; <span class="id">H_honest</span> <span class="id">H_msg</span> <span class="id">H_step</span> <span class="id">H_honest</span>' <span class="id">H_step</span>'.<br/>
<span class="id">rewrite</span>/<span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span> /= /<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /= /<span class="id">RecordSet.set</span> /=.<br/>
<span class="id">set</span> <span class="id">us1</span> := <span class="id">_</span>.[<span class="id">uid</span> &lt;- <span class="id">_</span>].<br/>
<span class="id">set</span> <span class="id">us2</span> := <span class="id">_</span>.[<span class="id">uid</span>' &lt;- <span class="id">_</span>].<br/>
<span class="id">set</span> <span class="id">sb1</span> := <span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">set</span> <span class="id">sb2</span> := <span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">move</span> =&gt; <span class="id">Heq</span>.<br/>
<span class="id">have</span> <span class="id">Hus</span>: <span class="id">us2</span> = <span class="id">us1</span> <span class="kwd">by</span> <span class="id">move</span>: <span class="id">Heq</span>; <span class="id">move</span>: (<span class="id">us1</span>) (<span class="id">us2</span>) =&gt; <span class="id">us3</span> <span class="id">us4</span>; <span class="id">case</span>.<br/>
<span class="id">have</span> <span class="id">Hsb</span>: <span class="id">sb1</span> = <span class="id">sb2</span> <span class="kwd">by</span> <span class="id">case</span>: <span class="id">Heq</span>.<br/>
<span class="id">clear</span> <span class="id">Heq</span>.<br/>
<span class="id">case</span> <span class="id">Hueq</span>: (<span class="id">uid</span>' == <span class="id">uid</span>); <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hueq</span> =&gt; <span class="id">Hueq</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hus1c</span>: <span class="id">us2</span>.[? <span class="id">uid</span>'] = <span class="id">us1</span>.[? <span class="id">uid</span>'] <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hus1c</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> 2!<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>; <span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>.<br/>
&nbsp;&nbsp;- <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">move</span> =&gt; <span class="id">_</span> <span class="id">_</span> <span class="id">Hpost</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span> <span class="id">Hsuff</span>: (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g</span>) [` <span class="id">key_state</span>'] = <span class="id">upost</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_step</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#internal_not_noop">internal_not_noop</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#sym_eq">sym_eq</a></span> <span class="kwd">in</span> <span class="id">Hpost</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hpost</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>.<br/>
&nbsp;&nbsp;- <span class="kwd">by</span> <span class="id">move</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;- <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">_</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hueq</span> =&gt; <span class="id">Hueq</span>.<br/>
<span class="id">move</span>: <span class="id">Hsb</span>.<br/>
<span class="id">rewrite</span> /<span class="id">sb1</span> /<span class="id">sb2</span> <span class="id">Hueq</span>.<br/>
<span class="id">move</span>: <span class="id">H_msg</span>.<br/>
<span class="id">clear</span>.<br/>
<span class="id">set</span> <span class="id">fs</span> := [<span class="id">fset</span> <span class="id">_</span> | <span class="id">_</span> <span class="kwd">in</span> <span class="id">_</span>].<br/>
<span class="id">set</span> <span class="id">sb1</span> := <span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">set</span> <span class="id">sb2</span> := <span class="id"><a href="Algorand.algorand_model.html#send_broadcasts">send_broadcasts</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">move</span> =&gt; <span class="id">H_msg</span> <span class="id">Hsb</span>.<br/>
<span class="id">have</span> <span class="id">Hsb12</span>: <span class="id">sb1</span>.[? <span class="id">uid</span>] = <span class="id">sb2</span>.[? <span class="id">uid</span>] <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hsb</span>.<br/>
<span class="id">move</span>: <span class="id">Hsb12</span>.<br/>
<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcast_notin_targets">send_broadcast_notin_targets</a></span>; <span class="id">first</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#send_broadcast_notin_targets">send_broadcast_notin_targets</a></span> //.<br/>
- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>; <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>; <span class="id">case</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">ms</span> := (<span class="id"><a href="Algorand.algorand_model.html#msg_in_transit">msg_in_transit</a></span> <span class="id">_</span> <span class="id">_</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetP">msetP</a></span> =&gt; <span class="id">Hms</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">Hms</span> (<span class="id">r</span>, <span class="id">m</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#msetB1E">msetB1E</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hrm</span>: ((<span class="id">r</span>, <span class="id">m</span>) == (<span class="id">r</span>, <span class="id">m</span>)); <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hrm</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /=.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_msg</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#mset_neq0">mset_neq0</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: (<span class="id">ms</span> (<span class="id">r</span>, <span class="id">m</span>)) =&gt; //.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">n</span> <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">lia</span>.<br/>
- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetE">in_fsetE</a></span> /=.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetE">in_fsetE</a></span>.<br/>
- <span class="id">rewrite</span> 2!<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetE">in_fsetE</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">left</span>.<br/>
- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetE">in_fsetE</a></span> /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fsetE">in_fsetE</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hf</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Internal transitions with equal post-states with the same messages sent must
have sent the messages in the same order - used in <span class="bracket"><span class="id">transition_label_unique</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_result_perm_eq">utransition_result_perm_eq</a></span> <span class="id">uid</span> <span class="id">upre</span> <span class="id">upost</span> <span class="id">l</span> <span class="id">l</span>' :<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">upre</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">upre</span> ~&gt; (<span class="id">upost</span>, <span class="id">l</span>') -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_eq">perm_eq</a></span> <span class="id">l</span> <span class="id">l</span>' -&gt;<br/>
&nbsp;&nbsp;<span class="id">l</span> = <span class="id">l</span>'.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof73')">Proof.</span></div>
<div class="proofscript" id="proof73">
<span class="id">move</span> =&gt; <span class="id">Htr</span> <span class="id">Htr</span>' <span class="id">Hpq</span>.<br/>
<span class="id">case</span> <span class="id">Hs</span>: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span>') =&gt; [|<span class="id">n</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hs</span> <span class="id">Hpq</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size0nil">size0nil</a></span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_nilP">perm_nilP</a></span>.<br/>
<span class="id">case</span> <span class="id">Hn</span>: <span class="id">n</span> =&gt; [|<span class="id">n</span>'].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hs</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Hn</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">l</span>' =&gt; //=.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hl</span>': (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span>') =&gt; //.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hpq</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size0nil">size0nil</a></span>: <span class="id">Hl</span>' =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#perm_eq_cons1P">perm_eq_cons1P</a></span>.<br/>
<span class="id">move</span>: <span class="id">Hs</span>.<br/>
<span class="id">rewrite</span> <span class="id">Hn</span> =&gt; <span class="id">Hl</span>'.<br/>
<span class="id">have</span> <span class="id">Heq</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span> = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span>' <span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_size">perm_size</a></span>.<br/>
<span class="id">move</span>: <span class="id">Heq</span>.<br/>
<span class="id">rewrite</span> <span class="id">Hl</span>' =&gt; <span class="id">Hl</span>.<br/>
<span class="id">have</span> <span class="id">Hll</span>': <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span>' &gt;= 2 <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hl</span>'.<br/>
<span class="id">have</span> <span class="id">Hll</span>: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">l</span> &gt;= 2 <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hl</span>.<br/>
<span class="id">clear</span> <span class="id">n</span> <span class="id">n</span>' <span class="id">Hn</span> <span class="id">Hl</span>' <span class="id">Hl</span>.<br/>
<span class="id">inversion</span> <span class="id">Htr</span>; <span class="id">inversion</span> <span class="id">Htr</span>'; <span class="id">subst</span>; <span class="id">simpl</span> <span class="kwd">in</span> *; <span class="id">try</span> <span class="kwd">by</span> [].<br/>
<span class="id">move</span>: <span class="id">Hpq</span>.<br/>
<span class="id">set</span> <span class="id">m1</span> := <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Proposal">Proposal</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">set</span> <span class="id">m2</span> := <span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id"><a href="Algorand.algorand_model.html#Block">Block</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span>.<br/>
<span class="id">set</span> <span class="id">s1</span> :=  [:: <span class="id">_</span>; <span class="id">_</span>].<br/>
<span class="id">set</span> <span class="id">s2</span> :=  [:: <span class="id">_</span>; <span class="id">_</span>].<br/>
<span class="id">move</span> =&gt; <span class="id">Hpm</span>.<br/>
<span class="id">have</span> <span class="id">Hm1</span>: <span class="id">m1</span> \<span class="kwd">in</span> <span class="id">s2</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_mem">perm_mem</a></span> <span class="id">Hpm</span>) /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">left</span>.<br/>
<span class="id">have</span> <span class="id">Hm2</span>: <span class="id">m2</span> \<span class="kwd">in</span> <span class="id">s2</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#perm_mem">perm_mem</a></span> <span class="id">Hpm</span>) /= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">right</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
<span class="id">move</span>: <span class="id">Hm1</span> <span class="id">Hm2</span>.<br/>
<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">case</span>; <span class="id">last</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
<span class="id">rewrite</span> /<span class="id">s2</span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> =&gt;&lt;-.<br/>
<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span>; <span class="id">case</span>; <span class="id">first</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#inE">inE</a></span>.<br/>
<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> =&gt;&lt;-.<br/>
Qed.</div>
<br/>
<div class="doc">Rule out the possibility that a step that counts as one user sending a
message cannot also count as a send from a different user or different message. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="transition_label_unique">transition_label_unique</a></span> : <span class="kwd">forall</span> <span class="id">lbl</span> <span class="id">lbl2</span> <span class="id">g1</span> <span class="id">g2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> <span class="id">lbl</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span> <span class="id">lbl2</span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lbl</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lbl2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">lbl2</span> = <span class="id">lbl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_step_internal">lbl_step_internal</a></span> <span class="id">_</span> <span class="id">_</span>=&gt; <span class="id">lbl2</span> = <span class="id">lbl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_step_internal">lbl_step_internal</a></span> <span class="id">_</span> <span class="id">_</span>=&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">lbl2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_deliver">lbl_deliver</a></span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> =&gt; <span class="id">lbl2</span> = <span class="id">lbl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="Algorand.algorand_model.html#lbl_step_internal">lbl_step_internal</a></span> <span class="id">_</span> <span class="id">_</span>=&gt; <span class="id">lbl2</span> = <span class="id">lbl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof74')">Proof.</span></div>
<div class="proofscript" id="proof74">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">lbl</span> <span class="id">lbl2</span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">lbl</span> <span class="id">eqn</span>:<span class="id">H_lbl</span>;<span class="id">try</span> <span class="id">done</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;one&nbsp;user&nbsp;changed,&nbsp;with&nbsp;a&nbsp;message&nbsp;removed&nbsp;from&nbsp;their&nbsp;mailbox&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_step</span> <span class="id">H</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H</span> =&gt; [<span class="id">Hcorrupt</span> [<span class="id">key_mailbox</span> [<span class="id">Hmsg</span> <span class="id">Hg2</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Hg2</span> {<span class="id">Hg2</span>} /<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">lbl2</span>;<span class="id">try</span> <span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver/deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_ustate</span>' [<span class="id">ustate_post</span>' [<span class="id">H_step</span>' [<span class="id">Hcorrupt</span>' [<span class="id">key_mailbox</span>' [<span class="id">Hmsg</span>' <span class="id">Heq</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#deliver_deliver_lbl_unique">deliver_deliver_lbl_unique</a></span> <span class="kwd">in</span> <span class="id">Heq</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Heq</span> =&gt; [<span class="id">Hs</span> [<span class="id">Hr</span> [<span class="id">Hm</span> <span class="id">Hl</span>]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hs</span> <span class="id">Hr</span> <span class="id">Hm</span> <span class="id">Hl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver/internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_user</span> [<span class="id">ustate_post</span>' [<span class="id">Hcorrupt</span>' [<span class="id">H_step</span>' <span class="id">Heq</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#deliver_internal_False">deliver_internal_False</a></span> <span class="kwd">in</span> <span class="id">Heq</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;step&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /=. <span class="comment">(*&nbsp;one&nbsp;user&nbsp;changed,&nbsp;no&nbsp;message&nbsp;removed&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_ustate</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">Hstep</span> <span class="id">Hres</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Hres</span> {<span class="id">Hres</span>} /<span class="id"><a href="Algorand.algorand_model.html#related_by">related_by</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">lbl2</span>;<span class="id">try</span> <span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal/deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_ustate</span>' [<span class="id">upost</span>' [<span class="id">H_step</span>' [<span class="id">H_corrupt</span>' [<span class="id">key_mbox</span> [<span class="id">Hmsg</span> <span class="id">Heq</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#sym_eq">sym_eq</a></span> <span class="kwd">in</span> <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#deliver_internal_False">deliver_internal_False</a></span> <span class="kwd">in</span> <span class="id">Heq</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal/internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">key_user</span> [<span class="id">ustate_post0</span> [<span class="id">Hcorrupt0</span> [<span class="id">Htr0</span> <span class="id">Heq</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hs</span>: (<span class="id">s</span> == <span class="id">s0</span>); <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hs</span> =&gt; <span class="id">Hs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /= /<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">us1</span> := <span class="id">_</span>.[<span class="id">_</span> &lt;- <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">us2</span> := <span class="id">_</span>.[<span class="id">_</span> &lt;- <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hus</span>: <span class="id">us1</span> = <span class="id">us2</span> <span class="kwd">by</span> <span class="id">move</span>: <span class="id">Heq</span>; <span class="id">move</span>: (<span class="id">us1</span>) (<span class="id">us2</span>) =&gt; <span class="id">us3</span> <span class="id">us4</span>; <span class="id">case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hus1c</span>: <span class="id">us1</span>.[? <span class="id">s0</span>] = <span class="id">us2</span>.[? <span class="id">s0</span>] <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hus1c</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> 2!<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span> =&gt; [|<span class="id">_</span>]; <span class="id">first</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> =&gt; <span class="id">Hs</span>'; <span class="id">case</span>: <span class="id">Hs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span> =&gt; [<span class="id">_</span>|]; <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>; <span class="id">case</span> =&gt; <span class="id">Hg</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#internal_not_noop">internal_not_noop</a></span> <span class="kwd">in</span> <span class="id">Htr0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hs</span> =&gt; <span class="id">Hs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">Hs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /= /<span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">us1</span> := <span class="id">_</span>.[<span class="id">_</span> &lt;- <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">us2</span> := <span class="id">_</span>.[<span class="id">_</span> &lt;- <span class="id">_</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">mh1</span> := (<span class="id">_</span> `+` <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#seq_mset">seq_mset</a></span> <span class="id">_</span>)%<span class="id">mset</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">set</span> <span class="id">mh2</span> := (<span class="id">_</span> `+` <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.multiset.html#seq_mset">seq_mset</a></span> <span class="id">_</span>)%<span class="id">mset</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hus</span>: <span class="id">us1</span> = <span class="id">us2</span> <span class="kwd">by</span> <span class="id">move</span>: <span class="id">Heq</span>; <span class="id">move</span>: (<span class="id">us1</span>) (<span class="id">us2</span>) =&gt; <span class="id">us3</span> <span class="id">us4</span>; <span class="id">case</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hus1c</span>: <span class="id">us1</span>.[? <span class="id">s0</span>] = <span class="id">us2</span>.[? <span class="id">s0</span>] <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hus1c</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> 2!<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> -<span class="id">Hs</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>; <span class="id">last</span> <span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">_</span>; <span class="id">case</span> =&gt; <span class="id">Hustate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">Hmh</span>: <span class="id">mh1</span> = <span class="id">mh2</span> <span class="kwd">by</span> <span class="id">case</span>: <span class="id">Heq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">clear</span> <span class="id">Heq</span> <span class="id">Hcorrupt0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">key_user</span> <span class="id">Htr0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id">Hs</span> -<span class="id">Hustate</span> =&gt; <span class="id">key_user</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">key_ustate</span>) =&gt; <span class="id">Hstep</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hmh</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id">mh1</span> /<span class="id">mh2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#msetD_seq_mset_perm_eq">msetD_seq_mset_perm_eq</a></span> =&gt; <span class="id">Hprm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">suff</span> <span class="id">Hsuff</span>: <span class="id">l</span> = <span class="id">l0</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hsuff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Hstep</span> <span class="id">Hstep</span>' <span class="id">Hprm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#utransition_result_perm_eq">utransition_result_perm_eq</a></span>.<br/>
Qed.</div>
<br/>
<h2> User transition lemmas, destructing post state </h2>
<br/>
<div class="doc">Message transition on <span class="bracket"><span class="id">uid</span></span> results in message sent by <span class="bracket"><span class="id">uid</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_msg_sender_good">utransition_msg_sender_good</a></span> <span class="id">uid</span> <span class="id">u</span> <span class="id">msg</span> <span class="id">result</span>:<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">u</span> ; <span class="id">msg</span> ~&gt; <span class="id">result</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span>, <span class="id">m</span> \<span class="kwd">in</span> <span class="id">result</span>.2 -&gt; <span class="id">uid</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof75')">Proof.</span></div>
<div class="proofscript" id="proof75">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> 1 =&gt; /= <span class="id">m</span> /<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> /=;<span class="id">intuition</span>;<span class="id">subst</span> <span class="id">m</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Internal transition on <span class="bracket"><span class="id">uid</span></span> results in message sent by <span class="bracket"><span class="id">uid</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_internal_sender_good">utransition_internal_sender_good</a></span> <span class="id">uid</span> <span class="id">u</span> <span class="id">result</span>:<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">u</span> ~&gt; <span class="id">result</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">m</span>, <span class="id">m</span> \<span class="kwd">in</span> <span class="id">result</span>.2 -&gt; <span class="id">uid</span> = <span class="id"><a href="Algorand.algorand_model.html#msg_sender">msg_sender</a></span> <span class="id">m</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof76')">Proof.</span></div>
<div class="proofscript" id="proof76">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> 1 =&gt; /= <span class="id">m</span> /<span class="id"><a href="Algorand.safety_helpers.html#in_memP">in_memP</a></span> /=;<span class="id">intuition</span>;<span class="id">subst</span> <span class="id">m</span>.<br/>
Qed.</div>
<br/>
<h2> Definitions of user honesty </h2>
<br/>
<div class="doc">User is honest at step <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span>. </div>
<span class="kwd">Definition</span> <span class="id"><a name="honest_at_step">honest_at_step</a></span> (<span class="id">r</span> <span class="id">p</span> <span class="id">s</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) <span class="id">uid</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">path</span> <span class="id">n</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">gstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">gstate</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">ustate</span> =&gt; ~<span class="id">ustate</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/\ (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) = (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">ustate</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">User is honest in round <span class="bracket"><span class="id">r</span></span> and period <span class="bracket"><span class="id">p</span></span>. </div>
<span class="kwd">Definition</span> <span class="id"><a name="honest_in_period">honest_in_period</a></span> (<span class="id">r</span> <span class="id">p</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) <span class="id">uid</span> <span class="id">path</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> @<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span> <span class="id">path</span> <span class="id">n</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">gstate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">gstate</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] <span class="kwd">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">ustate</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~<span class="id">ustate</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) /\ <span class="id">ustate</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">r</span> /\ <span class="id">ustate</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">p</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">User is honest at all points <span class="bracket">&lt;= <span class="id">step</span></span> in the path. </div>
<span class="kwd">Definition</span> <span class="id"><a name="honest_during_step">honest_during_step</a></span> (<span class="id">step</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> * <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> * <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) <span class="id">uid</span> (<span class="id">path</span> : <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#seq">seq</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all">all</a></span> (<span class="id">upred</span>' <span class="id">uid</span> (<span class="kwd">fun</span> <span class="id">u</span> =&gt; <span class="id"><a href="Algorand.algorand_model.html#step_leb">step_leb</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) <span class="id">step</span> ==&gt; ~~<span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>))) <span class="id">path</span>.<br/>
<br/>
<h2> Preserving honesty through transitions </h2>
<br/>
<div class="doc">Internal user transitions preserves <span class="bracket"><span class="id">corrupt</span></span> flag. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_internal_preserves_corrupt">utransition_internal_preserves_corrupt</a></span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">sent</span>:<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">pre</span> ~&gt; (<span class="id">post</span>,<span class="id">sent</span>) -&gt; <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof77')">Proof.</span></div>
<div class="proofscript" id="proof77">
&nbsp;&nbsp;<span class="id">set</span> <span class="id">result</span>:=(<span class="id">post</span>,<span class="id">sent</span>). <span class="id">change</span> <span class="id">post</span> <span class="kwd">with</span> (<span class="id">result</span>.1). <span class="id">clearbody</span> <span class="id">result</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">reflexivity</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Message transitions preserve <span class="bracket"><span class="id">corrupt</span></span> flag. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utransition_msg_preserves_corrupt">utransition_msg_preserves_corrupt</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">sent</span>:<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">pre</span> ; <span class="id">msg</span> ~&gt; (<span class="id">post</span>,<span class="id">sent</span>) -&gt; <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof78')">Proof.</span></div>
<div class="proofscript" id="proof78">
&nbsp;&nbsp;<span class="id">set</span> <span class="id">result</span>:=(<span class="id">post</span>,<span class="id">sent</span>). <span class="id">change</span> <span class="id">post</span> <span class="kwd">with</span> (<span class="id">result</span>.1). <span class="id">clearbody</span> <span class="id">result</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> 1;<span class="id">try</span> <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;+ <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">msg</span>, <span class="id">msg_ev</span>, <span class="id">msg_type</span>.<br/>
Qed.</div>
<br/>
<div class="doc">The sender of a message is honest in the pre-state. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="user_sent_honest_pre">user_sent_honest_pre</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H_send</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>]).(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof79')">Proof.</span></div>
<div class="proofscript" id="proof79">
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send</span>) =&gt; <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id">H_send</span> =&gt; [<span class="id">ms</span> [<span class="id">H_in_ms</span> [[<span class="id">d</span> [<span class="id">inc</span> <span class="id">H_ustep</span>]]|<span class="id">H_ustep</span>]]].<br/>
&nbsp;&nbsp;- <span class="id">case</span>: <span class="id">H_ustep</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>. <span class="id">contradict</span> <span class="id">H_corrupt</span>; <span class="id">move</span>: <span class="id">H_corrupt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#bool_irrelevance">bool_irrelevance</a></span> <span class="id">H_in</span> <span class="id">H_uid</span>).<br/>
&nbsp;&nbsp;- <span class="id">case</span>: <span class="id">H_ustep</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>;<span class="id">contradict</span> <span class="id">H_corrupt</span>;<span class="id">move</span>: <span class="id">H_corrupt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#bool_irrelevance">bool_irrelevance</a></span> <span class="id">H_in</span> <span class="id">H_uid</span>).<br/>
Qed.</div>
<br/>
<div class="doc">The sender of message is honest in the post-state. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="user_sent_honest_post">user_sent_honest_post</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H_send</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> <span class="id">msg</span> <span class="id">g1</span> <span class="id">g2</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>]).(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#false">false</a></span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof80')">Proof.</span></div>
<div class="proofscript" id="proof80">
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_in</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>.<br/>
&nbsp;&nbsp;<span class="id">clearbody</span> <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span>: <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g2</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbTE">negbTE</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H_send</span> =&gt; [<span class="id">ms</span> [<span class="id">H_in_ms</span> [[<span class="id">d</span> [<span class="id">inc</span> <span class="id">H_ustep</span>]]|<span class="id">H_ustep</span>]]]; <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H_ustep</span>.<br/>
&nbsp;&nbsp;- <span class="id">case</span>: <span class="id">H_ustep</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_ustep</span> [<span class="id">H_corrupt</span> [<span class="id">key_mailbox</span> [<span class="id">H_mail</span> <span class="id">H_g2</span>]]]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">g2</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span>, <span class="id"><a href="Algorand.algorand_model.html#delivery_result">delivery_result</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_ustep</span> <span class="id">H_corrupt</span>. <span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#utransition_msg_preserves_corrupt">utransition_msg_preserves_corrupt</a></span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hcorrupt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">case</span>: <span class="id">H_ustep</span> =&gt; [<span class="id">H_uid</span> [<span class="id">ustate_post</span> [<span class="id">H_corrupt</span> [<span class="id">H_ustep</span> <span class="id">H_g2</span>]]]].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">g2</span>; <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span>, <span class="id"><a href="Algorand.algorand_model.html#step_result">step_result</a></span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eq_refl">eq_refl</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_ustep</span> <span class="id">H_corrupt</span>. <span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#utransition_internal_preserves_corrupt">utransition_internal_preserves_corrupt</a></span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hcorrupt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">The sender of a message is honest in the period of the message. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="user_honest_in_from_send">user_honest_in_from_send</a></span> <span class="id">ix</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">msg</span><br/>
&nbsp;&nbsp;&nbsp;(<span class="id">H_vote</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">msg</span>):<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">let</span>: (<span class="id">r</span>,<span class="id">p</span>,<span class="id">_</span>) := <span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof81')">Proof.</span></div>
<div class="proofscript" id="proof81">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_vote</span> <span class="kwd">as</span> (<span class="id">g1_v</span> &amp; <span class="id">g2_v</span> &amp; <span class="id">H_vote_step</span> &amp; <span class="id">H_vote_send</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">H_in</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1_v</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_vote_send</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_u</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_in</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> <span class="id">u</span>: <span class="id"><a href="Algorand.algorand_model.html#UState">UState</a></span> := (<span class="id">g1_v</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[` <span class="id">H_in</span>]) <span class="kwd">in</span> <span class="id">H_u</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span>:= <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_vote_send</span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg</span>) =&gt; [[<span class="id">r</span> <span class="id">p</span>] <span class="id">s</span>] [<span class="id">H_r</span> <span class="id">H_p</span> <span class="id">_</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="kwd">exists</span> <span class="id">ix</span>;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_vote_step</span>) <span class="id">H_u</span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_honest_pre">user_sent_honest_pre</a></span> <span class="id">H_vote_send</span>).<br/>
Qed.</div>
<br/>
<h2> Propagating honesty </h2>
<br/>
<div class="doc">Propagate <span class="bracket"><span class="id">honest_during_step</span></span> backwards. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_during_le">honest_during_le</a></span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">uid</span> <span class="id">trace</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> <span class="id">s1</span> <span class="id">s2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> <span class="id">s2</span> <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> <span class="id">s1</span> <span class="id">uid</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof82')">Proof.</span></div>
<div class="proofscript" id="proof82">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_le</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#sub_all">sub_all</a></span> =&gt; <span class="id">g</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">upred</span>'. <span class="id">case</span>: (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>]) =&gt; [<span class="id">u</span>|];[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implyP">implyP</a></span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implyP">implyP</a></span> =&gt; /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> /<span class="id">H</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span> /(<span class="id"><a href="Algorand.safety_helpers.html#step_le_trans">step_le_trans</a></span> <span class="id">H1</span> <span class="id">H_le</span>).<br/>
Qed.</div>
<br/>
<div class="doc">Propagate <span class="bracket"><span class="id">user_honest</span></span> backwards through transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_backwards_gstep">honest_backwards_gstep</a></span> : <span class="kwd">forall</span> (<span class="id">g1</span> <span class="id">g2</span> : <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>),<br/>
&nbsp;<span class="id"><a href="Algorand.algorand_model.html#GTransition">GTransition</a></span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;<span class="kwd">forall</span> <span class="id">uid</span>, <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g2</span> -&gt; <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof83')">Proof.</span></div>
<div class="proofscript" id="proof83">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">g2</span> <span class="id">Hstep</span> <span class="id">uid</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Hstep</span>;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span>;<span class="id">destruct</span> <span class="id">pre</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#tick_update">tick_update</a></span>,<span class="id"><a href="Algorand.algorand_model.html#tick_users">tick_users</a></span>; <span class="id">simpl</span> <span class="id">algorand_model.users</span> <span class="kwd">in</span> * |- *; <span class="id">try</span> <span class="id">done</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;step_tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> <span class="id">users</span> <span class="id">uid</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> //;<span class="id">destruct</span> (<span class="id">users</span>.[<span class="id">kf</span>]), <span class="id">corrupt</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span> // -[<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">_</span>]/(<span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">_</span>) -<span class="id"><a href="Algorand.fmap_ext.html#updf_domf">updf_domf</a></span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;step_deliver_msg&nbsp;UTransitionMsg&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (@<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#Finite.choiceType">Finite.choiceType</a></span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) <span class="id">uid</span> <span class="id">uid0</span>);[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">uid0</span>;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key_ustate</span>).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">H0</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;step_internal&nbsp;UTransitionInternal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (@<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#Finite.choiceType">Finite.choiceType</a></span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) <span class="id">uid</span> <span class="id">uid0</span>);[|<span class="id">done</span>].<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">uid0</span>;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">ustate_key</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#contraNN">contraNN</a></span> =&gt; <span class="id">H1</span>. <span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#utransition_internal_preserves_corrupt">utransition_internal_preserves_corrupt</a></span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;step_corrupt_user&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> (@<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#Finite.choiceType">Finite.choiceType</a></span> <span class="id"><a href="Algorand.algorand_model.html#UserId">UserId</a></span>) <span class="id">uid</span> <span class="id">uid0</span>).<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">user_honest</span></span> at the last state implies <span class="bracket"><span class="id">user_honest</span></span> in all states in the path. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_last_all">honest_last_all</a></span> <span class="id">uid</span> <span class="id">g0</span> <span class="id">p</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">p</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last">last</a></span> <span class="id">g0</span> <span class="id">p</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all">all</a></span> (<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span>) (<span class="id">g0</span> :: <span class="id">p</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof84')">Proof.</span></div>
<div class="proofscript" id="proof84">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">p</span>. <span class="id">inversion</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path</span>]; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">elim</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_ind">last_ind</a></span>: <span class="id">p</span> <span class="id">H_path</span> =&gt; [|<span class="id">s</span> <span class="id">x</span> <span class="id">IH</span>] /=; <span class="id">first</span> <span class="kwd">by</span> <span class="id">move</span>=&gt; <span class="id">_</span> -&gt;.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.path.html#rcons_path">rcons_path</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_rcons">last_rcons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all_rcons">all_rcons</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; [<span class="id">Hpath</span> <span class="id">Hstep</span>] <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IH</span> <span class="id">Hpath</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Hx</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IH</span>. <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#honest_backwards_gstep">honest_backwards_gstep</a></span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>: <span class="id">Hx</span>.<br/>
Qed.</div>
<span class="kwd">Arguments</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_last_all">honest_last_all</a></span> <span class="id">uid</span> [<span class="id">g0</span>] [<span class="id">p</span>].<br/>
<br/>
<div class="doc">Honesty is monotone. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_monotone">honest_monotone</a></span> <span class="id">uid</span> <span class="id">g1</span> <span class="id">g2</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof85')">Proof.</span></div>
<div class="proofscript" id="proof85">
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">p</span> <span class="id">H_path</span> <span class="id">H_last</span>] <span class="id">H_honest2</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">g2</span>.<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_last_all">honest_last_all</a></span> <span class="id">uid</span> <span class="id">H_path</span> <span class="id">H_honest2</span>).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>: <span class="id">H</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [].<br/>
Qed.</div>
<br/>
<h2> Lemmas on manipulation of traces </h2>
<br/>
<div class="doc">A non-empty prefix of a trace is a trace. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="is_trace_prefix">is_trace_prefix</a></span> : <span class="kwd">forall</span> <span class="id">trace</span> <span class="id">g0</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span> -&gt; <span class="id">n</span> &gt; 0 -&gt; <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">n</span> <span class="id">trace</span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof86')">Proof.</span></div>
<div class="proofscript" id="proof86">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">trace</span>;[<span class="id">done</span>|].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; [<span class="id">H_g0</span> <span class="id">H_path</span>] <span class="id">_</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">done</span>|<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#path_prefix">path_prefix</a></span>].<br/>
Qed.</div>
<br/>
<div class="doc">Dropping elements from a trace still results in a trace. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="is_trace_drop">is_trace_drop</a></span> <span class="id">g0</span> <span class="id">g0</span>' <span class="id">trace</span> <span class="id">trace</span>' (<span class="id">H_trace</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>) <span class="id">n</span>:<br/>
&nbsp;&nbsp;<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> <span class="id">trace</span> = <span class="id">g0</span>' :: <span class="id">trace</span>' -&gt; <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span>' (<span class="id">g0</span>' :: <span class="id">trace</span>').<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof87')">Proof.</span></div>
<div class="proofscript" id="proof87">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_drop</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>. <span class="id">inversion</span> <span class="id">H_trace</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_trace</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_trace</span>]; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">path_drop</span>' <span class="kwd">with</span> (<span class="id">n</span>:=<span class="id">n</span>) <span class="kwd">in</span> <span class="id">H_trace</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop0">drop0</a></span> <span class="kwd">in</span> <span class="id">H_trace</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop0">drop0</a></span> <span class="kwd">in</span> <span class="id">H_drop</span>; <span class="id">inversion</span> <span class="id">H_drop</span>; <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_drop</span> <span class="kwd">in</span> <span class="id">H_trace</span>.<br/>
Qed.</div>
<br/>
<div class="doc">If some predicate is not true initially and then becomes true for some state <span class="bracket"><span class="id">g_p</span></span>, 
this means there must have been a step from <span class="bracket"><span class="id">g1</span></span> to <span class="bracket"><span class="id">g2</span></span> where it became true. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="path_gsteps_onth">path_gsteps_onth</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix_p</span> <span class="id">g_p</span> (<span class="id">H_g_p</span> : <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix_p</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g_p</span>):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">P</span> : <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#pred">pred</a></span> <span class="id"><a href="Algorand.algorand_model.html#GState">GState</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~~ <span class="id">P</span> <span class="id">g0</span> -&gt; <span class="id">P</span> <span class="id">g_p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span> <span class="id">g1</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">n</span> <span class="id">trace</span> /\ ~~ <span class="id">P</span> <span class="id">g1</span> /\ <span class="id">P</span> <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof88')">Proof.</span></div>
<div class="proofscript" id="proof88">
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>;[<span class="kwd">by</span> <span class="id">contradict</span> <span class="id">H_path</span>|].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_path</span> =&gt; [<span class="id">H_g0</span> <span class="id">H_path</span>];<span class="id">subst</span> <span class="id">g</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>=&gt; <span class="id">P</span> <span class="id">H_NPg0</span> <span class="id">H_Pg</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_path</span>' := <span class="id"><a href="Algorand.safety_helpers.html#path_prefix">path_prefix</a></span> <span class="id">ix_p</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">ix_p</span> <span class="kwd">as</span> [|<span class="id">ix_p</span>];<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> <span class="kwd">by</span> <span class="id">exfalso</span>;<span class="id">move</span>:<span class="id">H_g_p</span> <span class="id">H_NPg0</span>;<span class="id">case</span> =&gt; -&gt;;<span class="id">rewrite</span> <span class="id">H_Pg</span>.<br/>
&nbsp;&nbsp;<span class="id">change</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix_p</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g_p</span>) <span class="kwd">in</span> <span class="id">H_g_p</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="Algorand.safety_helpers.html#path_steps">path_steps</a></span> <span class="id">H_path</span>' <span class="id">H_NPg0</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_size_trace</span> := <span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_g_p</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_last">nth_last</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_take">nth_take</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_takel">size_takel</a></span> // (<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_g_p</span>) <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> <span class="id">H_Pg</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H</span>;<span class="id">clear</span> -<span class="id">H_NPg0</span>;<span class="id">move</span> =&gt; [<span class="id">n</span> <span class="id">H</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">n</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">n</span> (<span class="id">g0</span> :: <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">ix_p</span>.+1 <span class="id">trace</span>)) <span class="kwd">as</span> [|<span class="id">x</span> <span class="id">l</span>] <span class="id">eqn</span>: <span class="id">H_eq</span>;[|<span class="id">destruct</span> <span class="id">l</span>];[<span class="id">done</span>..|].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">g0</span>::<span class="id">trace</span>](<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#cat_take_drop">cat_take_drop</a></span> <span class="id">ix_p</span>.+2).<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="kwd">exists</span> <span class="id">x</span>, <span class="id">g</span>;<span class="id">split</span>;[|<span class="id">assumption</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_cat">drop_cat</a></span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span>;[<span class="id">rewrite</span> <span class="id">H_eq</span>;<span class="id">done</span>|].<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> /=;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span> =&gt; <span class="id">H_oversize</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_oversize">drop_oversize</a></span> // <span class="kwd">in</span> <span class="id">H_eq</span>.<br/>
Qed.</div>
<br/>
<h2> Preservation of users </h2>
<br/>
<div class="doc">Global transitions preserve the set of active users. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="gtrans_preserves_users">gtrans_preserves_users</a></span>: <span class="kwd">forall</span> <span class="id">gs1</span> <span class="id">gs2</span>,<br/>
&nbsp;&nbsp;<span class="id">gs1</span> ~~&gt; <span class="id">gs2</span> -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">gs1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) = <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">gs2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof89')">Proof.</span></div>
<div class="proofscript" id="proof89">
<span class="id">move</span> =&gt; <span class="id">gs1</span> <span class="id">gs2</span>.<br/>
<span class="id">elim</span> =&gt; //.<br/>
- <span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">pre</span> <span class="id">Htick</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="Algorand.safety_helpers.html#tick_users_domf">tick_users_domf</a></span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid</span> <span class="id">msg_key</span> <span class="id">pending</span> <span class="id">Hpending</span> <span class="id">key_ustate</span> <span class="id">ustate_post</span> <span class="id">sent</span> <span class="id">Hcorrupt</span> <span class="id">Huser</span> /=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#mem_fset1U">mem_fset1U</a></span> //.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid</span> <span class="id">ustate_key</span> <span class="id">Hcorrupt</span> <span class="id">ustate_post</span> <span class="id">sent</span> <span class="id">Huser</span> /=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#mem_fset1U">mem_fset1U</a></span> //.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid</span> <span class="id">ustate_key</span> <span class="id">Hcorrupt</span> /=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#mem_fset1U">mem_fset1U</a></span> //.<br/>
Qed.</div>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="gtrans_domf_users">gtrans_domf_users</a></span>: <span class="kwd">forall</span> <span class="id">gs1</span> <span class="id">gs2</span>,<br/>
&nbsp;&nbsp;<span class="id">gs1</span> ~~&gt; <span class="id">gs2</span> -&gt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">gs1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>) `&lt;=` <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> <span class="id">gs2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof90')">Proof.</span></div>
<div class="proofscript" id="proof90">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">gs1</span> <span class="id">gs2</span> <span class="id">H_trans</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#gtrans_preserves_users">gtrans_preserves_users</a></span> <span class="kwd">in</span> <span class="id">H_trans</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_trans</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eqEfsubset">eqEfsubset</a></span> <span class="kwd">in</span> <span class="id">H_trans</span>; <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> <span class="kwd">in</span> <span class="id">H_trans</span>.<br/>
&nbsp;&nbsp;<span class="id">tauto</span>.<br/>
Qed.</div>
<br/>
<h2> Transitions do not decrease step-of-ustate </h2>
<br/>
<div class="doc">A one-step user-level transition never decreases round-period-step. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utr_rps_non_decreasing_msg">utr_rps_non_decreasing_msg</a></span> : <span class="kwd">forall</span> <span class="id">uid</span> <span class="id">m</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">ms</span>,<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">us1</span> ; <span class="id">m</span> ~&gt; (<span class="id">us2</span>, <span class="id">ms</span>) -&gt; <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof91')">Proof.</span></div>
<div class="proofscript" id="proof91">
<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">m</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">ms</span> <span class="id">utrH</span>.<br/>
<span class="id">inversion_clear</span> <span class="id">utrH</span>.<br/>
- <span class="id">rewrite</span> /<span class="id">pre</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="kwd">by</span> <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">rewrite</span> /<span class="id">pre</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="kwd">by</span> <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
- <span class="id">rewrite</span> /<span class="id">pre</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="id">left</span>. <span class="id">split</span> ; <span class="id">first</span> <span class="kwd">by</span> [].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> [].<br/>
- <span class="id">rewrite</span> /<span class="id">pre</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">vH</span> <span class="id">oH</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="id">left</span>. <span class="id">split</span> ; <span class="id">first</span> <span class="kwd">by</span> [].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> [].<br/>
- <span class="id">rewrite</span> /<span class="id">pre</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="kwd">by</span> <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
- <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">left</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certify_ok">certify_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">H0</span>;<span class="id">unfold</span> <span class="id">pre</span>';<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">us1</span>;<span class="id">simpl</span>. <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span>. <span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt; [|[-&gt;] <span class="id">_</span>];[<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnW">ltnW</a></span>|<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqnn">leqnn</a></span>].<br/>
- <span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_ev">msg_ev</a></span> <span class="id">m</span>) <span class="id">eqn</span>:<span class="id">E</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="Algorand.algorand_model.html#msg_type">msg_type</a></span> <span class="id">m</span>) <span class="id">eqn</span>:<span class="id">E</span>'.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">rewrite</span> <span class="id">E</span>'.  <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>. <span class="id">rewrite</span> <span class="id">E</span>. <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="kwd">by</span> <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
Qed.</div>
<br/>
<div class="doc">A one-step user-level transition never decreases round-period-step. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="utr_rps_non_decreasing_internal">utr_rps_non_decreasing_internal</a></span> : <span class="kwd">forall</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">ms</span>,<br/>
&nbsp;&nbsp;<span class="id">uid</span> # <span class="id">us1</span> ~&gt; (<span class="id">us2</span>, <span class="id">ms</span>) -&gt; <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof92')">Proof.</span></div>
<div class="proofscript" id="proof92">
<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">ms</span> <span class="id">utrH</span>.<br/>
<span class="id">inversion_clear</span> <span class="id">utrH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span>  =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
- <span class="id">elim</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> [<span class="id">vbH</span> [<span class="id">svH</span> <span class="id">oH</span>]]].<br/>
&nbsp;&nbsp;<span class="id">elim</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> <span class="id">subst</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> [<span class="id">vbH</span> [<span class="id">svH</span> <span class="id">oH</span>]]].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> <span class="id">subst</span>.<br/>
- <span class="id">move</span>: <span class="id">H0</span> =&gt; <span class="id">v</span>'<span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> [<span class="id">vbH</span> [<span class="id">svH</span> <span class="id">oH</span>]]].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> <span class="id">subst</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">H</span> [<span class="id">vH</span> <span class="id">cH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>].<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn1">addn1</a></span>. <span class="kwd">by</span> <span class="id">subst</span>.<br/>
- <span class="id">case</span>: <span class="id">H</span> =&gt; <span class="id">tH</span> [<span class="id">vH</span> <span class="id">oH</span>].<br/>
&nbsp;&nbsp;<span class="id">case</span>: <span class="id">vH</span> =&gt; <span class="id">rH</span> [<span class="id">pH</span> <span class="id">sH</span>].<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> =&gt; /=.<br/>
&nbsp;&nbsp;<span class="id">do</span> 2! [<span class="id">right</span>]. <span class="id">do</span> 2! [<span class="id">split</span>; <span class="id">auto</span>]. <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">sH</span>.<br/>
Qed.</div>
<br/>
<div class="doc">A one-step global transition never decreases round-period-step of any user. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="gtr_rps_non_decreasing">gtr_rps_non_decreasing</a></span> : <span class="kwd">forall</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span>,<br/>
&nbsp;&nbsp;<span class="id">g1</span> ~~&gt; <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">us1</span> -&gt; <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">us2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof93')">Proof.</span></div>
<div class="proofscript" id="proof93">
<span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<span class="id">elim</span> =&gt; //.<br/>
- <span class="id">move</span> =&gt; <span class="id">increment</span> <span class="id">pre</span> <span class="id">Htick</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hu</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hd</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">pre</span>)); <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hd</span> =&gt; <span class="id">Hd</span>; <span class="id">move</span>: <span class="id">Hu</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="Algorand.safety_helpers.html#tick_users_upd">tick_users_upd</a></span> //.<br/>
&nbsp;&nbsp;<span class="id">case</span> =&gt;&lt;-; <span class="id">move</span>: <span class="id">Hu</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>; <span class="id">case</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span> /= /<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> /=.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#ifP">ifP</a></span> =&gt; //=; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">msg_key</span> [<span class="id">r</span> <span class="id">m</span>] <span class="id">Hpend</span> <span class="id">key_ustate</span> <span class="id">ustate_post</span> <span class="id">sent</span> <span class="id">Hloc</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#utr_rps_non_decreasing_msg">utr_rps_non_decreasing_msg</a></span> =&gt; <span class="id">Hst</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Huid_eq</span>: (<span class="id">uid</span> == <span class="id">uid0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Huid_eq</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> //; <span class="id">case</span> =&gt;&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> -&gt;: (<span class="id">uid0</span> == <span class="id">uid0</span>) <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;&lt;-.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /= <span class="id">Huid_eq</span> <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;-&gt;; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ustate_key</span> <span class="id">Hloc</span> <span class="id">ustate_post</span> <span class="id">sent</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#utr_rps_non_decreasing_internal">utr_rps_non_decreasing_internal</a></span> =&gt; <span class="id">Hst</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Huid_eq</span>: (<span class="id">uid</span> == <span class="id">uid0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Huid_eq</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> //; <span class="id">case</span> =&gt;&lt;-; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> -&gt;: (<span class="id">uid0</span> == <span class="id">uid0</span>) <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;&lt;-.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /= <span class="id">Huid_eq</span> <span class="id">Hus</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;-&gt;; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">Hpre</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /= -/<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> =&gt; <span class="id">Hus1</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hus1</span>; <span class="id">case</span> =&gt;-&gt;; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">Hpre</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /= -/<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> =&gt; <span class="id">Hus1</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">Hus1</span>; <span class="id">case</span> =&gt;-&gt;; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid0</span> <span class="id">ustate_key</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">Hcorrupt</span> <span class="id">Hst</span>; <span class="id">move</span>: <span class="id">Hst</span> <span class="id">Hcorrupt</span>.<br/>
&nbsp;&nbsp;<span class="id">case</span> <span class="id">Huid_eq</span>: (<span class="id">uid</span> == <span class="id">uid0</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Huid_eq</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /=.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> -&gt;: (<span class="id">uid0</span> == <span class="id">uid0</span>) <span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -/(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">pre</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;-&gt; =&gt; <span class="id">Hcorrupt</span>; <span class="id">case</span> =&gt;&lt;-; <span class="id">right</span>; <span class="id">right</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span> /= <span class="id">Huid_eq</span> -/(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">pre</span>).<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span> =&gt;-&gt; =&gt; <span class="id">Hcorrupt</span>; <span class="id">case</span> =&gt;-&gt;; <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">uid0</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ustate_key</span> <span class="id">m</span> <span class="id">Hc</span> <span class="id">Hm</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /= =&gt;-&gt;; <span class="id">case</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">right</span>; <span class="id">right</span>.<br/>
- <span class="id">move</span> =&gt; <span class="id">pre</span> <span class="id">sender</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">sender_key</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">mtype</span> <span class="id">mval</span> <span class="id">Hhave</span> <span class="id">Hcomm</span> <span class="id">Hmatch</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> /= =&gt;-&gt;; <span class="id">case</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">right</span>; <span class="id">right</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Generalization of non-decreasing round-period-step results to paths. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="greachable_rps_non_decreasing">greachable_rps_non_decreasing</a></span> : <span class="kwd">forall</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">us1</span> -&gt; <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">us2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof94')">Proof.</span></div>
<div class="proofscript" id="proof94">
<span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<span class="id">case</span> =&gt; <span class="id">gtrace</span> <span class="id">Hpath</span> <span class="id">Hlast</span>.<br/>
<span class="id">destruct</span> <span class="id">gtrace</span>. <span class="id">inversion</span> <span class="id">Hpath</span>.<br/>
<span class="id">destruct</span> <span class="id">Hpath</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">Hpath</span>]; <span class="id">subst</span> <span class="id">g</span>.<br/>
<span class="id">elim</span>: <span class="id">gtrace</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">Hpath</span> <span class="id">Hlast</span> =&gt; //=.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span> <span class="id">Htr</span> -&gt;-&gt;; <span class="id">case</span> =&gt;-&gt;.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">right</span>; <span class="id">right</span>.<br/>
<span class="id">move</span> =&gt; <span class="id">g</span> <span class="id">gtrace</span> <span class="id">IH</span>.<br/>
<span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">g2</span> <span class="id">uid</span> <span class="id">us1</span> <span class="id">us2</span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> =&gt; [<span class="id">Htrans</span> <span class="id">Hpath</span>] <span class="id">Hlast</span> <span class="id">Hg1</span> <span class="id">Hg2</span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span>: <span class="id">Htrans</span> =&gt; <span class="id">Htrans</span>.<br/>
<span class="id">case</span> <span class="id">Hg</span>: (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g</span>).[? <span class="id">uid</span>] =&gt; [<span class="id">u</span>|].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">IH</span>' := <span class="id">IH</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">_</span> <span class="id">Hpath</span> <span class="id">Hlast</span> <span class="id">Hg</span> <span class="id">Hg2</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">Haft</span> := <span class="id"><a href="Algorand.safety_helpers.html#gtr_rps_non_decreasing">gtr_rps_non_decreasing</a></span> <span class="id">Htrans</span> <span class="id">Hg1</span> <span class="id">Hg</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">Haft</span> <span class="id">IH</span>'.<br/>
&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#ustate_after_transitive">ustate_after_transitive</a></span>.<br/>
<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#gtrans_domf_users">gtrans_domf_users</a></span>: <span class="id">Htrans</span> =&gt; <span class="id">Hdomf</span>.<br/>
<span class="id">case</span> <span class="id">Hd</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#domf">domf</a></span> (<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span> <span class="id">g1</span>)); <span class="id">last</span> <span class="id">first</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span>: <span class="id">Hd</span> =&gt; <span class="id">Hd</span>; <span class="id">move</span>: <span class="id">Hg1</span>; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#not_fnd">not_fnd</a></span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#idP">idP</a></span>: <span class="id">Hd</span> =&gt; <span class="id">Hd</span>.<br/>
<span class="id">move</span>: <span class="id">Hdomf</span>.<br/>
<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubsetP">fsubsetP</a></span> =&gt; <span class="id">Hsub</span>.<br/>
<span class="id">move</span>: <span class="id">Hd</span>; <span class="id">move</span>/<span class="id">Hsub</span> =&gt; <span class="id">Hdom</span>.<br/>
<span class="id">move</span>: <span class="id">Hg</span>.<br/>
<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span>.<br/>
Qed.</div>
<br/>
<h2> Monotonicity and preservation lemmas </h2>
<br/>
<div class="doc">Softvotes are monotone over internal user transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvotes_utransition_internal">softvotes_utransition_internal</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span>, {<span class="id">subset</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) &lt;= <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof95')">Proof.</span></div>
<div class="proofscript" id="proof95">
<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span> <span class="id">step</span> <span class="id">r</span> <span class="id">p</span>.<br/>
<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>;<span class="id">done</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Softvotes are monotone over user message transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvotes_utransition_deliver">softvotes_utransition_deliver</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ; <span class="id">m</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id">subset</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) &lt;= <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof96')">Proof.</span></div>
<div class="proofscript" id="proof96">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span> <span class="id">step</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">all</span>: <span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span>.<br/>
&nbsp;&nbsp;<span class="id">all</span>: <span class="id">repeat</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;<span class="id">all</span>: <span class="id">move</span> =&gt; <span class="id">x</span> <span class="id">H_x</span> //.<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hrp</span>: (<span class="id">_</span> == <span class="id">_</span>) =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hrp</span>; <span class="id">case</span> =&gt;&lt;--&lt;-; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hrp</span>: (<span class="id">_</span> == <span class="id">_</span>) =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hrp</span>; <span class="id">case</span> =&gt;&lt;--&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="id">H_x</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orbT">orbT</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hrp</span>: (<span class="id">_</span> == <span class="id">_</span>) =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hrp</span>; <span class="id">case</span> =&gt;&lt;--&lt;-; <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hrp</span>: (<span class="id">_</span> == <span class="id">_</span>) =&gt; //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hrp</span>; <span class="id">case</span> =&gt;&lt;--&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="id">H_x</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orbT">orbT</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Softvotes are monotone over global transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvotes_gtransition">softvotes_gtransition</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_step</span>:<span class="id">g1</span> ~~&gt; <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span>, {<span class="id">subset</span> <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) &lt;= <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof97')">Proof.</span></div>
<div class="proofscript" id="proof97">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>': <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>] = <span class="id">u1</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>;<span class="id">case</span>:<span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<span class="id">simpl</span> <span class="id">users</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">gtransition_unfold</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>;<span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span>|]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">eassumption</span>|<span class="id">done</span>]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> //;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">eauto</span>|]); <span class="id">try</span> <span class="kwd">by</span> <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">Hv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_in1</span>' /<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H1</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#softvotes_utransition_deliver">softvotes_utransition_deliver</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H0</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#softvotes_utransition_internal">softvotes_utransition_internal</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) /= <span class="id">H_in1</span>' =&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">Hv</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Softvotes are monotone between reachable states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="softvotes_monotone">softvotes_monotone</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_reach</span>:<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span>, {<span class="id">subset</span> <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>) &lt;= <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>) (<span class="id">r</span>, <span class="id">p</span>)}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof98')">Proof.</span></div>
<div class="proofscript" id="proof98">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_reach</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">u2</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_reach</span> <span class="kwd">as</span> [<span class="id">trace</span> <span class="id">H_path</span> <span class="id">H_last</span>].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>. <span class="id">inversion</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path</span>]. <span class="id">subst</span> <span class="id">g</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">g1</span> <span class="id">H_path</span> <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">trace</span>.<br/>
&nbsp;&nbsp;* <span class="id">simpl</span>. <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">_</span> &lt;- <span class="id">u1</span>;<span class="id">rewrite</span> <span class="id">H_u2</span>{<span class="id">H_u2</span>};<span class="id">case</span> =&gt; -&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">Hv</span>.<br/>
&nbsp;&nbsp;* <span class="id">cbn</span> [<span class="id">path</span> <span class="id">last</span>] =&gt; <span class="id">g1</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span> <span class="id">H_step</span> <span class="id">H_path</span>] <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">r</span> <span class="id">p</span> <span class="id">v</span> <span class="id">Hv</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">a</span> <span class="id">H_path</span> <span class="id">H_last</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">umid</span> [<span class="id">H_umid</span> <span class="id">H_sub</span>]] := <span class="id"><a href="Algorand.safety_helpers.html#softvotes_gtransition">softvotes_gtransition</a></span> <span class="id">H_step</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_sub</span> <span class="id">r</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">umid</span> <span class="id">H_umid</span> <span class="id">r</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHtrace</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id">H_sub</span>.<br/>
Qed.</div>
<br/>
<div class="doc">The weight of softvotes is monotone between reachable states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="soft_weight_monotone">soft_weight_monotone</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_reach</span>:<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>, <span class="id"><a href="Algorand.algorand_model.html#soft_weight">soft_weight</a></span> <span class="id">v</span> <span class="id">u1</span> <span class="id">r</span> <span class="id">p</span> &lt;= <span class="id"><a href="Algorand.algorand_model.html#soft_weight">soft_weight</a></span> <span class="id">v</span> <span class="id">u2</span> <span class="id">r</span> <span class="id">p</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof99')">Proof.</span></div>
<div class="proofscript" id="proof99">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">u2</span> <span class="id">H_u2</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_mono</span> := <span class="id"><a href="Algorand.safety_helpers.html#softvotes_monotone">softvotes_monotone</a></span> <span class="id">H_reach</span> <span class="id">H_u1</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsubset_leq_card">fsubset_leq_card</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#softvoters_for">softvoters_for</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>)) (<span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#softvotes">softvotes</a></span>)) <span class="id">H_mono</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> =&gt; <span class="id">s1</span> <span class="id">s2</span> <span class="id">H_mono</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#subset_imfset">subset_imfset</a></span>.<br/>
&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">x</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [<span class="id">H_x_s1</span> <span class="id">H_val</span>].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span>;<span class="id">split</span>;[<span class="id">apply</span>/<span class="id">H_mono</span>|].<br/>
Qed.</div>
<br/>
<div class="doc">Blocks are monotone over internal user transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="blocks_utransition_internal">blocks_utransition_internal</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, {<span class="id">subset</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span> &lt;= <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof100')">Proof.</span></div>
<div class="proofscript" id="proof100">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span> <span class="id">step</span> <span class="id">r</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>;<span class="id">done</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Blocks are monotone over user message transition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="blocks_utransition_deliver">blocks_utransition_deliver</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ; <span class="id">m</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, {<span class="id">subset</span> <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span> &lt;= <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof101')">Proof.</span></div>
<div class="proofscript" id="proof101">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span> <span class="id">step</span> <span class="id">r</span>;<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">repeat</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id">_</span> =&gt; <span class="id">progress</span> <span class="id">simpl</span> <span class="kwd">end</span>;<br/>
&nbsp;&nbsp;<span class="id">try</span> (<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.fintype.html#subxx_hint">subxx_hint</a></span>);<br/>
&nbsp;&nbsp;<span class="id">try</span> (<span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">x</span> <span class="id">H_x</span>).<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> =&gt; <span class="id">b</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hr</span>: (<span class="id">r</span> == <span class="id">r0</span>) =&gt; //; <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hr</span> =&gt;&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span>.<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fsfun_withE">fsfun_withE</a></span> =&gt; <span class="id">b</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">case</span> <span class="id">Hr</span>: (<span class="id">r</span> == <span class="id">r0</span>) =&gt; //; <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span>: <span class="id">Hr</span> =&gt;&lt;-.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#in_cons">in_cons</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#mem_undup">mem_undup</a></span> <span class="id">Hb</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orbT">orbT</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Blocks are monotone over global transition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="blocks_gtransition">blocks_gtransition</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_step</span>:<span class="id">g1</span> ~~&gt; <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, {<span class="id">subset</span> <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span> &lt;= <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof102')">Proof.</span></div>
<div class="proofscript" id="proof102">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>': <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>] = <span class="id">u1</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>;<span class="id">case</span>:<span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<span class="id">simpl</span> <span class="id">users</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">gtransition_unfold</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>;<span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span>|]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">eassumption</span>|<span class="id">done</span>]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> //;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">eauto</span>|]); <span class="id">try</span> <span class="kwd">by</span> <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">Hp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_in1</span>' /<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H1</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#blocks_utransition_deliver">blocks_utransition_deliver</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H0</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id"><a href="Algorand.safety_helpers.html#blocks_utransition_internal">blocks_utransition_internal</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>' =&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">Hp</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Blocks are monotone between reachable states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="blocks_monotone">blocks_monotone</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_reach</span>: <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span>, {<span class="id">subset</span> <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span> &lt;= <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#blocks">blocks</a></span>) <span class="id">r</span>}.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof103')">Proof.</span></div>
<div class="proofscript" id="proof103">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_reach</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">u2</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_reach</span> <span class="kwd">as</span> [<span class="id">trace</span> <span class="id">H_path</span> <span class="id">H_last</span>].<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>. <span class="id">inversion</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path</span>]. <span class="id">subst</span> <span class="id">g</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">g1</span> <span class="id">H_path</span> <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">trace</span>.<br/>
&nbsp;&nbsp;* <span class="id">simpl</span>. <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">_</span> &lt;- <span class="id">u1</span>;<span class="id">rewrite</span> <span class="id">H_u2</span>{<span class="id">H_u2</span>};<span class="id">case</span> =&gt; -&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">Hp</span>.<br/>
&nbsp;&nbsp;* <span class="id">cbn</span> [<span class="id">path</span> <span class="id">last</span>] =&gt; <span class="id">g1</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span> <span class="id">H_step</span> <span class="id">H_path</span>] <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">r</span> <span class="id">p</span> <span class="id">Hp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">a</span> <span class="id">H_path</span> <span class="id">H_last</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">umid</span> [<span class="id">H_umid</span> <span class="id">H_sub</span>]] := <span class="id"><a href="Algorand.safety_helpers.html#blocks_gtransition">blocks_gtransition</a></span> <span class="id">H_step</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_sub</span> <span class="id">r</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">umid</span> <span class="id">H_umid</span> <span class="id">r</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHtrace</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span>: <span class="id">H_sub</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Starting values are preserved over internal user transition. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_utransition_internal">stv_utransition_internal</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>].<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof104')">Proof.</span></div>
<div class="proofscript" id="proof104">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">msgs</span> <span class="id">step</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>;<span class="id">done</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Starting values are preserved by message user transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_utransition_deliver">stv_utransition_deliver</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span>, <span class="id">uid</span> # <span class="id">pre</span> ; <span class="id">m</span> ~&gt; (<span class="id">post</span>, <span class="id">msgs</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">pre</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id">post</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>].<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof105')">Proof.</span></div>
<div class="proofscript" id="proof105">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">uid</span> <span class="id">pre</span> <span class="id">post</span> <span class="id">m</span> <span class="id">msgs</span> <span class="id">step</span> <span class="id">H_round</span> <span class="id">H_period</span>.<br/>
&nbsp;&nbsp;<span class="id">remember</span> (<span class="id">post</span>,<span class="id">msgs</span>) <span class="kwd">as</span> <span class="id">result</span> <span class="id">eqn</span>:<span class="id">H_result</span>;<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">step</span>;<span class="id">case</span>:<span class="id">H_result</span> =&gt; [? ?];<span class="id">subst</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> <span class="kwd">by</span> (<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">utransition_unfold</span>;<span class="id">done</span>).<br/>
&nbsp;&nbsp;* {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>;<span class="id">move</span>: <span class="id">H_period</span>;<span class="id">clear</span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">period</span> <span class="kwd">in</span> <span class="id">period</span> = <span class="id">_</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span>. <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addnI">addnI</a></span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exfalso</span>;<span class="id">move</span>: <span class="id">H_period</span>;<span class="id">clear</span>;<span class="id">destruct</span> <span class="id">pre</span>;<span class="id">simpl</span>;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> -[<span class="id">period</span> <span class="kwd">in</span> <span class="id">period</span> = <span class="id">_</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span>. <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addnI">addnI</a></span>. <span class="id">done</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="id">exfalso</span>;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#certify_ok">certify_ok</a></span> <span class="kwd">in</span> <span class="id">H</span>;<span class="id">decompose</span> <span class="id">record</span> <span class="id">H</span>;<span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H0</span>. <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#advancing_rp">advancing_rp</a></span> <span class="id">H_round</span>;<span class="id">clear</span>;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">case</span> =&gt;[|[]];[<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_addr">leq_addr</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|<span class="id">rewrite</span> -[<span class="id">r</span> <span class="kwd">in</span> <span class="id">_</span> = <span class="id">r</span>]<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addn0">addn0</a></span>;<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#addnI">addnI</a></span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;* { <span class="id">clear</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#deliver_nonvote_msg_result">deliver_nonvote_msg_result</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> <span class="id">msg</span>, <span class="id">msg_ev</span>, <span class="id">msg_type</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc">Starting values are preserved by global transitions. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_gtransition">stv_gtransition</a></span> <span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_step</span>:<span class="id">g1</span> ~~&gt; <span class="id">g2</span>) <span class="id">uid</span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u1</span>, <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">u2</span>, <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>)  = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>]).<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof106')">Proof.</span></div>
<div class="proofscript" id="proof106">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_step</span> =&gt; <span class="id">u1</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>: (<span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in1</span>': <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in1</span>] = <span class="id">u1</span> <span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="kwd">in</span> <span class="id">H_u1</span>;<span class="id">case</span>:<span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_step</span>;<span class="id">simpl</span> <span class="id">users</span>;<span class="id">autounfold</span> <span class="kwd">with</span> <span class="id">gtransition_unfold</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fnd_set">fnd_set</a></span>;<span class="id">case</span> <span class="id">H_eq</span>:(<span class="id">uid</span> == <span class="id">uid0</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span> <span class="id">uid0</span>|]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">try</span> (<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">eassumption</span>|<span class="id">done</span>]);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">first</span> <span class="id">rewrite</span> <span class="id"><a href="Algorand.fmap_ext.html#updf_update">updf_update</a></span> //;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eexists</span>;<span class="id">split</span>;[<span class="id">reflexivity</span>|]).<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;tick&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_in1</span>' /<span class="id"><a href="Algorand.algorand_model.html#user_advance_timer">user_advance_timer</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span> [ |- <span class="id">context</span> <span class="id">C</span>[ <span class="kwd">match</span> ?<span class="id">b</span> <span class="kwd">with</span> <span class="id">_</span> =&gt; <span class="id">_</span> <span class="kwd">end</span>]] =&gt; <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">end</span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;deliver&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H1</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'. <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#stv_utransition_deliver">stv_utransition_deliver</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;internal&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:<span class="id">H0</span>. <span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'. <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#stv_utransition_internal">stv_utransition_internal</a></span>.<br/>
&nbsp;&nbsp;* <span class="comment">(*&nbsp;corrupt&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> ?(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#eq_getf">eq_getf</a></span> <span class="id">_</span> <span class="id">H_in1</span>) <span class="id">H_in1</span>'. <span class="id">done</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Starting values are preserved between reachable states. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="stv_forward">stv_forward</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g1</span> <span class="id">g2</span> (<span class="id">H_reach</span> : <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">uid</span> <span class="id">u1</span> <span class="id">u2</span>:<br/>
&nbsp;&nbsp;<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[?<span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">p</span>, <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>] = <span class="id">u2</span>.(<span class="id"><a href="Algorand.algorand_model.html#stv">stv</a></span>).[? <span class="id">p</span>].<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof107')">Proof.</span></div>
<div class="proofscript" id="proof107">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_reach</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_u1</span> <span class="id">H_u2</span> <span class="id">H_r</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_reach</span> <span class="kwd">as</span> [<span class="id">trace</span> <span class="id">H_path</span> <span class="id">H_last</span>].<br/>
<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">trace</span>. <span class="id">inversion</span> <span class="id">H_path</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H_path</span> <span class="kwd">as</span> [<span class="id">H_g0</span> <span class="id">H_path</span>]. <span class="id">subst</span> <span class="id">g</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">g1</span> <span class="id">H_path</span> <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">H_r</span> <span class="id">H_p</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">trace</span>.<br/>
&nbsp;&nbsp;* <span class="id">simpl</span>. <span class="kwd">by</span> <span class="id">move</span> =&gt; <span class="id">g1</span> <span class="id">_</span> &lt;- <span class="id">u1</span>;<span class="id">rewrite</span> <span class="id">H_u2</span>{<span class="id">H_u2</span>};<span class="id">case</span> =&gt; -&gt;.<br/>
&nbsp;&nbsp;* <span class="id">cbn</span> [<span class="id">path</span> <span class="id">last</span>] =&gt; <span class="id">g1</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#andP">andP</a></span> [/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.analysis.boolp.html#asboolP">asboolP</a></span> <span class="id">H_step</span> <span class="id">H_path</span>] <span class="id">H_last</span> <span class="id">u1</span> <span class="id">H_u1</span> <span class="id">H_r</span> <span class="id">H_p</span> <span class="id">p</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">H_reach</span> : <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">a</span> <span class="id">g2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">eapply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#ex_intro2">ex_intro2</a></span> <span class="kwd">with</span> (<span class="id">a</span>::<span class="id">trace</span>); <span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">a</span> <span class="id">H_path</span> <span class="id">H_last</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> [<span class="id">umid</span> [<span class="id">H_umid</span> <span class="id">H_sub</span>]] := <span class="id"><a href="Algorand.safety_helpers.html#stv_gtransition">stv_gtransition</a></span> <span class="id">H_step</span> <span class="id">H_u1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">IHtrace</span> <span class="id">umid</span> <span class="id">H_umid</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_le_u1_umid</span> := <span class="id"><a href="Algorand.safety_helpers.html#gtr_rps_non_decreasing">gtr_rps_non_decreasing</a></span> <span class="id">H_step</span> <span class="id">H_u1</span> <span class="id">H_umid</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_le_umid_u2</span> := <span class="id"><a href="Algorand.safety_helpers.html#greachable_rps_non_decreasing">greachable_rps_non_decreasing</a></span> <span class="id">H_reach</span> <span class="id">H_umid</span> <span class="id">H_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_r</span>': <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>) = <span class="id">umid</span>.(<span class="id"><a href="Algorand.algorand_model.html#round">round</a></span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_r</span> <span class="id">H_p</span> <span class="id">H_le_u1_umid</span> <span class="id">H_le_umid_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span>. <span class="id">destruct</span> <span class="id">u1</span>,<span class="id">umid</span>,<span class="id">u2</span>;<span class="id">simpl</span>;<span class="id">clear</span>;<span class="id">intros</span>;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">intuition</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_p</span>': <span class="id">u1</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>) = <span class="id">umid</span>.(<span class="id"><a href="Algorand.algorand_model.html#period">period</a></span>). {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_r</span> <span class="id">H_p</span> <span class="id">H_le_u1_umid</span> <span class="id">H_le_umid_u2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span>. <span class="id">destruct</span> <span class="id">u1</span>,<span class="id">umid</span>,<span class="id">u2</span>;<span class="id">simpl</span>;<span class="id">clear</span>;<span class="id">intros</span>;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">intuition</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H_sub</span> <span class="id">H_r</span>' <span class="id">H_p</span>').<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H_sub</span>. <span class="id">clear</span> <span class="id">H_sub</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHtrace</span>;<span class="id">congruence</span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas for deducing reachability between global states </h2>
<br/>
<div class="doc">If the index of <span class="bracket"><span class="id">g1</span></span> is less than the index of <span class="bracket"><span class="id">g2</span></span>, and both are in a 
trace, this implies <span class="bracket"><span class="id">g2</span></span> is reachable from <span class="bracket"><span class="id">g1</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="at_greachable">at_greachable</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">states</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">states</span>)<br/>
&nbsp;&nbsp;<span class="id">ix1</span> <span class="id">ix2</span> (<span class="id">H_le</span> : <span class="id">ix1</span> &lt;= <span class="id">ix2</span>)<br/>
&nbsp;&nbsp;<span class="id">g1</span> (<span class="id">H_g1</span> : <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">states</span> <span class="id">ix1</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span>)<br/>
&nbsp;&nbsp;<span class="id">g2</span> (<span class="id">H_g2</span> : <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">states</span> <span class="id">ix2</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g2</span>) :<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g1</span> <span class="id">g2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof108')">Proof.</span></div>
<div class="proofscript" id="proof108">
&nbsp;&nbsp;<span class="id">clear</span> -<span class="id">H_path</span> <span class="id">H_le</span> <span class="id">H_g1</span> <span class="id">H_g2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">ix2</span> &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">states</span>) <span class="kwd">by</span><br/>
&nbsp;&nbsp;(<span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subn_gt0">subn_gt0</a></span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_drop">size_drop</a></span>;<br/>
&nbsp;&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_g2</span>;<span class="id">clear</span>;<span class="id">unfold</span> <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span>;<br/>
&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">destruct</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">ix2</span> <span class="id">states</span>)).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id">g1</span> :: (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop">drop</a></span> <span class="id">ix1</span>.+1 (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#take">take</a></span> <span class="id">ix2</span>.+1 <span class="id">states</span>))).<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#is_trace_prefix">is_trace_prefix</a></span> <span class="kwd">with</span> (<span class="id">n</span>:=<span class="id">ix2</span>.+1) <span class="kwd">in</span> <span class="id">H_path</span>; <span class="id">try</span> (<span class="kwd">by</span> <span class="id">intuition</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#is_trace_drop">is_trace_drop</a></span> <span class="kwd">with</span> (<span class="id">g0</span>':=<span class="id">g1</span>) (<span class="id">n</span>:=<span class="id">ix1</span>) <span class="kwd">in</span> <span class="id">H_path</span>; <span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> {1}(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#drop_nth">drop_nth</a></span> <span class="id">g2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_take">nth_take</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_g1</span>) //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_take">size_take</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">ix2</span>.+1 &lt; <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size">size</a></span> <span class="id">states</span>); <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#last_nth">last_nth</a></span> <span class="id">g1</span>) <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_drop">size_drop</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#size_takel">size_takel</a></span> //.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>:(<span class="id">H_le</span>). <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leq_eqVlt">leq_eqVlt</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#orP">orP</a></span> =&gt; [<span class="id">H_eq</span> | <span class="id">H_lt</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.eqtype.html#eqP">eqP</a></span> <span class="kwd">in</span> <span class="id">H_eq</span>;<span class="id">subst</span>;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subnn">subnn</a></span>;<span class="id">simpl</span>;<span class="id">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subSn">subSn</a></span> //= <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_drop">nth_drop</a></span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#subnKC">subnKC</a></span> // <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#nth_take">nth_take</a></span> ?<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnS">ltnS</a></span> // (<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_g2</span>).<br/>
&nbsp;&nbsp;}<br/>
Qed.</div>
<br/>
<div class="doc"><span class="bracket"><span class="id">step_in_path_at</span></span> from <span class="bracket"><span class="id">pre</span></span> to <span class="bracket"><span class="id">post</span></span> and <span class="bracket"><span class="id">pre2</span></span> to <span class="bracket"><span class="id">post2</span></span> 
implies <span class="bracket"><span class="id">pre2</span></span> reachable from <span class="bracket"><span class="id">post</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="steps_greachable">steps_greachable</a></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g0</span> <span class="id">path</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">path</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix</span> <span class="id">ix2</span> (<span class="id">H_lt</span> : <span class="id">ix</span> &lt; <span class="id">ix2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pre</span> <span class="id">post</span> (<span class="id">H_step</span> : <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">pre</span> <span class="id">post</span> <span class="id">ix</span> <span class="id">path</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pre2</span> <span class="id">post2</span> (<span class="id">H_step2</span> : <span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">pre2</span> <span class="id">post2</span> <span class="id">ix2</span> <span class="id">path</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">post</span> <span class="id">pre2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof109')">Proof.</span></div>
<div class="proofscript" id="proof109">
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="kwd">in</span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="kwd">in</span> <span class="id">H_step2</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span>;<span class="id">eassumption</span>.<br/>
Qed.</div>
<br/>
<h2> Lemmas about order of indices in a trace </h2>
<br/>
<div class="doc">If the step of a user is smaller in <span class="bracket"><span class="id">g1</span></span> than <span class="bracket"><span class="id">g2</span></span>, this
implies that the index of <span class="bracket"><span class="id">g1</span></span> is less than the index of <span class="bracket"><span class="id">g2</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="order_ix_from_steps">order_ix_from_steps</a></span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix1</span> <span class="id">g1</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix1</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix2</span> <span class="id">g2</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix2</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> (<span class="id">key1</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) (<span class="id">key2</span>: <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key1</span>])) (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key2</span>])) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix1</span> &lt; <span class="id">ix2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof110')">Proof.</span></div>
<div class="proofscript" id="proof110">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix1</span> <span class="id">g1</span> <span class="id">H_g1</span> <span class="id">ix2</span> <span class="id">g2</span> <span class="id">H_g2</span> <span class="id">uid</span> <span class="id">key1</span> <span class="id">key2</span> <span class="id">H_step_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnNge">ltnNge</a></span>. <span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_ix_le</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">suff</span>: <span class="id"><a href="Algorand.algorand_model.html#ustate_after">ustate_after</a></span> (<span class="id">g2</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key2</span>]) (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">key1</span>])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#ustate_after_iff_step_le">ustate_after_iff_step_le</a></span> /(<span class="id"><a href="Algorand.safety_helpers.html#step_lt_le_trans">step_lt_le_trans</a></span> <span class="id">H_step_lt</span>);<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_reach</span>: <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">g2</span> <span class="id">g1</span> <span class="kwd">by</span> <span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span>;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety_helpers.html#greachable_rps_non_decreasing">greachable_rps_non_decreasing</a></span> <span class="id">H_reach</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">_</span>) (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">_</span>)).<br/>
Qed.</div>
<br/>
<div class="doc">step of <span class="bracket"><span class="id">msg_step</span></span> for <span class="bracket"><span class="id">msg1</span></span> smaller than <span class="bracket"><span class="id">msg2</span></span> implies index of <span class="bracket"><span class="id">msg1</span></span> less than index of <span class="bracket"><span class="id">msg2</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="order_sends">order_sends</a></span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>) <span class="id">uid</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix1</span> <span class="id">msg1</span> (<span class="id">H_send1</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix1</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">msg1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ix2</span> <span class="id">msg2</span> (<span class="id">H_send2</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix2</span> <span class="id">trace</span> <span class="id">uid</span> <span class="id">msg2</span>):<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg1</span>) (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">ix1</span> &lt;= <span class="id">ix2</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof111')">Proof.</span></div>
<div class="proofscript" id="proof111">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_step_le</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_send1</span> =&gt; [<span class="id">pre1</span> [<span class="id">post1</span> [<span class="id">H_step1</span> <span class="id">H_send1</span>]]].<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_send2</span> =&gt; [<span class="id">pre2</span> [<span class="id">post2</span> [<span class="id">H_step2</span> <span class="id">H_send2</span>]]].<br/>
<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#leqNgt">leqNgt</a></span>. <span class="id">apply</span> /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> =&gt; <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_reach</span>: <span class="id"><a href="Algorand.algorand_model.html#greachable">greachable</a></span> <span class="id">post2</span> <span class="id">pre1</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span> <span class="id">H_path</span> <span class="id">H_lt</span>);<span class="id">eauto</span> <span class="kwd">using</span> <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span>, <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> := <span class="id"><a href="Algorand.safety_helpers.html#greachable_rps_non_decreasing">greachable_rps_non_decreasing</a></span> <span class="id">H_reach</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send1</span>)).<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="Algorand.safety_helpers.html#ustate_after_iff_step_le">ustate_after_iff_step_le</a></span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>:= <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_end">utransition_label_end</a></span> <span class="id">H_send2</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send2</span>)).<br/>
&nbsp;&nbsp;<span class="id">have</span> -&gt; := <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_send1</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_send1</span>)).<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_step_lt</span> <span class="id">H_step_le1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> {<span class="id">H_step_le1</span>}<span class="id">H_step_lt1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_lt_le_trans">step_lt_le_trans</a></span> <span class="id">H_step_lt</span> <span class="id">H_step_le1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span>:= <span class="id"><a href="Algorand.safety_helpers.html#step_le_lt_trans">step_le_lt_trans</a></span> <span class="id">H_step_le</span> <span class="id">H_step_lt1</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>: (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> <span class="id">msg1</span>) =&gt; [[<span class="id">r</span> <span class="id">p</span>] <span class="id">s</span>].<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#step_lt_irrefl">step_lt_irrefl</a></span>.<br/>
Qed.</div>
<br/>
<h2> Additional lemmas about honesty </h2>
<br/>
<div class="doc">Honest at all points less than or equal to step implies honest at <span class="bracket"><span class="id">g1</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="user_honest_from_during">user_honest_from_during</a></span> <span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> (<span class="id">H_in</span> : <span class="id">uid</span> \<span class="kwd">in</span> <span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> (<span class="id">g1</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_in</span>])) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g1</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof112')">Proof.</span></div>
<div class="proofscript" id="proof112">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix</span> <span class="id">g1</span> <span class="id">H_onth</span> <span class="id">uid</span> <span class="id">H_in</span> /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all_nthP">all_nthP</a></span>.<br/>
&nbsp;&nbsp;<span class="id">move</span>/(<span class="id">_</span> <span class="id">g1</span> <span class="id">ix</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_onth</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_onth</span> <span class="id">g1</span>) /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> /<span class="id">upred</span>' (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_in</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implyP">implyP</a></span>;<span class="id">apply</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span> /<span class="id"><a href="Algorand.safety_helpers.html#step_le_refl">step_le_refl</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">Honest at all <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span> less than step of <span class="bracket"><span class="id">u</span></span> implies honest_during <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_during_from_ustate">honest_during_from_ustate</a></span> <span class="id">trace</span> <span class="id">g0</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>):<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">ix</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">uid</span> <span class="id">u</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~~ <span class="id">u</span>.(<span class="id"><a href="Algorand.algorand_model.html#corrupt">corrupt</a></span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_lt">step_lt</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">uid</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof113')">Proof.</span></div>
<div class="proofscript" id="proof113">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">ix</span> <span class="id">g</span> <span class="id">H_g</span> <span class="id">uid</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">H_honest</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">H_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g_honest</span>: <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">g</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#allP">allP</a></span> =&gt; <span class="id">x</span> <span class="id">H_in_x</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">upred</span>'.<br/>
&nbsp;&nbsp;<span class="id">case</span>:<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndP">fndP</a></span> =&gt; // <span class="id">key_x</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implyP">implyP</a></span> =&gt; /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span> /<span class="id"><a href="Algorand.safety_helpers.html#step_le_lt_trans">step_le_lt_trans</a></span> /(<span class="id">_</span> <span class="id">H_lt</span>) <span class="id">H_x_lt</span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span>: <span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">uid</span> <span class="id">x</span> <span class="kwd">by</span> <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key_x</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span>/<span class="id"><a href="Algorand.safety_helpers.html#honest_monotone">honest_monotone</a></span>:<span class="id">H_g_honest</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_x</span> := <span class="id"><a href="Algorand.safety_helpers.html#onth_index">onth_index</a></span> <span class="id">H_in_x</span>.<br/>
&nbsp;&nbsp;<span class="id">refine</span> (<span class="id"><a href="Algorand.safety_helpers.html#at_greachable">at_greachable</a></span> <span class="id">H_path</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.ssrnat.html#ltnW">ltnW</a></span> <span class="id">_</span>) <span class="id">H_x</span> <span class="id">H_g</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_inu</span>: <span class="id">uid</span> \<span class="kwd">in</span> (<span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)) <span class="kwd">by</span> <span class="id">rewrite</span> -<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#fndSome">fndSome</a></span> <span class="id">H_u</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_u_eq</span>: <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>)[`<span class="id">H_inu</span>] = <span class="id">u</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">pose</span> <span class="id">proof</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">H_inu</span>) <span class="kwd">as</span> <span class="id">H_fnd</span>; <span class="id">rewrite</span> <span class="id">H_u</span> <span class="kwd">in</span> <span class="id">H_fnd</span>; <span class="id">inversion</span> <span class="id">H_fnd</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="Algorand.safety_helpers.html#order_ix_from_steps">order_ix_from_steps</a></span> <span class="kwd">with</span> (<span class="id">key1</span>:=<span class="id">key_x</span>) (<span class="id">key2</span>:=<span class="id">H_inu</span>); <span class="id">try</span> <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_u_eq</span>.<br/>
Qed.</div>
<br/>
<div class="doc">Honest_during <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span>, <span class="bracket"><span class="id">u</span></span> is at index of <span class="bracket"><span class="id">n</span></span> in trace,
and step of <span class="bracket"><span class="id">u</span></span> less than or equal to <span class="bracket">(<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span> implies <span class="bracket"><span class="id">user_honest_at</span> <span class="id">n</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_at_from_during">honest_at_from_during</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">uid</span> <span class="id">trace</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g0</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">g</span>, <span class="id"><a href="Algorand.safety_helpers.html#onth">onth</a></span> <span class="id">trace</span> <span class="id">n</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">g</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">u</span>, <span class="id">g</span>.(<span class="id"><a href="Algorand.algorand_model.html#users">users</a></span>).[? <span class="id">uid</span>] = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">u</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id"><a href="Algorand.algorand_model.html#step_of_ustate">step_of_ustate</a></span> <span class="id">u</span>) (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#user_honest_at">user_honest_at</a></span> <span class="id">n</span> <span class="id">trace</span> <span class="id">uid</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof114')">Proof.</span></div>
<div class="proofscript" id="proof114">
&nbsp;&nbsp;<span class="id">clear</span>.<br/>
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">H_honest</span> <span class="id">g0</span> <span class="id">H_path</span> <span class="id">n</span> <span class="id">g</span> <span class="id">H_onth</span> <span class="id">u</span> <span class="id">H_u</span> <span class="id">H_le</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_at_step">onth_at_step</a></span> <span class="id">H_onth</span>).<br/>
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_honest</span> =&gt; /<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.ssreflect.seq.html#all_nthP">all_nthP</a></span> - /(<span class="id">_</span> <span class="id">g</span> <span class="id">n</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_size">onth_size</a></span> <span class="id">H_onth</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="Algorand.safety_helpers.html#onth_nth">onth_nth</a></span> <span class="id">H_onth</span>) /<span class="id">upred</span>' /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> <span class="id">H_u</span> =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#implyP">implyP</a></span>.<br/>
&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">apply</span>;<span class="id">apply</span> /<span class="id"><a href="Algorand.safety_helpers.html#step_leP">step_leP</a></span>.<br/>
Qed.</div>
<br/>
<div class="doc">User honest during step means user sends a message. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_during_from_sent">honest_during_from_sent</a></span><br/>
&nbsp;&nbsp;<span class="id">g0</span> <span class="id">trace</span> (<span class="id">H_path</span>: <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>)<br/>
&nbsp;&nbsp;<span class="id">ix</span> <span class="id">uid</span> <span class="id">mty</span> <span class="id">mval</span> <span class="id">r</span> <span class="id">p</span> (<span class="id">H_send</span>: <span class="id"><a href="Algorand.safety_helpers.html#user_sent_at">user_sent_at</a></span> <span class="id">ix</span> <span class="id">trace</span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id">mty</span> <span class="id">mval</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>)):<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id">mty</span> <span class="id">mval</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>)) <span class="id">uid</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof115')">Proof.</span></div>
<div class="proofscript" id="proof115">
&nbsp;&nbsp;<span class="id">move</span>: <span class="id">H_send</span> =&gt; [<span class="id">g1</span> [<span class="id">g2</span> [<span class="id">H_step</span> <span class="id">H_send</span>]]].<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_honest</span> := <span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negbT">negbT</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_honest_post">user_sent_honest_post</a></span> <span class="id">H_send</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_in</span> := <span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> (<span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_post">user_sent_in_post</a></span> <span class="id">H_send</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id"><a href="Algorand.safety_helpers.html#honest_during_from_ustate">honest_during_from_ustate</a></span> <span class="id">H_path</span> (<span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_post">step_in_path_onth_post</a></span> <span class="id">H_step</span>) <span class="id">H_in</span> <span class="id">H_honest</span>).<br/>
&nbsp;&nbsp;<span class="id">exact</span> (<span class="id"><a href="Algorand.safety_helpers.html#utransition_label_end">utransition_label_end</a></span> <span class="id">H_send</span> <span class="id">H_in</span>).<br/>
Qed.</div>
<br/>
<div class="doc">User sends message at <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span> and <span class="bracket"><span class="id">msg_step</span> &lt;= (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>)</span> means user is honest at <span class="bracket"><span class="id">r</span>,<span class="id">p</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id"><a name="honest_in_from_during_and_send">honest_in_from_during_and_send</a></span>: <span class="kwd">forall</span> <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">uid</span> <span class="id">trace</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_during_step">honest_during_step</a></span> (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) <span class="id">uid</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">g0</span> (<span class="id">H_path</span> : <span class="id"><a href="Algorand.algorand_model.html#is_trace">is_trace</a></span> <span class="id">g0</span> <span class="id">trace</span>),<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">ix</span> <span class="id">g1</span> <span class="id">g2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_in_path_at">step_in_path_at</a></span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">ix</span> <span class="id">trace</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">mt</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#user_sent">user_sent</a></span> <span class="id">uid</span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id">mt</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>) <span class="id">g1</span> <span class="id">g2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="Algorand.algorand_model.html#step_le">step_le</a></span> (<span class="id"><a href="Algorand.algorand_model.html#msg_step">msg_step</a></span> (<span class="id"><a href="Algorand.algorand_model.html#mkMsg">mkMsg</a></span> <span class="id">mt</span> <span class="id">v</span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span>)) (<span class="id">r</span>,<span class="id">p</span>,<span class="id">s</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="Algorand.safety_helpers.html#honest_in_period">honest_in_period</a></span> <span class="id">r</span> <span class="id">p</span> <span class="id">uid</span> <span class="id">trace</span>.<br/>
<div><span class="toggleproof" onclick="toggleDisplay('proof116')">Proof.</span></div>
<div class="proofscript" id="proof116">
&nbsp;&nbsp;<span class="id">move</span> =&gt; <span class="id">r</span> <span class="id">p</span> <span class="id">s</span> <span class="id">uid</span> <span class="id">trace</span> <span class="id">H_honest</span> <span class="id">g0</span> <span class="id">H_path</span> <span class="id">ix</span> <span class="id">g1</span> <span class="id">g2</span> <span class="id">H_step</span> <span class="id">mt</span> <span class="id">v</span> <span class="id">H_sent</span> <span class="id">H_msg_step</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_g1</span> := <span class="id"><a href="Algorand.safety_helpers.html#step_in_path_onth_pre">step_in_path_onth_pre</a></span> <span class="id">H_step</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">ix</span>. <span class="id">rewrite</span> <span class="id">H_g1</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">key1</span> := <span class="id"><a href="Algorand.safety_helpers.html#user_sent_in_pre">user_sent_in_pre</a></span> <span class="id">H_sent</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span> <span class="id">H_step1</span> := <span class="id"><a href="Algorand.safety_helpers.html#utransition_label_start">utransition_label_start</a></span> <span class="id">H_sent</span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>).<br/>
&nbsp;&nbsp;<span class="id">lapply</span> (<span class="id"><a href="Algorand.safety_helpers.html#user_honest_from_during">user_honest_from_during</a></span> <span class="id">H_path</span> <span class="id">H_g1</span> (<span class="id">H_in</span>:=<span class="id">key1</span>)).<br/>
&nbsp;&nbsp;- <span class="id">rewrite</span> /<span class="id"><a href="Algorand.algorand_model.html#user_honest">user_honest</a></span> (<span class="id"><a href="https://math-comp.github.io/htmldoc/mathcomp.finmap.finmap.html#in_fnd">in_fnd</a></span> <span class="id">key1</span>) =&gt; /<span class="id"><a href="https://coq.inria.fr/library/Coq.ssr.ssrbool.html#negP">negP</a></span> <span class="id">H_honest_g1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>;[<span class="id">assumption</span>|].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">injection</span> <span class="id">H_step1</span>.<br/>
&nbsp;&nbsp;- <span class="id">revert</span> <span class="id">H_honest</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="Algorand.safety_helpers.html#honest_during_le">honest_during_le</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">by</span> <span class="id">rewrite</span> <span class="id">H_step1</span>.<br/>
Qed.</div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
